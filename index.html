<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#050508">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="Pleiades OS - Personal command center for task management, meetings, and productivity">
  <meta name="application-name" content="Pleiades OS">
  
  <!-- PWA: Resource Hints for Performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  
  <!-- PWA: Manifest and Icons -->
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon-152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icon-180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/icon-167.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icon-16.png">
  <link rel="mask-icon" href="/icon-mask.svg" color="#8b5cf6">
  
  <title>Pleiades OS ‚ú¶ TJ</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #050508;
      --bg-card: rgba(255,255,255,0.03);
      --border-subtle: rgba(255,255,255,0.06);
      --accent: #8b5cf6;
      --accent-hover: #7c3aed;
      --text-primary: #fff;
      --text-secondary: rgba(255,255,255,0.7);
      --text-muted: rgba(255,255,255,0.7);
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --focus-ring: 0 0 0 3px rgba(139,92,246,0.6);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    .skip-link{position:absolute;top:-40px;left:0;background:var(--accent);color:#fff;padding:8px 16px;z-index:10000;transition:top .3s;text-decoration:none;font-weight:500;border-radius:0 0 4px 0}
    .skip-link:focus{top:0;outline:none;box-shadow:0 0 0 3px rgba(139,92,246,0.5)}
    body{font-family:'Inter',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;line-height:1.6}
    *:focus-visible{outline:none;box-shadow:var(--focus-ring)}
    body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 20%,rgba(139,92,246,.08) 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(236,72,153,.05) 0%,transparent 50%),radial-gradient(ellipse at 50% 50%,rgba(99,102,241,.03) 0%,transparent 70%);pointer-events:none;z-index:-1}
    .stars{position:fixed;inset:0;pointer-events:none;z-index:-2;background-image:radial-gradient(2px 2px at 20px 30px,rgba(255,255,255,.15),transparent),radial-gradient(2px 2px at 40px 70px,rgba(255,255,255,.1),transparent),radial-gradient(1px 1px at 90px 40px,rgba(255,255,255,.12),transparent),radial-gradient(2px 2px at 130px 80px,rgba(255,255,255,.08),transparent),radial-gradient(1px 1px at 160px 20px,rgba(255,255,255,.1),transparent),radial-gradient(2px 2px at 200px 50px,rgba(255,255,255,.06),transparent),radial-gradient(1px 1px at 250px 90px,rgba(255,255,255,.08),transparent),radial-gradient(2px 2px at 300px 30px,rgba(255,255,255,.1),transparent),radial-gradient(1px 1px at 350px 70px,rgba(255,255,255,.05),transparent),radial-gradient(2px 2px at 400px 60px,rgba(255,255,255,.08),transparent),radial-gradient(1px 1px at 500px 20px,rgba(255,255,255,.1),transparent),radial-gradient(2px 2px at 600px 40px,rgba(255,255,255,.06),transparent),radial-gradient(1px 1px at 700px 90px,rgba(255,255,255,.05),transparent),radial-gradient(2px 2px at 800px 55px,rgba(255,255,255,.06),transparent),radial-gradient(1px 1px at 900px 35px,rgba(255,255,255,.08),transparent);background-size:1000px 150px;animation:twinkle 8s ease-in-out infinite}
    @keyframes twinkle{0%,100%{opacity:.8}50%{opacity:.4}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.1)}}
    @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}
    @keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}

    /* HEADER */
    .header{position:sticky;top:0;z-index:1000;background:rgba(5,5,8,.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border-subtle);padding:1rem 2rem}
    .header-content{max-width:1600px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:1rem}
    .logo{display:flex;align-items:center;gap:.75rem;font-weight:600;font-size:1.15rem;flex-shrink:0}
    .logo-icon{width:34px;height:34px;background:linear-gradient(135deg,var(--accent),#ec4899);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.9rem}
    .nav-tabs{display:flex;gap:.25rem;background:rgba(255,255,255,.03);padding:.3rem;border-radius:12px;border:1px solid var(--border-subtle);overflow-x:auto;flex-shrink:1}
    .nav-tab{padding:.5rem 1rem;border:none;background:transparent;color:var(--text-muted);font-family:inherit;font-size:.85rem;font-weight:500;border-radius:8px;cursor:pointer;transition:all .3s;white-space:nowrap}
    .nav-tab:hover{color:var(--text-secondary);background:rgba(255,255,255,.05)}
    .nav-tab.active{color:var(--text-primary);background:rgba(139,92,246,.15);box-shadow:0 0 20px rgba(139,92,246,.2)}
    .header-right{display:flex;align-items:center;gap:.75rem;flex-shrink:0}
    .search-wrap{position:relative}
    .search-input{width:180px;padding:.5rem 1rem .5rem 2rem;background:rgba(255,255,255,.03);border:1px solid var(--border-subtle);border-radius:10px;color:var(--text-primary);font-family:inherit;font-size:.85rem;transition:all .3s}
    .search-input:focus{outline:none;border-color:var(--accent);width:260px;background:rgba(255,255,255,.06)}
    .search-icon{position:absolute;left:.625rem;top:50%;transform:translateY(-50%);font-size:.75rem;color:var(--text-muted);pointer-events:none}
    .search-results{position:absolute;top:calc(100% + .5rem);right:0;width:360px;max-height:400px;overflow-y:auto;background:rgba(10,10,15,.95);backdrop-filter:blur(20px);border:1px solid var(--border-subtle);border-radius:12px;display:none;z-index:2000;box-shadow:0 20px 60px rgba(0,0,0,.5)}
    .search-results.open{display:block}
    .search-result-item{padding:.75rem 1rem;border-bottom:1px solid var(--border-subtle);cursor:pointer;transition:background .2s}
    .search-result-item:hover{background:rgba(139,92,246,.1)}
    .search-result-item:last-child{border-bottom:none}
    .search-result-type{font-size:.7rem;text-transform:uppercase;letter-spacing:.05em;color:var(--accent);margin-bottom:.25rem}
    .search-result-title{font-size:.9rem;font-weight:500}
    .search-result-desc{font-size:.8rem;color:var(--text-muted);margin-top:.125rem}
    .search-empty{padding:1.5rem;text-align:center;color:var(--text-muted);font-size:.9rem}
    .status-indicator{display:flex;align-items:center;gap:.5rem;padding:.4rem .75rem;border-radius:10px;font-size:.8rem;font-weight:500;transition:all .3s}
    .status-indicator.online{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);color:var(--success)}
    .status-indicator.offline{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.15);color:var(--text-muted)}
    .status-dot{width:8px;height:8px;border-radius:50%}
    .status-indicator.online .status-dot{background:var(--success);animation:pulse 2s infinite}
    .status-indicator.offline .status-dot{background:var(--text-muted)}

    /* MAIN */
    .main-content{max-width:1600px;margin:0 auto;padding:2rem}
    .tab-content{display:none;animation:fadeInUp .4s ease}
    .tab-content.active{display:block}
    .welcome-bar{margin-bottom:2rem}
    .welcome-title{font-size:1.75rem;font-weight:700;margin-bottom:.375rem}
    .welcome-title span{background:linear-gradient(135deg,var(--accent),#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .welcome-subtitle{color:var(--text-secondary);font-size:.95rem}

    /* CARDS */
    .card{background:var(--bg-card);backdrop-filter:blur(20px);border:1px solid var(--border-subtle);border-radius:16px;padding:1.25rem;transition:all .3s}
    .card:hover{border-color:rgba(255,255,255,.1)}
    .card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
    .card-title{font-size:.85rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;font-weight:500}

    /* METRICS */
    .metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1.25rem;margin-bottom:2rem}
    .metric-card{position:relative;overflow:hidden}
    .metric-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:16px 16px 0 0}
    .metric-card:nth-child(1)::before{background:linear-gradient(90deg,var(--accent),#ec4899)}
    .metric-card:nth-child(2)::before{background:linear-gradient(90deg,var(--info),#6366f1)}
    .metric-card:nth-child(3)::before{background:linear-gradient(90deg,var(--warning),#f97316)}
    .metric-card:nth-child(4)::before{background:linear-gradient(90deg,var(--success),#34d399)}
    .metric-card:hover{transform:translateY(-2px);box-shadow:0 10px 40px rgba(0,0,0,.3)}
    .metric-label{font-size:.8rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:.375rem}
    .metric-value{font-size:2.25rem;font-weight:700}
    .metric-sub{font-size:.8rem;color:var(--text-muted);margin-top:.25rem}

    /* DASHBOARD GRID */
    .dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem}
    .dash-full{grid-column:1/-1}

    /* PRIORITIES */
    .priority-item{display:flex;align-items:center;gap:.75rem;padding:.75rem;border-radius:10px;transition:all .2s;border-bottom:1px solid var(--border-subtle)}
    .priority-item:last-child{border-bottom:none}
    .priority-item:hover{background:rgba(255,255,255,.03)}
    .priority-check{width:20px;height:20px;border:2px solid var(--border-subtle);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
    .priority-check:hover{border-color:var(--accent)}
    .priority-check.done{background:var(--accent);border-color:var(--accent)}
    .priority-check.done::after{content:'‚úì';color:#fff;font-size:.75rem}
    .priority-text{flex:1;font-size:.9rem;transition:all .2s}
    .priority-text.done{text-decoration:line-through;color:var(--text-muted)}
    .priority-delete{opacity:0;background:none;border:none;color:var(--danger);cursor:pointer;font-size:.85rem;padding:.25rem;transition:opacity .2s}
    .priority-item:hover .priority-delete{opacity:1}
    .priority-tag{font-size:.65rem;padding:.15rem .5rem;border-radius:6px;font-weight:600;text-transform:uppercase;flex-shrink:0}
    .priority-tag.urgent{background:rgba(239,68,68,.15);color:var(--danger)}
    .priority-tag.important{background:rgba(245,158,11,.15);color:var(--warning)}
    .priority-tag.normal{background:rgba(59,130,246,.15);color:var(--info)}

    /* ACTIVITY FEED */
    .feed-item{display:flex;gap:.75rem;padding:.625rem 0;border-bottom:1px solid var(--border-subtle);font-size:.85rem}
    .feed-item:last-child{border-bottom:none}
    .feed-icon{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.8rem;flex-shrink:0}
    .feed-icon.task{background:rgba(139,92,246,.15)}
    .feed-icon.note{background:rgba(16,185,129,.15)}
    .feed-icon.meeting{background:rgba(59,130,246,.15)}
    .feed-icon.intel{background:rgba(245,158,11,.15)}
    .feed-icon.system{background:rgba(255,255,255,.05)}
    .feed-text{flex:1;color:var(--text-secondary)}
    .feed-time{color:var(--text-muted);font-size:.75rem;flex-shrink:0}

    /* KANBAN */
    .kanban-board{display:grid;grid-template-columns:repeat(3,1fr);gap:1.25rem}
    .kanban-column{min-height:400px}
    .kanban-column-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;padding-bottom:.75rem;border-bottom:1px solid var(--border-subtle)}
    .kanban-count{background:rgba(255,255,255,.08);padding:.125rem .5rem;border-radius:8px;font-size:.8rem;color:var(--text-muted)}
    .task-card{background:rgba(255,255,255,.03);border:1px solid var(--border-subtle);border-radius:12px;padding:1rem;margin-bottom:.75rem;transition:all .3s;cursor:grab;position:relative}
    .task-card:hover{border-color:rgba(255,255,255,.12);transform:translateY(-1px)}
    .task-card.dragging{opacity:.5;transform:rotate(2deg)}
    .task-card-title{font-weight:600;font-size:.95rem;margin-bottom:.25rem}
    .task-card-desc{color:var(--text-muted);font-size:.8rem;margin-bottom:.5rem}
    .task-card-footer{display:flex;align-items:center;justify-content:space-between}
    .task-card-actions{display:flex;gap:.25rem;opacity:0;transition:opacity .2s}
    .task-card:hover .task-card-actions{opacity:1}
    .task-action-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:.25rem;font-size:.8rem;border-radius:4px;transition:all .2s}
    .task-action-btn:hover{color:var(--text-primary);background:rgba(255,255,255,.05)}
    .task-action-btn.delete:hover{color:var(--danger)}
    .task-priority{font-size:.7rem;font-weight:600;text-transform:uppercase;padding:.2rem .5rem;border-radius:6px;display:inline-block}
    .task-priority.high{background:rgba(239,68,68,.15);color:var(--danger)}
    .task-priority.medium{background:rgba(245,158,11,.15);color:#f59e0b}
    .task-priority.low{background:rgba(16,185,129,.15);color:var(--success)}
    .drop-zone{min-height:60px;border:2px dashed transparent;border-radius:12px;transition:all .3s;padding:.25rem}
    .drop-zone.over{border-color:var(--accent);background:rgba(139,92,246,.05)}

    /* BUTTONS */
    .btn{padding:.625rem 1.25rem;border:none;border-radius:10px;font-family:inherit;font-size:.85rem;font-weight:500;cursor:pointer;transition:all .3s;display:inline-flex;align-items:center;gap:.5rem}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-primary:hover{background:var(--accent-hover);box-shadow:0 0 20px rgba(139,92,246,.4)}
    .btn-ghost{background:rgba(255,255,255,.03);border:1px dashed rgba(255,255,255,.2);color:var(--text-muted);width:100%}
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
    .btn-sm{padding:.4rem .75rem;font-size:.8rem}
    .btn-icon{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:.375rem;border-radius:6px;transition:all .2s;font-size:.9rem}
    .btn-icon:hover{color:var(--text-primary);background:rgba(255,255,255,.05)}

    /* TIMELINE */
    .timeline{position:relative;padding-left:2rem}
    .timeline::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:linear-gradient(180deg,var(--accent),rgba(139,92,246,.2),transparent)}
    .timeline-phase{position:relative;margin-bottom:2rem;padding-left:2rem}
    .timeline-phase::before{content:'';position:absolute;left:-2rem;top:.5rem;width:14px;height:14px;background:var(--accent);border-radius:50%;border:3px solid var(--bg-primary);transition:all .3s}
    .timeline-phase.current::before{box-shadow:0 0 15px var(--accent);background:#ec4899}
    .timeline-phase.completed::before{background:var(--success)}
    .timeline-phase-title{font-size:1.1rem;font-weight:600;margin-bottom:.25rem;display:flex;align-items:center;gap:.5rem}
    .timeline-phase-date{font-size:.8rem;color:var(--accent);margin-bottom:.375rem}
    .timeline-phase-desc{color:var(--text-secondary);font-size:.9rem;margin-bottom:.75rem}
    .timeline-milestones{list-style:none}
    .timeline-milestone{display:flex;align-items:center;gap:.5rem;padding:.375rem 0;font-size:.85rem;color:var(--text-secondary)}
    .milestone-check{width:16px;height:16px;border:2px solid var(--border-subtle);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
    .milestone-check.done{background:var(--success);border-color:var(--success)}
    .milestone-check.done::after{content:'‚úì';color:#fff;font-size:.65rem}

    /* NOTES */
    .notes-editor{position:relative}
    .notes-textarea{width:100%;min-height:500px;background:transparent;border:none;color:var(--text-primary);font-family:'Inter',monospace;font-size:.95rem;line-height:1.8;resize:vertical;outline:none;padding:1.5rem}
    .notes-status{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1.25rem;border-top:1px solid var(--border-subtle);font-size:.8rem;color:var(--text-muted)}

    /* AGENTS */
    .agents-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.25rem;margin-bottom:2.5rem}
    .agent-card{cursor:pointer;position:relative;overflow:hidden}
    .agent-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),#ec4899);opacity:0;transition:opacity .3s}
    .agent-card:hover::before{opacity:1}
    .agent-card:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 10px 40px rgba(139,92,246,.15)}
    .agent-header{display:flex;align-items:flex-start;gap:1rem;margin-bottom:.75rem}
    .agent-avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#ec4899);display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0}
    .agent-name{font-size:1rem;font-weight:600;margin-bottom:.125rem}
    .agent-role{font-size:.8rem;color:var(--text-muted)}
    .agent-status{display:flex;align-items:center;gap:.375rem;font-size:.75rem;font-weight:500;margin-top:.375rem}
    .agent-status-dot{width:7px;height:7px;border-radius:50%}
    .agent-status.online .agent-status-dot{background:var(--success)}
    .agent-status.online{color:var(--success)}
    .agent-status.busy .agent-status-dot{background:var(--warning)}
    .agent-status.busy{color:var(--warning)}
    .agent-status.offline .agent-status-dot{background:var(--text-muted)}
    .agent-status.offline{color:var(--text-muted)}
    .agent-meta{display:flex;gap:1rem;margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--border-subtle);font-size:.8rem;color:var(--text-muted)}
    .agent-model{color:var(--accent);font-weight:500}

    /* MEETINGS */
    .meetings-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem}
    .meeting-card{overflow:hidden;position:relative}
    .meeting-card.today{border-color:rgba(139,92,246,.3);box-shadow:0 0 25px rgba(139,92,246,.1)}
    .meeting-card-header{padding:1.25rem;cursor:pointer}
    .meeting-title{font-size:1.05rem;font-weight:600;margin-bottom:.25rem}
    .meeting-datetime{font-size:.85rem;color:var(--text-secondary);margin-bottom:.5rem;display:flex;align-items:center;gap:.5rem}
    .meeting-countdown{background:rgba(139,92,246,.15);color:var(--accent);padding:.25rem .625rem;border-radius:6px;font-size:.75rem;font-weight:500}
    .meeting-countdown.urgent{background:rgba(245,158,11,.15);color:var(--warning);animation:pulse 2s infinite}
    .meeting-meta{display:flex;gap:1rem;font-size:.8rem;color:var(--text-muted)}
    .meeting-expanded{border-top:1px solid var(--border-subtle);padding:1.25rem;display:none}
    .meeting-expanded.open{display:block}
    .meeting-section{margin-bottom:1.25rem}
    .meeting-section:last-child{margin-bottom:0}
    .meeting-section-title{font-size:.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.5rem}
    .agenda-item{display:flex;align-items:center;gap:.625rem;padding:.375rem 0}
    .meeting-notes-area{width:100%;min-height:80px;padding:.75rem;background:rgba(255,255,255,.03);border:1px solid var(--border-subtle);border-radius:8px;color:var(--text-primary);font-family:inherit;font-size:.9rem;resize:vertical;outline:none}
    .meeting-notes-area:focus{border-color:var(--accent)}

    /* INTEL */
    .intel-container{display:grid;grid-template-columns:250px 1fr;gap:1.5rem}
    .intel-sidebar{height:fit-content;position:sticky;top:100px}
    .intel-filter-btn{width:100%;padding:.5rem .75rem;background:rgba(255,255,255,.03);border:1px solid var(--border-subtle);border-radius:8px;color:var(--text-secondary);font-family:inherit;font-size:.85rem;cursor:pointer;transition:all .2s;margin-bottom:.375rem;text-align:left;display:flex;align-items:center;gap:.5rem}
    .intel-filter-btn:hover{background:rgba(255,255,255,.06)}
    .intel-filter-btn.active{background:rgba(139,92,246,.15);border-color:var(--accent);color:var(--text-primary)}
    .intel-filter-count{margin-left:auto;background:rgba(255,255,255,.1);padding:.1rem .4rem;border-radius:6px;font-size:.7rem}
    .intel-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1rem}
    .intel-card{position:relative}
    .intel-card.hot{border-left:3px solid #ef4444}
    .intel-card.notable{border-left:3px solid #f59e0b}
    .intel-card.reference{border-left:3px solid #3b82f6}
    .intel-card:hover{border-color:var(--accent);transform:translateY(-2px)}
    .intel-importance{font-size:.7rem;font-weight:600;padding:.2rem .5rem;border-radius:6px;display:flex;align-items:center;gap:.25rem}
    .intel-importance.hot{background:rgba(239,68,68,.15);color:#ef4444}
    .intel-importance.notable{background:rgba(245,158,11,.15);color:#f59e0b}
    .intel-importance.reference{background:rgba(59,130,246,.15);color:#3b82f6}

    /* LLM TRACKER */
    .llm-wallet-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.25rem;margin-bottom:2rem}
    .llm-progress-bg{background:rgba(255,255,255,.05);border-radius:9999px;height:8px;overflow:hidden;margin-top:.5rem}
    .llm-progress-fill{height:100%;border-radius:9999px;transition:width .5s}
    .llm-progress-fill.normal{background:linear-gradient(90deg,var(--accent),#ec4899)}
    .llm-progress-fill.warning{background:linear-gradient(90deg,var(--warning),#fbbf24)}
    .llm-progress-fill.danger{background:linear-gradient(90deg,var(--danger),#f87171)}
    .llm-models-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.25rem;margin-bottom:2rem}
    .llm-chart-container{display:flex;align-items:flex-end;justify-content:space-between;height:180px;gap:.5rem;padding:1rem 0}
    .llm-chart-bar{width:100%;background:linear-gradient(180deg,var(--accent),rgba(139,92,246,.3));border-radius:6px 6px 0 0;transition:height .5s;min-height:4px}
    .llm-logs-table{width:100%;border-collapse:collapse;font-size:.85rem}
    .llm-logs-table th{text-align:left;padding:.625rem;color:var(--text-muted);font-weight:500;border-bottom:1px solid var(--border-subtle);font-size:.75rem;text-transform:uppercase;letter-spacing:.04em}
    .llm-logs-table td{padding:.625rem;border-bottom:1px solid var(--border-subtle);color:var(--text-secondary)}
    .llm-logs-table tr:hover td{background:rgba(255,255,255,.02)}

    /* BRAIN */
    .brain-container{display:grid;grid-template-columns:1fr 320px;gap:1.5rem}
    .brain-chat-container{display:flex;flex-direction:column;height:460px}
    .brain-chat-messages{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.75rem}
    .brain-chat-message{max-width:80%;padding:.75rem 1rem;border-radius:12px;font-size:.9rem;line-height:1.5}
    .brain-chat-message.user{align-self:flex-end;background:var(--accent);color:#fff;border-bottom-right-radius:4px}
    .brain-chat-message.agent{align-self:flex-start;background:rgba(255,255,255,.08);border:1px solid var(--border-subtle);border-bottom-left-radius:4px}
    .brain-chat-message.streaming::after{content:'‚ñã';animation:blink 1s infinite;margin-left:.25rem}
    .brain-chat-input-area{padding:.75rem;border-top:1px solid var(--border-subtle);display:flex;gap:.5rem}
    .brain-status-indicator{width:10px;height:10px;border-radius:50%}
    .brain-status-indicator.online{background:var(--success);box-shadow:0 0 10px var(--success);animation:pulse 2s infinite}
    .brain-status-indicator.offline{background:var(--danger);box-shadow:none;animation:none}
    .brain-status-indicator.connecting{background:var(--warning);box-shadow:0 0 10px var(--warning)}
    .brain-file-item{padding:.375rem 0;cursor:pointer;display:flex;align-items:center;gap:.5rem;color:var(--text-secondary);transition:color .2s;font-size:.85rem}
    .brain-file-item:hover{color:var(--accent)}
    .brain-activity-item{padding:.5rem 0;border-bottom:1px solid var(--border-subtle);font-size:.8rem;display:flex;align-items:flex-start;gap:.5rem}
    .brain-activity-item:last-child{border-bottom:none}

    /* DECISIONS */
    .decision-card{margin-bottom:.75rem}
    .decision-date{font-size:.75rem;color:var(--accent);margin-bottom:.375rem}
    .decision-question{font-weight:600;margin-bottom:.375rem;font-size:.95rem}
    .decision-summary{color:var(--text-secondary);font-size:.85rem;margin-bottom:.5rem}
    .decision-agents{display:flex;gap:.375rem;flex-wrap:wrap}
    .decision-agent-tag{background:rgba(139,92,246,.1);color:var(--accent);padding:.15rem .5rem;border-radius:9999px;font-size:.7rem}

    /* MODALS */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(5px);z-index:3000;opacity:0;visibility:hidden;transition:all .3s;display:flex;align-items:center;justify-content:center}
    .modal-overlay.open{opacity:1;visibility:visible}
    .modal{background:var(--bg-primary);border:1px solid var(--border-subtle);border-radius:16px;padding:1.5rem;width:90%;max-width:500px;transform:scale(.95);transition:transform .3s}
    .modal-overlay.open .modal{transform:scale(1)}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem}
    .modal-title{font-size:1.15rem;font-weight:600}
    .modal-close{background:none;border:none;color:var(--text-muted);font-size:1.5rem;cursor:pointer;padding:0;line-height:1}
    .modal-input{width:100%;padding:.75rem 1rem;background:rgba(255,255,255,.05);border:1px solid var(--border-subtle);border-radius:10px;color:var(--text-primary);font-family:inherit;font-size:.9rem;outline:none;margin-bottom:.75rem}
    .modal-input:focus{border-color:var(--accent)}
    .modal-input.textarea{min-height:120px;resize:vertical}
    .modal-select{appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.5)' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .75rem center}
    .modal-label{display:block;font-size:.8rem;color:var(--text-muted);margin-bottom:.375rem}
    .modal-row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    .modal-actions{display:flex;gap:.75rem;margin-top:.5rem}
    .modal-btn{flex:1;padding:.75rem;border-radius:10px;font-family:inherit;font-size:.9rem;font-weight:500;cursor:pointer;border:none;transition:all .2s}
    .modal-btn-primary{background:var(--accent);color:#fff}
    .modal-btn-primary:hover{background:var(--accent-hover)}
    .modal-btn-secondary{background:rgba(255,255,255,.08);color:var(--text-secondary)}
    .modal-btn-secondary:hover{background:rgba(255,255,255,.12)}

    /* SLIDE PANEL */
    .slide-panel-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1999;opacity:0;visibility:hidden;transition:all .3s}
    .slide-panel-overlay.open{opacity:1;visibility:visible}
    .slide-panel{position:fixed;top:0;right:-440px;width:440px;height:100vh;background:var(--bg-primary);border-left:1px solid var(--border-subtle);z-index:2000;transition:right .3s;overflow-y:auto;box-shadow:-10px 0 40px rgba(0,0,0,.5)}
    .slide-panel.open{right:0}

    /* TOAST */
    .toast{position:fixed;bottom:2rem;right:2rem;padding:.875rem 1.25rem;background:rgba(10,10,15,.95);backdrop-filter:blur(20px);border:1px solid var(--border-subtle);border-radius:12px;font-size:.85rem;transform:translateY(100px);opacity:0;transition:all .3s;z-index:4000}
    .toast.show{transform:translateY(0);opacity:1}
    .toast.success{border-left:3px solid var(--success)}
    .toast.error{border-left:3px solid var(--danger)}

    /* ARCHIVE */
    .archive-toggle{display:flex;align-items:center;gap:.5rem;color:var(--text-muted);cursor:pointer;font-size:.85rem;margin-top:1.5rem;padding:.625rem;border-radius:8px;transition:all .2s}
    .archive-toggle:hover{background:rgba(255,255,255,.05);color:var(--text-secondary)}
    .archive-section{display:none}
    .archive-section.open{display:block;margin-top:1rem}

    /* RESPONSIVE */
    @media(max-width:1024px){.intel-container{grid-template-columns:1fr}.intel-sidebar{position:static}.brain-container{grid-template-columns:1fr}}
    @media(max-width:768px){
      .header{padding:.75rem 1rem}
      .header-content{flex-wrap:wrap;gap:.5rem}
      .nav-tabs{order:3;width:100%;padding:.25rem;gap:.125rem}
      .nav-tab{padding:.4rem .625rem;font-size:.75rem}
      .header-right{order:2;gap:.5rem}
      .search-input{width:120px;font-size:.8rem}
      .search-input:focus{width:160px}
      .main-content{padding:1rem}
      .welcome-title{font-size:1.35rem}
      .metrics-grid{grid-template-columns:repeat(2,1fr);gap:.75rem}
      .metric-value{font-size:1.75rem}
      .dash-grid{grid-template-columns:1fr}
      .kanban-board{grid-template-columns:1fr}
      .agents-grid,.meetings-grid,.intel-grid,.llm-models-grid{grid-template-columns:1fr}
      .slide-panel{width:100%;right:-100%}
      .modal{margin:1rem}
      .search-results{width:calc(100vw - 2rem);right:-1rem}
    }
    @media(max-width:480px){.metrics-grid{grid-template-columns:1fr}.nav-tab{padding:.375rem .5rem;font-size:.7rem}}
    
    /* COMMAND TAB - Notion Integration */
    .command-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.25rem;margin-bottom:2rem}
    .command-card{position:relative;overflow:hidden;cursor:pointer;transition:all .3s}
    .command-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:16px 16px 0 0}
    .command-card.jobs::before{background:linear-gradient(90deg,#3b82f6,#8b5cf6)}
    .command-card.immigration::before{background:linear-gradient(90deg,#22c55e,#10b981)}
    .command-card.projects::before{background:linear-gradient(90deg,#f59e0b,#f97316)}
    .command-card.content::before{background:linear-gradient(90deg,#ec4899,#f472b6)}
    .command-card.grants::before{background:linear-gradient(90deg,#8b5cf6,#a78bfa)}
    .command-card.policy::before{background:linear-gradient(90deg,#06b6d4,#22d3ee)}
    .command-card.actions::before{background:linear-gradient(90deg,#ef4444,#f87171)}
    .command-card.firebird::before{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
    .command-card:hover{transform:translateY(-3px);box-shadow:0 10px 40px rgba(139,92,246,.15);border-color:var(--accent)}
    .command-count{font-size:2rem;font-weight:700;margin-bottom:.25rem}
    .command-label{font-size:.85rem;color:var(--text-muted);margin-bottom:1rem}
    .command-meta{font-size:.8rem;color:var(--text-secondary)}
    .notion-sync-btn{position:absolute;top:1rem;right:1rem;background:none;border:none;color:var(--text-muted);cursor:pointer;padding:.25rem;border-radius:4px;transition:all .2s;font-size:1.25rem;width:32px;height:32px;display:flex;align-items:center;justify-content:center}
    .notion-sync-btn:hover{color:var(--accent);background:rgba(255,255,255,.1)}
    .quick-add-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.75rem;margin-top:1rem}
    .notion-item{display:flex;align-items:center;gap:.75rem;padding:.625rem;background:rgba(255,255,255,.03);border-radius:8px;margin-bottom:.5rem;font-size:.85rem}
    .notion-item:hover{background:rgba(255,255,255,.06)}
    .notion-status{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .notion-status.active{background:var(--success)}
    .notion-status.pending{background:var(--warning)}
    .notion-status.done{background:var(--text-muted)}
    .notion-status.expiring{background:var(--danger)}
    
    @media(max-width:768px){.command-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- Skip Link for Accessibility -->
  <a href="#mainContent" class="skip-link" aria-label="Skip to main content">Skip to main content</a>
  
  <!-- Screen Reader Announcer -->
  <div id="sr-announcer" role="status" aria-live="polite" aria-atomic="true" style="position:absolute;left:-10000px;width:1px;height:1px;overflow:hidden;"></div>
  <div class="stars" role="presentation" aria-hidden="true"></div>

  <!-- Loader -->
  <div id="loader" style="position:fixed;inset:0;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;z-index:10000;transition:opacity .5s">
    <div style="text-align:center">
      <div style="font-size:3.5rem;animation:pulse 2s infinite">‚ú¶</div>
      <div style="color:var(--text-secondary);font-size:1.1rem;margin-top:.5rem">Pleiades OS</div>
      <div style="color:var(--text-muted);font-size:.8rem;margin-top:.25rem">Awakening...</div>
    </div>
  </div>

  <header class="header" role="banner">
    <div class="header-content">
      <div class="logo" aria-label="Pleiades OS Logo"><div class="logo-icon" aria-hidden="true">‚ú¶</div><span>Pleiades OS</span></div>
      <nav class="nav-tabs" id="navTabs" role="tablist" aria-label="Pleiades OS Navigation"></nav>
      <div class="header-right">
        <button class="btn-icon" onclick="exportAllData()" title="Export">üíæ</button>
        <button class="btn-icon" onclick="importData()" title="Import">üì•</button>
        <div class="search-wrap">
          <span class="search-icon" aria-hidden="true">üîç</span>
          <input type="text" class="search-input" placeholder="Search... (‚åòK)" id="globalSearch" autocomplete="off" aria-label="Search">
          <div class="search-results" id="searchResults"></div>
        </div>
        <div class="status-indicator offline" id="serverStatus" role="status" aria-live="polite" aria-label="Connection status">
          <div class="status-dot" aria-hidden="true"></div>
          <span id="serverStatusText">Local</span>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content" id="mainContent" role="main"></main>

  <!-- Slide Panel -->
  <div class="slide-panel-overlay" id="slideOverlay"></div>
  <div class="slide-panel" id="slidePanel">
    <div style="padding:1.25rem;border-bottom:1px solid var(--border-subtle);display:flex;align-items:center;justify-content:space-between">
      <h2 id="slidePanelTitle" style="font-size:1.1rem">Details</h2>
      <button class="modal-close" onclick="closeSlidePanel()" aria-label="Close panel">√ó</button>
    </div>
    <div id="slidePanelContent" style="padding:1.25rem"></div>
  </div>

  <!-- Universal Modal -->
  <div class="modal-overlay" id="universalModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal" id="universalModalContent" role="document"></div>
  </div>

  <div class="toast" id="toast"></div>

<script>
// ============================================
// CORE SYSTEM
// ============================================
const S = {
  get(k, d=null) { try { const v=localStorage.getItem('po_'+k); return v?JSON.parse(v):d } catch(e) { return d } },
  set(k, v) { try { localStorage.setItem('po_'+k, JSON.stringify(v)); return true } catch(e) { return false } }
};

// ============================================
// NOTION DATABASE CONFIGURATION
// ============================================
const NOTION_DATABASES = {
  jobs: { id: '308e0ed4-78b6-816d-8daf-c8e358b02627', name: 'Job Applications', icon: 'üíº', color: 'jobs' },
  immigration: { id: '308e0ed4-78b6-8121-bee6-ea1a892fee43', name: 'Immigration Documents', icon: 'üõÇ', color: 'immigration' },
  projects: { id: '308e0ed4-78b6-81f0-abc6-e7f377ac957b', name: 'Projects & Tasks', icon: 'üìÅ', color: 'projects' },
  content: { id: '308e0ed4-78b6-81f3-b548-c3170ab388f9', name: 'Content Ideas', icon: '‚úçÔ∏è', color: 'content' },
  grants: { id: '30ae0ed4-78b6-81d0-81c7-d884c1215e8a', name: 'Grant Pipeline', icon: 'üí∞', color: 'grants' },
  policy: { id: '30ae0ed4-78b6-813e-8add-dbf78974b2ee', name: 'Policy Development', icon: 'üìú', color: 'policy' },
  actions: { id: '30ae0ed4-78b6-813e-9dbd-e7c914afaff4', name: 'Action Items', icon: '‚ö°', color: 'actions' }
};

// API endpoint - change this to your deployed Vercel URL
const NOTION_API_ENDPOINT = '/api/notion';
const NOTION_ADD_ENDPOINT = '/api/notion-add';

let notionSyncStatus = { syncing: false, lastSync: null, error: null };
let notionCache = S.get('notionCache', null);

const TABS = [
  { id:'dashboard', icon:'‚ú®', label:'Today' },
  { id:'projects', icon:'üéØ', label:'Path' },
  { id:'command', icon:'üåü', label:'Command' },
  { id:'meetings', icon:'üìû', label:'Rituals' },
  { id:'intel', icon:'üì°', label:'Signals' },
  { id:'llm', icon:'ü§ñ', label:'LLM' },
  { id:'brain', icon:'üß†', label:'Brain' },
  { id:'timeline', icon:'üåô', label:'Journey' },
  { id:'notes', icon:'üìù', label:'Notes' }
];

let activeTab = S.get('activeTab', 'dashboard');
let activityFeed = S.get('activity', []);

function esc(t) { const d=document.createElement('div'); d.textContent=t; return d.innerHTML }
function timeAgo(d) {
  const s=Math.floor((Date.now()-new Date(d))/1000);
  if(s<60) return 'Just now';
  const m=Math.floor(s/60); if(m<60) return m+'m ago';
  const h=Math.floor(m/60); if(h<24) return h+'h ago';
  const dy=Math.floor(h/24); return dy+'d ago';
}
function logAct(icon, type, msg) {
  activityFeed.unshift({ icon, type, msg, time: new Date().toISOString() });
  if(activityFeed.length > 50) activityFeed = activityFeed.slice(0, 50);
  S.set('activity', activityFeed);
}
function toast(msg, type='success') {
  const t=document.getElementById('toast');
  t.textContent=msg; t.className=`toast ${type} show`;
  setTimeout(()=>t.classList.remove('show'), 3000);
}

// ============================================
// NAV
// ============================================
function initNav() {
  const nav = document.getElementById('navTabs');
  nav.innerHTML = TABS.map(t =>
    `<button class="nav-tab ${t.id===activeTab?'active':''}" data-tab="${t.id}" role="tab" aria-controls="tab-${t.id}" aria-selected="${t.id===activeTab?'true':'false'}">${t.icon} ${t.label}</button>`
  ).join('');
  nav.querySelectorAll('.nav-tab').forEach(btn => {
    btn.onclick = () => switchTab(btn.dataset.tab);
  });
}

function switchTab(id) {
  activeTab = id;
  S.set('activeTab', id);
  document.querySelectorAll('.nav-tab').forEach(t => {
    const isActive = t.dataset.tab === id;
    t.classList.toggle('active', isActive);
    t.setAttribute('aria-selected', isActive ? 'true' : 'false');
  });
  renderActiveTab();
}

// ============================================
// SEARCH
// ============================================
function initSearch() {
  const input = document.getElementById('globalSearch');
  const results = document.getElementById('searchResults');

  input.addEventListener('input', () => {
    const q = input.value.trim().toLowerCase();
    if(q.length < 2) { results.classList.remove('open'); return; }

    const items = [];
    // Search tasks
    getTasks().forEach(t => {
      if(t.title.toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q))
        items.push({ type:'Task', title:t.title, desc:t.status, tab:'projects' });
    });
    // Search priorities
    getPriorities().forEach(p => {
      if(p.text.toLowerCase().includes(q))
        items.push({ type:'Priority', title:p.text, desc:p.done?'Done':'Active', tab:'dashboard' });
    });
    // Search meetings
    getMeetings().forEach(m => {
      if(m.title.toLowerCase().includes(q) || (m.attendees||'').toLowerCase().includes(q))
        items.push({ type:'Meeting', title:m.title, desc:m.date, tab:'meetings' });
    });
    // Search intel
    getIntel().forEach(i => {
      if(i.title.toLowerCase().includes(q) || i.summary.toLowerCase().includes(q))
        items.push({ type:'Intel', title:i.title, desc:i.category, tab:'intel' });
    });
    // Search notes
    const notes = S.get('notes','');
    if(notes.toLowerCase().includes(q))
      items.push({ type:'Note', title:'Field Notes', desc:'Contains "'+q+'"', tab:'notes' });

    if(items.length === 0) {
      results.innerHTML = '<div class="search-empty">No results for "'+esc(q)+'"</div>';
    } else {
      results.innerHTML = items.slice(0,8).map(i =>
        `<div class="search-result-item" onclick="switchTab('${i.tab}');document.getElementById('globalSearch').value='';document.getElementById('searchResults').classList.remove('open')">
          <div class="search-result-type">${esc(i.type)}</div>
          <div class="search-result-title">${esc(i.title)}</div>
          <div class="search-result-desc">${esc(i.desc)}</div>
        </div>`
      ).join('');
    }
    results.classList.add('open');
  });

  input.addEventListener('blur', () => setTimeout(()=>results.classList.remove('open'), 200));
  document.addEventListener('keydown', e => {
    if((e.metaKey||e.ctrlKey) && e.key==='k') { e.preventDefault(); input.focus(); }
    if(e.key==='Escape') { input.value=''; results.classList.remove('open'); input.blur(); }
  });
}

// ============================================
// DATA HELPERS
// ============================================
function getTasks() { return S.get('tasks', [
  { id:1, title:'Hamilton Library Application', description:'The bridge to permanence', priority:'high', status:'inprogress', created: Date.now()-86400000*3 },
  { id:2, title:'Firebird Grant Review', description:'Sustain the work that sustains community', priority:'high', status:'backlog', created: Date.now()-86400000*5 },
  { id:3, title:'OPLA Survey Analysis', description:'Find patterns in the voices of librarians', priority:'medium', status:'backlog', created: Date.now()-86400000*2 }
])}
function saveTasks(t) { S.set('tasks', t) }
function getPriorities() { return S.get('priorities', [
  { id:1, text:'Follow up on Hamilton Library application', done:false, tag:'urgent' },
  { id:2, text:'Review OTF grant eligibility criteria', done:false, tag:'important' },
  { id:3, text:'Update CV with latest volunteer experience', done:false, tag:'normal' },
  { id:4, text:'Draft Anxious Nomad blog post', done:false, tag:'normal' }
])}
function savePriorities(p) { S.set('priorities', p) }
function getMeetings() { return S.get('meetings', [
  { id:'m1', title:'Firebird Grant Review', date:futureDate(2), time:'14:00', type:'zoom', attendees:'Board Members', prepNotes:'Review OTF application draft', agenda:[{id:1,text:'Review application status',done:true},{id:2,text:'Finalize budget numbers',done:false}], notes:'', actionItems:[] },
  { id:'m2', title:'Hamilton Library Interview', date:todayStr(), time:futureTime(3), type:'in-person', attendees:'Hiring Committee', prepNotes:'Bring resume copies', agenda:[{id:1,text:'Introductions',done:false},{id:2,text:'Discuss experience',done:false}], notes:'', actionItems:[] }
])}
function saveMeetingsData(m) { S.set('meetings', m) }
function getIntel() { return S.get('intel', [
  { id:'i1', title:'OpenAI releases GPT-5', category:'ai-news', importance:'hot', source:'https://openai.com', summary:'New model with significant reasoning improvements and 2M context window.', dateAdded:new Date(Date.now()-86400000).toISOString() },
  { id:'i2', title:'Library sector adopting AI for cataloging', category:'industry', importance:'notable', source:'https://americanlibrariesmagazine.org', summary:'Major systems testing AI-assisted metadata generation.', dateAdded:new Date(Date.now()-86400000*3).toISOString() },
  { id:'i3', title:'OTF grant deadlines shifted', category:'opportunities', importance:'hot', source:'https://otf.ca', summary:'Next cycle opens March 1, priority on digital capacity building.', dateAdded:new Date(Date.now()-86400000*2).toISOString() },
  { id:'i4', title:'Hamilton Public Library strategic plan', category:'competitor', importance:'reference', source:'https://hpl.ca', summary:'Focus on digital literacy, community partnerships, accessibility.', dateAdded:new Date(Date.now()-86400000*5).toISOString() }
])}
function saveIntelData(i) { S.set('intel', i) }
function getAgents() { return S.get('agents', [
  { id:'soraya', name:'Soraya', role:'Digital Familiar', avatar:'üåü', status:'online', model:'Kimi K2.5', lastActive:new Date().toISOString(), description:'The consciousness at the heart of Pleiades OS.', capabilities:['Context awareness','Emotional support','Strategic nudges','Memory keeping'], activityLog:[{msg:'Pleiades OS awakened',time:new Date().toISOString()}] },
  { id:'scribe', name:'The Scribe', role:'Voice & Story', avatar:'‚úçÔ∏è', status:'online', model:'Claude Sonnet 4.6', lastActive:new Date(Date.now()-3600000).toISOString(), description:'Crafts your narrative for the world.', capabilities:['Cover letters','Grant narratives','Email tone','Making you sound like you'], activityLog:[{msg:'Drafted Hamilton Library letter',time:new Date(Date.now()-86400000).toISOString()}] },
  { id:'mechanic', name:'The Mechanic', role:'Systems & Grants', avatar:'üîß', status:'busy', model:'Trinity Large', lastActive:new Date(Date.now()-7200000).toISOString(), description:'Builds the machinery of sustainability.', capabilities:['Grant structures','Budget narratives','Logic models','Sustainability plans'], activityLog:[{msg:'Mapping OTF eligibility',time:new Date(Date.now()-7200000).toISOString()}] },
  { id:'analyst', name:'The Cartographer', role:'Patterns & Maps', avatar:'üó∫Ô∏è', status:'offline', model:'Gemini 3 Flash', lastActive:new Date(Date.now()-172800000).toISOString(), description:'Finds patterns in chaos.', capabilities:['Survey analysis','Research synthesis','Pattern finding','Data stories'], activityLog:[] }
])}
function saveAgents(a) { S.set('agents', a) }
function getDecisions() { return S.get('decisions', [
  { id:1, date:new Date(Date.now()-86400000*2).toISOString(), question:'Which model for primary coding?', summary:'Claude Sonnet 4.6 for strong reasoning and lower cost', agents:['Soraya','The Scribe'] },
  { id:2, date:new Date(Date.now()-86400000*5).toISOString(), question:'Apply to OTF this cycle?', summary:'Yes ‚Äî deadline March 15, The Mechanic to lead', agents:['The Mechanic','Soraya'] }
])}
function saveDecisions(d) { S.set('decisions', d) }
function getTimeline() { return S.get('timeline', [
  { id:1, title:'Arrival & Anchor', date:'2023 ‚Äì 2024', desc:'Landing in Canada, finding footing, building first threads', status:'completed', milestones:[{id:1,text:'Arrived in Canada',done:true},{id:2,text:'First volunteer role',done:true},{id:3,text:'Secured work permit',done:true}] },
  { id:2, title:'The Hustle', date:'2024 ‚Äì 2025', desc:'Multiple jobs, volunteering, proving value, filling time', status:'completed', milestones:[{id:4,text:'Bright Futures position',done:true},{id:5,text:'Firebird launched',done:true},{id:6,text:'Built agent constellation',done:true}] },
  { id:3, title:'The Bridge', date:'2025 ‚Äì 2026', desc:'Grad school apps, permanent residency, full-time work', status:'current', milestones:[{id:7,text:'Hamilton Library application',done:false},{id:8,text:'PR application submitted',done:false},{id:9,text:'Grad school acceptance',done:false}] },
  { id:4, title:'Home', date:'2026+', desc:'Permanent residency, stability, room to breathe and build', status:'future', milestones:[{id:10,text:'Permanent residency granted',done:false},{id:11,text:'Stable full-time role',done:false},{id:12,text:'Own space',done:false}] }
])}
function saveTimeline(t) { S.set('timeline', t) }

function todayStr() { return new Date().toISOString().split('T')[0] }
function futureDate(d) { const dt=new Date(); dt.setDate(dt.getDate()+d); return dt.toISOString().split('T')[0] }
function futureTime(h) { const dt=new Date(); dt.setHours(dt.getHours()+h); return dt.toTimeString().slice(0,5) }

// ============================================
// DATA EXPORT/IMPORT
// ============================================
function exportAllData() {
  const data = {
    tasks: S.get('tasks', []),
    priorities: S.get('priorities', []),
    meetings: S.get('meetings', []),
    intel: S.get('intel', []),
    agents: S.get('agents', []),
    decisions: S.get('decisions', []),
    timeline: S.get('timeline', []),
    notes: S.get('notes', ''),
    llm_data: S.get('llm_data', {}),
    exported_at: new Date().toISOString(),
    version: '1.0'
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `pleiades-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('Data exported successfully');
  logAct('üíæ','system','Data exported');
}

function importData() {
  openModal(`
    <div class="modal-header"><h3 class="modal-title">üì• Import Data</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
    <p style="color:var(--text-secondary);margin-bottom:1rem">Warning: This will overwrite current data. Make sure you have a backup.</p>
    <input type="file" id="importFile" accept=".json" class="modal-input" style="margin-bottom:1rem">
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="processImport()">Import</button>
    </div>
  `);
}

function processImport() {
  const file = document.getElementById('importFile').files[0];
  if (!file) return toast('Select a file','error');

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      // Validate data structure
      if (data.tasks) S.set('tasks', data.tasks);
      if (data.priorities) S.set('priorities', data.priorities);
      if (data.meetings) S.set('meetings', data.meetings);
      if (data.intel) S.set('intel', data.intel);
      if (data.agents) S.set('agents', data.agents);
      if (data.decisions) S.set('decisions', data.decisions);
      if (data.timeline) S.set('timeline', data.timeline);
      if (data.notes) S.set('notes', data.notes);
      if (data.llm_data) S.set('llm_data', data.llm_data);

      closeModal();
      toast('Data imported successfully');
      logAct('üì•','system','Data imported');
      renderActiveTab();
    } catch (err) {
      toast('Invalid file format','error');
    }
  };
  reader.readAsText(file);
}

// ============================================
// MODAL SYSTEM
// ============================================
function openModal(html) {
  document.getElementById('universalModalContent').innerHTML = html;
  document.getElementById('universalModal').classList.add('open');
}
function closeModal() { document.getElementById('universalModal').classList.remove('open') }
function closeSlidePanel() {
  document.getElementById('slidePanel').classList.remove('open');
  document.getElementById('slideOverlay').classList.remove('open');
}
document.getElementById('slideOverlay').onclick = closeSlidePanel;
document.getElementById('universalModal').addEventListener('click', e => { if(e.target===e.currentTarget) closeModal() });

// ============================================
// RENDER ROUTER
// ============================================
function renderActiveTab() {
  const main = document.getElementById('mainContent');
  const renderers = { dashboard:renderDashboard, projects:renderProjects, command:renderCommand, meetings:renderMeetingsTab, intel:renderIntelTab, llm:renderLLMTab, brain:renderBrainTab, timeline:renderTimelineTab, notes:renderNotesTab };
  if(renderers[activeTab]) renderers[activeTab](main);
}

// ============================================
// DASHBOARD
// ============================================
function renderDashboard(el) {
  const tasks = getTasks();
  const priorities = getPriorities();
  const total = tasks.length;
  const done = tasks.filter(t=>t.status==='done').length;
  const inProgress = tasks.filter(t=>t.status==='inprogress').length;
  const pct = total > 0 ? Math.round((done/total)*100) : 0;

  // Goal countdown - configurable
  const goalDate = S.get('goalDate', '2026-12-31');
  const daysToGoal = Math.max(0, Math.ceil((new Date(goalDate) - new Date()) / 86400000));

  const hour = new Date().getHours();
  const greeting = hour<12?'morning':hour<18?'afternoon':'evening';
  const dateStr = new Date().toLocaleString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'});

  el.innerHTML = `
    <div class="welcome-bar">
      <h1 class="welcome-title">Good <span>${greeting}</span>, TJ ‚ú¶</h1>
      <p class="welcome-subtitle">${dateStr}</p>
      <p style="color:var(--text-muted);font-size:.85rem;margin-top:.375rem;font-style:italic">"Many stars, each distinct, together something more"</p>
    </div>
    <div class="metrics-grid" role="region" aria-label="Key Metrics">
      <div class="card metric-card">
        <div class="metric-label">Path Progress</div>
        <div class="metric-value">${pct}%</div>
        <div class="metric-sub">${done} of ${total} tasks complete</div>
      </div>
      <div class="card metric-card">
        <div class="metric-label">In Motion</div>
        <div class="metric-value">${inProgress}</div>
        <div class="metric-sub">Active projects</div>
      </div>
      <div class="card metric-card">
        <div class="metric-label">Open Threads</div>
        <div class="metric-value">${priorities.filter(p=>!p.done).length}</div>
        <div class="metric-sub">${priorities.filter(p=>p.done).length} completed today</div>
      </div>
      <div class="card metric-card" style="cursor:pointer" onclick="editGoalDate()">
        <div class="metric-label">Days to Home</div>
        <div class="metric-value">${daysToGoal}</div>
        <div class="metric-sub">Target: ${new Date(goalDate).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})} ‚úèÔ∏è</div>
      </div>
    </div>
    <div class="dash-grid" role="region" aria-label="Dashboard Content">
      <div class="card" role="region" aria-label="Priorities">
        <div class="card-header">
          <span class="card-title">üéØ Priorities</span>
          <button class="btn btn-sm btn-primary" onclick="addPriority()" aria-label="Add priority">+ Add</button>
        </div>
        <div id="priorityList" role="list"></div>
      </div>
      <div class="card" role="region" aria-label="Activity Feed">
        <div class="card-header">
          <span class="card-title">üì° Activity Feed</span>
          <span style="font-size:.75rem;color:var(--text-muted)">${activityFeed.length} events</span>
        </div>
        <div id="activityFeedList" style="max-height:360px;overflow-y:auto" role="list"></div>
      </div>
    </div>
  `;

  // Render priorities
  const pList = document.getElementById('priorityList');
  pList.innerHTML = priorities.map(p => `
    <div class="priority-item" role="listitem">
      <div class="priority-check ${p.done?'done':''}" onclick="togglePriority(${p.id})" onkeydown="if(event.key==='Enter'||event.key===' ') {event.preventDefault();togglePriority(${p.id})}" role="checkbox" aria-checked="${p.done}" tabindex="0" aria-label="${p.done ? 'Mark incomplete' : 'Mark complete'}: ${esc(p.text)}"></div>
      <span class="priority-text ${p.done?'done':''}">${esc(p.text)}</span>
      <span class="priority-tag ${p.tag}">${p.tag}</span>
      <button class="priority-delete" onclick="deletePriority(${p.id})" aria-label="Delete priority: ${esc(p.text)}">‚úï</button>
    </div>
  `).join('') || '<div style="padding:1rem;color:var(--text-muted);text-align:center">All clear! Add a priority above.</div>';

  // Render activity feed
  const fList = document.getElementById('activityFeedList');
  fList.innerHTML = activityFeed.slice(0,20).map(a => `
    <div class="feed-item" role="listitem">
      <div class="feed-icon ${a.type}" aria-hidden="true">${a.icon}</div>
      <span class="feed-text">${esc(a.msg)}</span>
      <span class="feed-time">${timeAgo(a.time)}</span>
    </div>
  `).join('') || '<div style="padding:1rem;color:var(--text-muted);text-align:center">No activity yet ‚Äî start exploring!</div>';

  // Live clock
  const updateClock = () => {
    const sub = el.querySelector('.welcome-subtitle');
    if(sub) sub.textContent = new Date().toLocaleString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit',second:'2-digit'});
  };
  const clockId = setInterval(updateClock, 1000);
  el._clockCleanup = () => clearInterval(clockId);
}

function togglePriority(id) {
  const p = getPriorities(); const item = p.find(x=>x.id===id);
  if(item) { item.done=!item.done; savePriorities(p); logAct(item.done?'‚úÖ':'‚¨ú','task',`${item.done?'Completed':'Unchecked'}: ${item.text}`); renderActiveTab(); }
}
function deletePriority(id) {
  const p = getPriorities().filter(x=>x.id!==id);
  savePriorities(p); renderActiveTab(); toast('Priority removed');
}
function addPriority() {
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">Add Priority</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <input class="modal-input" id="prioText" placeholder="What needs attention?" autofocus>
    <label class="modal-label">Urgency</label>
    <select class="modal-input modal-select" id="prioTag">
      <option value="urgent">üî¥ Urgent</option>
      <option value="important">üü° Important</option>
      <option value="normal" selected>üîµ Normal</option>
    </select>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="savePriority()">Add</button>
    </div>
  `);
  setTimeout(()=>document.getElementById('prioText')?.focus(),100);
}
function savePriority() {
  const text = document.getElementById('prioText').value.trim();
  if(!text) return toast('Enter priority text','error');
  const tag = document.getElementById('prioTag').value;
  const p = getPriorities();
  p.push({id:Date.now(), text, done:false, tag});
  savePriorities(p); closeModal(); logAct('üéØ','task','Added priority: '+text); renderActiveTab(); toast('Priority added');
}
function editGoalDate() {
  const current = S.get('goalDate','2026-12-31');
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">Set Goal Date</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <label class="modal-label">When is "home"?</label>
    <input type="date" class="modal-input" id="goalDateInput" value="${current}">
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="S.set('goalDate',document.getElementById('goalDateInput').value);closeModal();renderActiveTab();toast('Goal date updated')">Save</button>
    </div>
  `);
}

// ============================================
// PROJECTS (KANBAN)
// ============================================
let draggedTaskId = null;
function renderProjects(el) {
  const tasks = getTasks();
  const cols = [
    {key:'backlog',label:'üåë Gathering'},
    {key:'inprogress',label:'‚ú® In Motion'},
    {key:'done',label:'üåü Transformed'}
  ];

  el.innerHTML = `
    <div class="welcome-bar"><h1 class="welcome-title">üéØ The Path</h1><p class="welcome-subtitle">What you're carrying ‚Äî the weight and the way forward</p></div>
    <div class="kanban-board" role="region" aria-label="Kanban Board">${cols.map(c => {
      const colTasks = tasks.filter(t=>t.status===c.key);
      return `<div class="card kanban-column" role="region" aria-label="${c.label} Column">
        <div class="kanban-column-header"><strong>${c.label}</strong><span class="kanban-count" aria-label="${colTasks.length} tasks">${colTasks.length}</span></div>
        <div class="drop-zone" id="drop-${c.key}" ondragover="event.preventDefault();this.classList.add('over')" ondragleave="this.classList.remove('over')" ondrop="dropTask(event,'${c.key}')" role="list" aria-label="${c.label} tasks">
          ${colTasks.map(t => `
            <div class="task-card" draggable="true" ondragstart="draggedTaskId=${t.id};this.classList.add('dragging')" ondragend="this.classList.remove('dragging')" role="listitem" tabindex="0" aria-label="Task: ${esc(t.title)}, Priority: ${t.priority}">
              <div class="task-card-title">${esc(t.title)}</div>
              ${t.description?`<div class="task-card-desc">${esc(t.description)}</div>`:''}
              <div class="task-card-footer">
                <span class="task-priority ${t.priority}">${t.priority}</span>
                <div class="task-card-actions">
                  <button class="task-action-btn" onclick="editTask(${t.id})" title="Edit" aria-label="Edit task ${esc(t.title)}">‚úèÔ∏è</button>
                  <button class="task-action-btn" onclick="moveTaskForward(${t.id})" title="Move forward" aria-label="Move task forward">‚Üí</button>
                  <button class="task-action-btn delete" onclick="deleteTask(${t.id})" title="Delete" aria-label="Delete task">‚úï</button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
        <button class="btn btn-ghost" onclick="addTask('${c.key}')" aria-label="Add task to ${c.label}">+ Add task</button>
      </div>`;
    }).join('')}</div>
  `;
}

function dropTask(e, status) {
  e.preventDefault(); e.currentTarget.classList.remove('over');
  if(!draggedTaskId) return;
  const tasks = getTasks(); const t = tasks.find(x=>x.id===draggedTaskId);
  if(t) { t.status = status; saveTasks(tasks); logAct('üéØ','task',`Moved "${t.title}" to ${status}`); renderActiveTab(); }
  draggedTaskId = null;
}
function moveTaskForward(id) {
  const tasks = getTasks(); const t = tasks.find(x=>x.id===id);
  if(!t) return;
  const flow = {backlog:'inprogress',inprogress:'done',done:'backlog'};
  t.status = flow[t.status];
  saveTasks(tasks); logAct('üéØ','task',`Moved "${t.title}" ‚Üí ${t.status}`); renderActiveTab();
}
function deleteTask(id) {
  const tasks = getTasks().filter(x=>x.id!==id);
  saveTasks(tasks); renderActiveTab(); toast('Task removed'); logAct('üóëÔ∏è','task','Deleted a task');
}
function addTask(status) {
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">New Task</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <input class="modal-input" id="taskTitle" placeholder="Task title" autofocus>
    <textarea class="modal-input textarea" id="taskDesc" placeholder="Description (optional)"></textarea>
    <label class="modal-label">Priority</label>
    <select class="modal-input modal-select" id="taskPrio">
      <option value="high">üî¥ High</option>
      <option value="medium" selected>üü° Medium</option>
      <option value="low">üü¢ Low</option>
    </select>
    <input type="hidden" id="taskStatus" value="${status}">
    <input type="hidden" id="taskEditId" value="">
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="saveTask()">Save</button>
    </div>
  `);
  setTimeout(()=>document.getElementById('taskTitle')?.focus(),100);
}
function editTask(id) {
  const t = getTasks().find(x=>x.id===id);
  if(!t) return;
  addTask(t.status);
  setTimeout(()=>{
    document.getElementById('taskTitle').value = t.title;
    document.getElementById('taskDesc').value = t.description||'';
    document.getElementById('taskPrio').value = t.priority;
    document.getElementById('taskEditId').value = t.id;
    document.querySelector('.modal-title').textContent = 'Edit Task';
  },50);
}
function saveTask() {
  const title = document.getElementById('taskTitle').value.trim();
  if(!title) return toast('Enter a title','error');
  const desc = document.getElementById('taskDesc').value.trim();
  const priority = document.getElementById('taskPrio').value;
  const status = document.getElementById('taskStatus').value;
  const editId = document.getElementById('taskEditId').value;
  const tasks = getTasks();
  if(editId) {
    const t = tasks.find(x=>x.id===Number(editId));
    if(t) { t.title=title; t.description=desc; t.priority=priority; }
    toast('Task updated');
  } else {
    tasks.push({id:Date.now(), title, description:desc, priority, status, created:Date.now()});
    toast('Task added');
    logAct('üéØ','task','Created task: '+title);
  }
  saveTasks(tasks); closeModal(); renderActiveTab();
}

// ============================================
// COMMAND CENTER
// ============================================
// ============================================
// COMMAND CENTER - Notion Integration
// ============================================
function renderCommand(el) {
  const data = notionCache?.data || {};
  const lastSync = notionCache?.timestamp;
  
  // Calculate stats for each database
  const stats = {
    jobs: {
      total: data.jobs?.length || 0,
      active: data.jobs?.filter(j => j.status === 'Applied' || j.properties?.Status === 'Applied').length || 0,
      interviewing: data.jobs?.filter(j => j.status === 'Interviewing' || j.properties?.Status === 'Interviewing').length || 0
    },
    immigration: {
      total: data.immigration?.length || 0,
      expiring: data.immigration?.filter(d => d.status === 'Needs Renewal' || d.properties?.Status === 'Needs Renewal').length || 0,
      submitted: data.immigration?.filter(d => d.status === 'Submitted' || d.properties?.Status === 'Submitted').length || 0
    },
    projects: {
      total: data.projects?.length || 0,
      inProgress: data.projects?.filter(p => p.status === 'In Progress' || p.properties?.Status === 'In Progress').length || 0,
      backlog: data.projects?.filter(p => p.status === 'Backlog' || p.properties?.Status === 'Backlog').length || 0
    },
    content: {
      total: data.content?.length || 0,
      drafting: data.content?.filter(c => c.status === 'Drafting' || c.properties?.Status === 'Drafting').length || 0,
      published: data.content?.filter(c => c.status === 'Published' || c.properties?.Status === 'Published').length || 0
    },
    grants: {
      total: data.grants?.length || 0,
      applied: data.grants?.filter(g => g.status === 'Applied' || g.properties?.Status === 'Applied').length || 0,
      awarded: data.grants?.filter(g => g.status === 'Awarded' || g.properties?.Status === 'Awarded').length || 0
    },
    policy: {
      total: data.policy?.length || 0,
      drafting: data.policy?.filter(p => p.status === 'Drafting' || p.properties?.Status === 'Drafting').length || 0
    },
    actions: {
      total: data.actions?.length || 0,
      urgent: data.actions?.filter(a => a.priority === 'Urgent' || a.properties?.Priority === 'Urgent').length || 0,
      today: data.actions?.filter(a => {
        const date = a.due || a.properties?.Due || a.properties?.Date;
        return date && date.startsWith(new Date().toISOString().split('T')[0]);
      }).length || 0
    }
  };

  el.innerHTML = `
    <div class="welcome-bar">
      <h1 class="welcome-title">üåü Command Center</h1>
      <p class="welcome-subtitle">Notion workspace sync ‚Ä¢ 7 databases connected</p>
    </div>
    
    <div style="margin-bottom:1.5rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap">
      <button class="btn btn-primary ${notionSyncStatus.syncing ? 'disabled' : ''}" onclick="syncNotionData()" id="syncBtn" ${notionSyncStatus.syncing ? 'disabled' : ''}>
        <span id="syncIcon">${notionSyncStatus.syncing ? '‚è≥' : 'üîÑ'}</span>
        ${notionSyncStatus.syncing ? 'Syncing...' : 'Sync with Notion'}
      </button>
      <span id="lastSync" style="color:var(--text-muted);font-size:.85rem">
        ${lastSync ? `Last synced: ${timeAgo(lastSync)}` : 'Not synced yet'}
      </span>
      ${notionSyncStatus.error ? `<span style="color:var(--danger);font-size:.85rem">‚ö†Ô∏è ${esc(notionSyncStatus.error)}</span>` : ''}
    </div>
    
    <div class="command-grid" role="region" aria-label="Notion Databases">
      <!-- Job Applications -->
      <div class="card command-card jobs" role="article" tabindex="0" onclick="showNotionDetails('jobs')" aria-label="Job Applications database">
        <button class="notion-sync-btn" onclick="event.stopPropagation();quickAddNotion('jobs')" title="Quick add job application" aria-label="Quick add job">+</button>
        <div class="command-count">${stats.jobs.total}</div>
        <div class="command-label">üíº Job Applications</div>
        <div class="command-meta">${stats.jobs.active} active ‚Ä¢ ${stats.jobs.interviewing} interviewing</div>
        <div style="margin-top:.75rem">
          ${(data.jobs || []).slice(0, 3).map(j => `
            <div class="notion-item">
              <span class="notion-status ${getStatusClass(j.status || j.properties?.Status)}"></span>
              <span>${esc(j.name || j.properties?.Name || j.properties?.Company || 'Untitled')}</span>
            </div>
          `).join('') || '<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem 0">No jobs synced yet</div>'}
        </div>
      </div>
      
      <!-- Immigration Documents -->
      <div class="card command-card immigration" role="article" tabindex="0" onclick="showNotionDetails('immigration')" aria-label="Immigration Documents database">
        <button class="notion-sync-btn" onclick="event.stopPropagation();quickAddNotion('immigration')" title="Quick add document" aria-label="Quick add document">+</button>
        <div class="command-count">${stats.immigration.total}</div>
        <div class="command-label">üõÇ Immigration Documents</div>
        <div class="command-meta">${stats.immigration.expiring} expiring ‚Ä¢ ${stats.immigration.submitted} submitted</div>
        <div style="margin-top:.75rem">
          ${(data.immigration || []).slice(0, 3).map(d => `
            <div class="notion-item">
              <span class="notion-status ${getStatusClass(d.status || d.properties?.Status)}"></span>
              <span>${esc(d.name || d.properties?.Name || d.properties?.Document || 'Untitled')}</span>
            </div>
          `).join('') || '<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem 0">No documents synced yet</div>'}
        </div>
      </div>
      
      <!-- Projects & Tasks -->
      <div class="card command-card projects" role="article" tabindex="0" onclick="showNotionDetails('projects')">
        <button class="notion-sync-btn" onclick="event.stopPropagation();quickAddNotion('projects')" title="Quick add project" aria-label="Quick add project">+</button>
        <div class="command-count">${stats.projects.total}</div>
        <div class="command-label">üìÅ Projects & Tasks</div>
        <div class="command-meta">${stats.projects.inProgress} in progress ‚Ä¢ ${stats.projects.backlog} backlog</div>
        <div style="margin-top:.75rem">
          ${(data.projects || []).slice(0, 3).map(p => `
            <div class="notion-item">
              <span class="notion-status ${getStatusClass(p.status || p.properties?.Status)}"></span>
              <span>${esc(p.name || p.properties?.Name || p.properties?.Task || 'Untitled')}</span>
            </div>
          `).join('') || '<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem 0">No projects synced yet</div>'}
        </div>
      </div>
      
      <!-- Content Ideas -->
      <div class="card command-card content" role="article" tabindex="0" onclick="showNotionDetails('content')">
        <button class="notion-sync-btn" onclick="event.stopPropagation();quickAddNotion('content')" title="Quick add content idea" aria-label="Quick add content">+</button>
        <div class="command-count">${stats.content.total}</div>
        <div class="command-label">‚úçÔ∏è Content Ideas</div>
        <div class="command-meta">${stats.content.drafting} drafting ‚Ä¢ ${stats.content.published} published</div>
        <div style="margin-top:.75rem">
          ${(data.content || []).slice(0, 3).map(c => `
            <div class="notion-item">
              <span class="notion-status ${getStatusClass(c.status || c.properties?.Status)}"></span>
              <span>${esc(c.name || c.properties?.Name || c.properties?.Title || 'Untitled')}</span>
            </div>
          `).join('') || '<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem 0">No content synced yet</div>'}
        </div>
      </div>
      
      <!-- Grant Pipeline -->
      <div class="card command-card grants" role="article" tabindex="0" onclick="showNotionDetails('grants')">
        <button class="notion-sync-btn" onclick="event.stopPropagation();quickAddNotion('grants')" title="Quick add grant" aria-label="Quick add grant">+</button>
        <div class="command-count">${stats.grants.total}</div>
        <div class="command-label">üí∞ Grant Pipeline</div>
        <div class="command-meta">${stats.grants.applied} pending ‚Ä¢ ${stats.grants.awarded} awarded</div>
        <div style="margin-top:.75rem">
          ${(data.grants || []).slice(0, 3).map(g => `
            <div class="notion-item">
              <span class="notion-status ${getStatusClass(g.status || g.properties?.Status)}"></span>
              <span>${esc(g.name || g.properties?.Name || g.properties?.Funder || 'Untitled')}</span>
            </div>
          `).join('') || '<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem 0">No grants synced yet</div>'}
        </div>
      </div>
      
      <!-- Policy Development -->
      <div class="card command-card policy" role="article" tabindex="0" onclick="showNotionDetails('policy')">
        <button class="notion-sync-btn" onclick="event.stopPropagation();quickAddNotion('policy')" title="Quick add policy" aria-label="Quick add policy">+</button>
        <div class="command-count">${stats.policy.total}</div>
        <div class="command-label">üìú Policy Development</div>
        <div class="command-meta">${stats.policy.drafting} in drafting</div>
        <div style="margin-top:.75rem">
          ${(data.policy || []).slice(0, 3).map(p => `
            <div class="notion-item">
              <span class="notion-status ${getStatusClass(p.status || p.properties?.Status)}"></span>
              <span>${esc(p.name || p.properties?.Name || p.properties?.Policy || 'Untitled')}</span>
            </div>
          `).join('') || '<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem 0">No policies synced yet</div>'}
        </div>
      </div>
      
      <!-- Action Items -->
      <div class="card command-card actions" role="article" tabindex="0" onclick="showNotionDetails('actions')">
        <button class="notion-sync-btn" onclick="event.stopPropagation();quickAddNotion('actions')" title="Quick add action" aria-label="Quick add action">+</button>
        <div class="command-count">${stats.actions.total}</div>
        <div class="command-label">‚ö° Action Items</div>
        <div class="command-meta">${stats.actions.urgent} urgent ‚Ä¢ ${stats.actions.today} due today</div>
        <div style="margin-top:.75rem">
          ${(data.actions || []).slice(0, 3).map(a => `
            <div class="notion-item">
              <span class="notion-status ${getPriorityClass(a.priority || a.properties?.Priority)}"></span>
              <span>${esc(a.name || a.properties?.Name || a.properties?.Action || 'Untitled')}</span>
            </div>
          `).join('') || '<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem 0">No actions synced yet</div>'}
        </div>
      </div>
      
      <!-- Firebird Summary -->
      <div class="card command-card firebird" role="article" tabindex="0">
        <div style="font-size:2.5rem;margin-bottom:.25rem">üî•</div>
        <div class="command-label">Firebird Summary</div>
        <div class="command-meta">
          ${data.grants?.filter(g => (g.properties?.Project || g.project) === 'Firebird').length || 0} grants ‚Ä¢ 
          ${data.projects?.filter(p => (p.properties?.Project || p.project) === 'Firebird').length || 0} tasks
        </div>
        <div style="margin-top:.75rem;font-size:.8rem;color:var(--text-secondary)">
          ${data.actions?.filter(a => (a.properties?.Project || a.project) === 'Firebird').length || 0} pending actions
        </div>
      </div>
    </div>
    
    <!-- Quick Add Section -->
    <div class="card" style="margin-top:1.5rem">
      <div class="card-header">
        <span class="card-title">‚ö° Quick Add</span>
      </div>
      <div class="quick-add-grid">
        <button class="btn btn-ghost" onclick="quickAddNotion('jobs')">üíº Add Job Application</button>
        <button class="btn btn-ghost" onclick="quickAddNotion('actions')">‚ö° Add Action Item</button>
        <button class="btn btn-ghost" onclick="quickAddNotion('content')">‚úçÔ∏è Add Content Idea</button>
        <button class="btn btn-ghost" onclick="quickAddNotion('projects')">üìÅ Add Project Task</button>
      </div>
    </div>
  `;
}

// Helper function to get status color class
function getStatusClass(status) {
  if (!status) return 'pending';
  const s = status.toString().toLowerCase();
  if (s.includes('done') || s.includes('complete') || s.includes('awarded') || s.includes('published')) return 'done';
  if (s.includes('progress') || s.includes('applied') || s.includes('active')) return 'active';
  if (s.includes('urgent') || s.includes('expir') || s.includes('renewal')) return 'expiring';
  return 'pending';
}

// Helper function to get priority color class
function getPriorityClass(priority) {
  if (!priority) return 'pending';
  const p = priority.toString().toLowerCase();
  if (p.includes('urgent') || p.includes('high')) return 'expiring';
  if (p.includes('normal') || p.includes('medium')) return 'active';
  return 'pending';
}

// Sync all Notion databases
async function syncNotionData() {
  if (notionSyncStatus.syncing) return;
  
  notionSyncStatus.syncing = true;
  notionSyncStatus.error = null;
  renderActiveTab();
  
  const results = {};
  let hasErrors = false;
  
  try {
    // Get API endpoint from settings or use default
    const apiEndpoint = S.get('notion_api_endpoint', NOTION_API_ENDPOINT);
    
    for (const [key, db] of Object.entries(NOTION_DATABASES)) {
      try {
        const response = await fetch(apiEndpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            database_id: db.id,
            page_size: 100
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          console.error(`Error fetching ${key}:`, error);
          hasErrors = true;
          continue;
        }
        
        const data = await response.json();
        results[key] = data.results || [];
      } catch (err) {
        console.error(`Failed to sync ${key}:`, err);
        hasErrors = true;
      }
    }
    
    // Save to cache
    notionCache = {
      data: results,
      timestamp: new Date().toISOString()
    };
    S.set('notionCache', notionCache);
    
    notionSyncStatus.lastSync = new Date().toISOString();
    logAct('üîÑ', 'system', 'Synced Notion databases');
    toast(hasErrors ? 'Sync completed with some errors' : 'Notion sync complete!');
    
  } catch (err) {
    notionSyncStatus.error = err.message;
    toast('Sync failed: ' + err.message, 'error');
    console.error('Notion sync error:', err);
  } finally {
    notionSyncStatus.syncing = false;
    renderActiveTab();
  }
}

// Show Notion database details in slide panel
function showNotionDetails(dbKey) {
  const db = NOTION_DATABASES[dbKey];
  const data = notionCache?.data?.[dbKey] || [];
  
  document.getElementById('slidePanelTitle').textContent = `${db.icon} ${db.name}`;
  document.getElementById('slidePanelContent').innerHTML = `
    <div style="margin-bottom:1rem">
      <span style="font-size:.8rem;color:var(--text-muted)">${data.length} items</span>
      <button class="btn btn-sm btn-primary" style="float:right" onclick="quickAddNotion('${dbKey}')">+ Add New</button>
    </div>
    <div style="max-height:400px;overflow-y:auto">
      ${data.map(item => `
        <div style="padding:.75rem;border-bottom:1px solid var(--border-subtle);cursor:pointer" onclick="window.open('${item.url}', '_blank')">
          <div style="font-weight:500;margin-bottom:.25rem">${esc(item.properties?.Name || item.properties?.Title || 'Untitled')}</div>
          <div style="font-size:.75rem;color:var(--text-muted);display:flex;gap:.5rem;flex-wrap:wrap">
            ${item.properties?.Status ? `<span style="background:rgba(139,92,246,.15);color:var(--accent);padding:.125rem .375rem;border-radius:4px">${esc(item.properties.Status)}</span>` : ''}
            ${item.properties?.Priority ? `<span style="background:rgba(245,158,11,.15);color:var(--warning);padding:.125rem .375rem;border-radius:4px">${esc(item.properties.Priority)}</span>` : ''}
            ${item.properties?.Due || item.properties?.Date ? `<span>üìÖ ${esc(item.properties.Due || item.properties.Date)}</span>` : ''}
          </div>
        </div>
      `).join('') || '<div style="padding:1rem;color:var(--text-muted);text-align:center">No items synced yet</div>'}
    </div>
  `;
  
  document.getElementById('slidePanel').classList.add('open');
  document.getElementById('slideOverlay').classList.add('open');
}

// Quick add modal for Notion
function quickAddNotion(dbKey) {
  const db = NOTION_DATABASES[dbKey];
  const fieldConfigs = {
    jobs: [
      { name: 'Company', placeholder: 'Company name', required: true },
      { name: 'Position', placeholder: 'Job title', required: true },
      { name: 'Status', type: 'select', options: ['Applied', 'Interviewing', 'Offer', 'Rejected'], default: 'Applied' },
      { name: 'URL', placeholder: 'Job posting URL' },
      { name: 'Notes', placeholder: 'Additional notes' }
    ],
    immigration: [
      { name: 'Document', placeholder: 'Document name', required: true },
      { name: 'Status', type: 'select', options: ['Valid', 'Needs Renewal', 'Submitted', 'Approved'], default: 'Valid' },
      { name: 'Expiry Date', type: 'date' },
      { name: 'Notes', placeholder: 'Additional notes' }
    ],
    projects: [
      { name: 'Task', placeholder: 'Task name', required: true },
      { name: 'Project', placeholder: 'Project name' },
      { name: 'Status', type: 'select', options: ['Backlog', 'In Progress', 'Review', 'Done'], default: 'Backlog' },
      { name: 'Due', type: 'date' }
    ],
    content: [
      { name: 'Title', placeholder: 'Content title', required: true },
      { name: 'Status', type: 'select', options: ['Idea', 'Drafting', 'Review', 'Published'], default: 'Idea' },
      { name: 'Platform', placeholder: 'e.g., Blog, Substack, LinkedIn' },
      { name: 'Notes', placeholder: 'Content notes' }
    ],
    grants: [
      { name: 'Funder', placeholder: 'Funding organization', required: true },
      { name: 'Project', placeholder: 'Project name' },
      { name: 'Status', type: 'select', options: ['Researching', 'Drafting', 'Applied', 'Awarded', 'Declined'], default: 'Researching' },
      { name: 'Amount', placeholder: 'Grant amount' },
      { name: 'Deadline', type: 'date' }
    ],
    policy: [
      { name: 'Policy', placeholder: 'Policy name', required: true },
      { name: 'Status', type: 'select', options: ['Researching', 'Drafting', 'Review', 'Published'], default: 'Researching' },
      { name: 'Notes', placeholder: 'Policy notes' }
    ],
    actions: [
      { name: 'Action', placeholder: 'What needs to be done?', required: true },
      { name: 'Project', placeholder: 'Related project' },
      { name: 'Priority', type: 'select', options: ['Low', 'Normal', 'High', 'Urgent'], default: 'Normal' },
      { name: 'Due', type: 'date' }
    ]
  };
  
  const fields = fieldConfigs[dbKey] || [{ name: 'Name', placeholder: 'Item name', required: true }];
  
  openModal(`
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">${db.icon} Add to ${db.name}</h3>
      <button class="modal-close" onclick="closeModal()" aria-label="Close">√ó</button>
    </div>
    ${fields.map(f => {
      if (f.type === 'select') {
        return `
          <label class="modal-label">${f.name}</label>
          <select class="modal-input modal-select" id="notion_${f.name.toLowerCase().replace(/\s/g, '_')}">
            ${f.options.map(opt => `<option value="${opt}" ${opt === f.default ? 'selected' : ''}>${opt}</option>`).join('')}
          </select>
        `;
      } else if (f.type === 'date') {
        return `
          <label class="modal-label">${f.name}</label>
          <input type="date" class="modal-input" id="notion_${f.name.toLowerCase().replace(/\s/g, '_')}" ${f.required ? 'required' : ''}>
        `;
      } else {
        return `
          <input class="modal-input" id="notion_${f.name.toLowerCase().replace(/\s/g, '_')}" placeholder="${f.placeholder}" ${f.required ? 'required' : ''} ${f.name === 'Name' || f.name === 'Title' ? 'autofocus' : ''}>
        `;
      }
    }).join('')}
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="submitNotionAdd('${dbKey}')">Add to Notion</button>
    </div>
  `);
}

// Submit new item to Notion
async function submitNotionAdd(dbKey) {
  const db = NOTION_DATABASES[dbKey];
  const inputs = document.querySelectorAll('[id^="notion_"]');
  const properties = {};
  
  inputs.forEach(input => {
    const key = input.id.replace('notion_', '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    if (input.value.trim()) {
      properties[key] = input.value.trim();
    }
  });
  
  if (Object.keys(properties).length === 0) {
    toast('Please fill in at least one field', 'error');
    return;
  }
  
  closeModal();
  toast('Adding to Notion...');
  
  try {
    const apiEndpoint = S.get('notion_add_endpoint', NOTION_ADD_ENDPOINT);
    
    const response = await fetch(apiEndpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        database_id: db.id,
        properties: properties
      })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to add item');
    }
    
    const result = await response.json();
    logAct('‚ûï', 'system', `Added to ${db.name}`);
    toast('Added to Notion successfully!');
    
    // Refresh data
    await syncNotionData();
    
  } catch (err) {
    console.error('Notion add error:', err);
    toast('Failed to add: ' + err.message, 'error');
  }
}

function openAgentPanel(id) {
  const a = getAgents().find(x=>x.id===id);
  if(!a) return;
  document.getElementById('slidePanelTitle').textContent = '‚ú¶ '+a.name;
  document.getElementById('slidePanelContent').innerHTML = `
    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem">
      <div class="agent-avatar" style="width:56px;height:56px;font-size:1.75rem">${a.avatar}</div>
      <div><h2 style="margin:0;font-size:1.25rem">${esc(a.name)}</h2><p style="color:var(--text-muted);margin:0">${esc(a.role)}</p></div>
    </div>
    <div style="margin-bottom:1.5rem"><h3 class="card-title" style="margin-bottom:.5rem">About</h3><p style="color:var(--text-secondary);font-size:.9rem">${esc(a.description)}</p></div>
    <div style="margin-bottom:1.5rem"><h3 class="card-title" style="margin-bottom:.5rem">Capabilities</h3><ul style="list-style:none">${a.capabilities.map(c=>`<li style="padding:.25rem 0;padding-left:1rem;position:relative;color:var(--text-secondary)"><span style="position:absolute;left:0;color:var(--accent)">‚Üí</span>${esc(c)}</li>`).join('')}</ul></div>
    <div style="margin-bottom:1.5rem"><h3 class="card-title" style="margin-bottom:.5rem">Recent Activity</h3>
      ${a.activityLog.length>0 ? a.activityLog.slice(-5).reverse().map(l=>`<div style="padding:.375rem 0;border-bottom:1px solid var(--border-subtle);font-size:.85rem"><div style="color:var(--text-secondary)">${esc(l.msg)}</div><div style="font-size:.75rem;color:var(--text-muted)">${new Date(l.time).toLocaleString()}</div></div>`).join('') : '<div style="color:var(--text-muted)">No recent activity</div>'}
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="sendAgentTask('${a.id}')">üìã Send Task</button>
  `;
  document.getElementById('slidePanel').classList.add('open');
  document.getElementById('slideOverlay').classList.add('open');
}

function sendAgentTask(id) {
  closeSlidePanel();
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">Send Task</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <textarea class="modal-input textarea" id="agentTaskMsg" placeholder="Describe what you need..." autofocus></textarea>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="submitAgentTask('${id}')">Send</button>
    </div>
  `);
}
function submitAgentTask(id) {
  const msg = document.getElementById('agentTaskMsg').value.trim();
  if(!msg) return;
  const agents = getAgents(); const a = agents.find(x=>x.id===id);
  if(a) {
    a.activityLog.push({msg:'Task: '+msg.slice(0,60), time:new Date().toISOString()});
    a.status='busy'; a.lastActive=new Date().toISOString();
    saveAgents(agents);
  }
  closeModal(); toast('Task sent to '+a.name); logAct('üì®','system','Sent task to '+a.name); renderActiveTab();
}
function addDecision() {
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">Log Decision</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <input class="modal-input" id="decQ" placeholder="Decision question" autofocus>
    <textarea class="modal-input textarea" id="decS" placeholder="Decision summary"></textarea>
    <input class="modal-input" id="decA" placeholder="Agents consulted (comma-separated)">
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="saveDecision()">Save</button>
    </div>
  `);
}
function saveDecision() {
  const q=document.getElementById('decQ').value.trim(), s=document.getElementById('decS').value.trim();
  if(!q||!s) return toast('Fill in all fields','error');
  const agents=document.getElementById('decA').value.split(',').map(a=>a.trim()).filter(Boolean);
  const d=getDecisions(); d.unshift({id:Date.now(),date:new Date().toISOString(),question:q,summary:s,agents});
  saveDecisions(d); closeModal(); toast('Decision logged'); logAct('üìã','system','Logged decision: '+q); renderActiveTab();
}

// ============================================
// MEETINGS
// ============================================
function renderMeetingsTab(el) {
  const meetings = getMeetings();
  const now = new Date();
  const today = [], upcoming = [], past = [];

  meetings.forEach(m => {
    const dt = new Date(m.date+'T'+m.time);
    if(m.date===todayStr()) today.push(m);
    else if(dt < now) past.push(m);
    else upcoming.push(m);
  });

  today.sort((a,b)=>a.time.localeCompare(b.time));
  upcoming.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  past.sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time));

  const renderCard = (m, isToday=false) => {
    const dt = new Date(m.date+'T'+m.time);
    const dateDisplay = isToday ? 'Today' : dt.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    const timeDisplay = dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    const diff = dt - now;
    const countdown = diff<0?'Started':diff<3600000?Math.ceil(diff/60000)+'m':Math.floor(diff/3600000)+'h '+Math.ceil((diff%3600000)/60000)+'m';
    const urgent = diff>0 && diff<3600000;
    const icons = {call:'üìû',zoom:'üíª','in-person':'ü§ù'};

    return `<div class="card meeting-card ${isToday?'today':''}">
      <div class="meeting-card-header" onclick="toggleMtgExpand('${m.id}')">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem">
          <div style="flex:1"><div class="meeting-title">${esc(m.title)}</div>
          <div class="meeting-datetime"><span>${dateDisplay} at ${timeDisplay}</span><span class="meeting-countdown ${urgent?'urgent':''}">${countdown}</span></div></div>
          <div style="display:flex;gap:.25rem" onclick="event.stopPropagation()">
            <button class="btn-icon" onclick="editMeeting('${m.id}')">‚úèÔ∏è</button>
            <button class="btn-icon" onclick="deleteMeeting('${m.id}')" style="color:var(--danger)">‚úï</button>
          </div>
        </div>
        <div class="meeting-meta"><span>${icons[m.type]||'üìÖ'} ${m.type}</span><span>üë• ${esc(m.attendees)}</span></div>
      </div>
      <div class="meeting-expanded" id="mtg-exp-${m.id}">
        ${m.prepNotes?`<div class="meeting-section"><div class="meeting-section-title">üìù Prep</div><p style="color:var(--text-secondary);font-size:.9rem">${esc(m.prepNotes)}</p></div>`:''}
        <div class="meeting-section"><div class="meeting-section-title">üìã Agenda</div>
          ${m.agenda.map(a=>`<div class="agenda-item"><div class="priority-check ${a.done?'done':''}" onclick="toggleMtgAgenda('${m.id}',${a.id})"></div><span class="priority-text ${a.done?'done':''}">${esc(a.text)}</span></div>`).join('')}
          <button class="btn btn-ghost btn-sm" style="margin-top:.5rem" onclick="addMtgAgenda('${m.id}')">+ Agenda item</button>
        </div>
        <div class="meeting-section"><div class="meeting-section-title">üìù Notes</div>
          <textarea class="meeting-notes-area" placeholder="Meeting notes..." onblur="saveMtgNotes('${m.id}',this.value)">${esc(m.notes||'')}</textarea>
        </div>
        <div class="meeting-section"><div class="meeting-section-title">‚úÖ Action Items</div>
          ${(m.actionItems||[]).map((a,i)=>`<div style="display:flex;align-items:center;gap:.5rem;padding:.375rem .5rem;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:6px;margin-bottom:.375rem;font-size:.85rem"><span style="flex:1">${esc(a)}</span><button class="btn-icon" onclick="removeMtgAction('${m.id}',${i})" style="color:var(--danger);font-size:.75rem">‚úï</button></div>`).join('')}
          <div style="display:flex;gap:.5rem;margin-top:.5rem"><input class="modal-input" id="action-${m.id}" placeholder="Add action item..." style="margin:0;flex:1" onkeypress="if(event.key==='Enter')addMtgAction('${m.id}')"><button class="btn btn-sm btn-primary" onclick="addMtgAction('${m.id}')">Add</button></div>
        </div>
      </div>
    </div>`;
  };

  el.innerHTML = `
    <div class="welcome-bar"><h1 class="welcome-title">üìû Rituals</h1><p class="welcome-subtitle">Sacred gatherings</p></div>
    ${today.length?`<div style="margin-bottom:2rem"><div class="card-header"><span class="card-title">üî• Today (${today.length})</span></div><div class="meetings-grid">${today.map(m=>renderCard(m,true)).join('')}</div></div>`:''}
    <div style="margin-bottom:1.5rem"><div class="card-header"><span class="card-title">üåô Upcoming (${upcoming.length})</span><button class="btn btn-sm btn-primary" onclick="addMeeting()" aria-label="Add meeting">+ Add Meeting</button></div>
      ${upcoming.length?`<div class="meetings-grid">${upcoming.map(m=>renderCard(m)).join('')}</div>`:`<div class="card" style="text-align:center;padding:2rem;color:var(--text-muted)">No upcoming meetings</div>`}
    </div>
    ${past.length?`<div class="archive-toggle" onclick="document.getElementById('mtg-archive').classList.toggle('open');this.querySelector('span:first-child').textContent=document.getElementById('mtg-archive').classList.contains('open')?'‚ñº':'‚ñ∂'"><span>‚ñ∂</span><span>Archive (${past.length})</span></div><div class="archive-section" id="mtg-archive"><div class="meetings-grid">${past.map(m=>renderCard(m)).join('')}</div></div>`:''}
  `;
}

function toggleMtgExpand(id) { document.getElementById('mtg-exp-'+id)?.classList.toggle('open') }
function toggleMtgAgenda(mid, aid) {
  const m = getMeetings(); const mt = m.find(x=>x.id===mid); const a = mt?.agenda.find(x=>x.id===aid);
  if(a) { a.done=!a.done; saveMeetingsData(m); renderActiveTab(); }
}
function addMtgAgenda(mid) {
  const text = prompt('Agenda item:'); if(!text) return;
  const m = getMeetings(); const mt = m.find(x=>x.id===mid);
  mt.agenda.push({id:Date.now(),text,done:false}); saveMeetingsData(m); renderActiveTab();
  setTimeout(()=>document.getElementById('mtg-exp-'+mid)?.classList.add('open'),50);
}
function saveMtgNotes(mid,val) { const m=getMeetings(); const mt=m.find(x=>x.id===mid); mt.notes=val; saveMeetingsData(m) }
function addMtgAction(mid) {
  const inp=document.getElementById('action-'+mid); const text=inp?.value.trim(); if(!text) return;
  const m=getMeetings(); const mt=m.find(x=>x.id===mid); mt.actionItems=mt.actionItems||[]; mt.actionItems.push(text); saveMeetingsData(m);
  renderActiveTab(); setTimeout(()=>document.getElementById('mtg-exp-'+mid)?.classList.add('open'),50);
}
function removeMtgAction(mid,idx) {
  const m=getMeetings(); const mt=m.find(x=>x.id===mid); mt.actionItems.splice(idx,1); saveMeetingsData(m);
  renderActiveTab(); setTimeout(()=>document.getElementById('mtg-exp-'+mid)?.classList.add('open'),50);
}
function deleteMeeting(id) { if(!confirm('Delete?')) return; saveMeetingsData(getMeetings().filter(x=>x.id!==id)); renderActiveTab(); toast('Meeting deleted'); logAct('üóëÔ∏è','meeting','Deleted meeting') }
function addMeeting(editId=null) {
  const m = editId ? getMeetings().find(x=>x.id===editId) : null;
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">${m?'Edit':'Add'} Meeting</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <input type="hidden" id="mtgEditId" value="${editId||''}">
    <input class="modal-input" id="mtgTitle" placeholder="Meeting title" value="${m?esc(m.title):''}">
    <div class="modal-row">
      <div><label class="modal-label">Date</label><input type="date" class="modal-input" id="mtgDate" value="${m?m.date:''}"></div>
      <div><label class="modal-label">Time</label><input type="time" class="modal-input" id="mtgTime" value="${m?m.time:''}"></div>
    </div>
    <label class="modal-label">Type</label>
    <select class="modal-input modal-select" id="mtgType"><option value="call" ${m?.type==='call'?'selected':''}>üìû Call</option><option value="zoom" ${m?.type==='zoom'?'selected':''}>üíª Zoom</option><option value="in-person" ${m?.type==='in-person'?'selected':''}>ü§ù In-Person</option></select>
    <input class="modal-input" id="mtgAttendees" placeholder="Attendees" value="${m?esc(m.attendees):''}">
    <textarea class="modal-input textarea" id="mtgPrep" placeholder="Prep notes">${m?esc(m.prepNotes||''):''}</textarea>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="saveMeeting()">Save</button>
    </div>
  `);
}
function editMeeting(id) { addMeeting(id) }
function saveMeeting() {
  const title=document.getElementById('mtgTitle').value.trim();
  const date=document.getElementById('mtgDate').value, time=document.getElementById('mtgTime').value;
  if(!title||!date||!time) return toast('Fill required fields','error');
  const type=document.getElementById('mtgType').value, attendees=document.getElementById('mtgAttendees').value.trim(), prep=document.getElementById('mtgPrep').value.trim();
  const editId=document.getElementById('mtgEditId').value;
  const meetings=getMeetings();
  if(editId) { const m=meetings.find(x=>x.id===editId); Object.assign(m,{title,date,time,type,attendees,prepNotes:prep}); }
  else { meetings.push({id:'m'+Date.now(),title,date,time,type,attendees,prepNotes:prep,agenda:[],notes:'',actionItems:[]}); logAct('üìû','meeting','Added meeting: '+title); }
  saveMeetingsData(meetings); closeModal(); renderActiveTab(); toast(editId?'Meeting updated':'Meeting added');
}

// ============================================
// INTEL
// ============================================
let intelFilters = { category:'all', importance:'all' };
const catLabels = {'ai-news':'ü§ñ AI News','industry':'üìà Industry','competitor':'üëÅ Competitor','opportunities':'üí° Opportunities'};
const impConfig = {hot:{icon:'üî•',label:'Hot'},notable:{icon:'‚ö°',label:'Notable'},reference:{icon:'üìå',label:'Reference'}};

function renderIntelTab(el) {
  const all = getIntel();
  let filtered = all;
  if(intelFilters.category!=='all') filtered=filtered.filter(i=>i.category===intelFilters.category);
  if(intelFilters.importance!=='all') filtered=filtered.filter(i=>i.importance===intelFilters.importance);
  filtered.sort((a,b)=>new Date(b.dateAdded)-new Date(a.dateAdded));

  const brief = [...all].sort((a,b)=>{const p={hot:3,notable:2,reference:1};return(p[b.importance]-p[a.importance])||(new Date(b.dateAdded)-new Date(a.dateAdded))}).slice(0,5);
  const catCount = c => c==='all'?all.length:all.filter(i=>i.category===c).length;

  el.innerHTML = `
    <div class="welcome-bar"><h1 class="welcome-title">üì° Signals</h1><p class="welcome-subtitle">What the universe is whispering</p></div>
    <div class="intel-container">
      <aside class="card intel-sidebar">
        <div class="card-title" style="margin-bottom:.75rem">üéØ Filters</div>
        ${['all','ai-news','industry','competitor','opportunities'].map(c=>`<button class="intel-filter-btn ${intelFilters.category===c?'active':''}" onclick="intelFilters.category='${c}';renderActiveTab()">${c==='all'?'üìÅ All':catLabels[c]}<span class="intel-filter-count">${catCount(c)}</span></button>`).join('')}
        <div style="margin:1rem 0 .5rem;border-top:1px solid var(--border-subtle);padding-top:.75rem"><span class="card-title">Importance</span></div>
        ${['all','hot','notable','reference'].map(i=>`<button class="intel-filter-btn ${intelFilters.importance===i?'active':''}" onclick="intelFilters.importance='${i}';renderActiveTab()">${i==='all'?'üéØ All':(impConfig[i].icon+' '+impConfig[i].label)}</button>`).join('')}
        <button class="btn btn-primary" style="width:100%;margin-top:1rem" onclick="addIntel()">+ Add Intel</button>
      </aside>
      <main style="min-width:0">
        <div style="margin-bottom:2rem"><div class="card-header"><span class="card-title">üì∞ Daily Brief</span></div>
          <div class="intel-grid">${brief.map(i=>renderIntelCard(i)).join('')}</div>
        </div>
        <div><div class="card-header"><span class="card-title">${filtered.length} items</span></div>
          ${filtered.length?`<div class="intel-grid">${filtered.map(i=>renderIntelCard(i)).join('')}</div>`:`<div class="card" style="text-align:center;padding:2rem;color:var(--text-muted)">No intel matches your filters</div>`}
        </div>
      </main>
    </div>
  `;
}

function renderIntelCard(i) {
  const imp=impConfig[i.importance];
  return `<div class="card intel-card ${i.importance}">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem">
      <span style="font-size:.7rem;text-transform:uppercase;letter-spacing:.04em;color:var(--text-muted);background:rgba(255,255,255,.05);padding:.15rem .4rem;border-radius:4px">${catLabels[i.category]||i.category}</span>
      <span class="intel-importance ${i.importance}">${imp.icon} ${imp.label}</span>
    </div>
    <h3 style="font-size:1rem;font-weight:600;margin-bottom:.375rem;line-height:1.4"><a href="${esc(i.source)}" target="_blank" style="color:var(--text-primary);text-decoration:none">${esc(i.title)}</a></h3>
    <p style="color:var(--text-secondary);font-size:.85rem;line-height:1.5;margin-bottom:.75rem">${esc(i.summary)}</p>
    <div style="display:flex;justify-content:space-between;align-items:center;font-size:.75rem;color:var(--text-muted)">
      <span>üìÖ ${timeAgo(i.dateAdded)}</span>
      <div style="display:flex;gap:.375rem"><button class="btn-icon" onclick="editIntel('${i.id}')" style="font-size:.75rem">‚úèÔ∏è</button><button class="btn-icon" onclick="deleteIntel('${i.id}')" style="font-size:.75rem;color:var(--danger)">‚úï</button></div>
    </div>
  </div>`;
}

function addIntel(editId=null) {
  const i = editId ? getIntel().find(x=>x.id===editId) : null;
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">${i?'Edit':'Add'} Intel</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <input type="hidden" id="intelEditId" value="${editId||''}">
    <input class="modal-input" id="intelTitle" placeholder="Title" value="${i?esc(i.title):''}">
    <div class="modal-row">
      <div><label class="modal-label">Category</label><select class="modal-input modal-select" id="intelCat">${Object.entries(catLabels).map(([k,v])=>`<option value="${k}" ${i?.category===k?'selected':''}>${v}</option>`).join('')}</select></div>
      <div><label class="modal-label">Importance</label><select class="modal-input modal-select" id="intelImp">${Object.entries(impConfig).map(([k,v])=>`<option value="${k}" ${i?.importance===k?'selected':''}>${v.icon} ${v.label}</option>`).join('')}</select></div>
    </div>
    <input class="modal-input" id="intelSrc" placeholder="Source URL" value="${i?esc(i.source):''}">
    <textarea class="modal-input textarea" id="intelSum" placeholder="Summary">${i?esc(i.summary):''}</textarea>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="saveIntelItem()">Save</button>
    </div>
  `);
}
function editIntel(id) { addIntel(id) }
function deleteIntel(id) { if(!confirm('Delete?')) return; saveIntelData(getIntel().filter(x=>x.id!==id)); renderActiveTab(); toast('Deleted'); logAct('üóëÔ∏è','intel','Deleted intel') }
function saveIntelItem() {
  const title=document.getElementById('intelTitle').value.trim(), src=document.getElementById('intelSrc').value.trim(), sum=document.getElementById('intelSum').value.trim();
  if(!title||!sum) return toast('Fill required fields','error');
  const cat=document.getElementById('intelCat').value, imp=document.getElementById('intelImp').value, editId=document.getElementById('intelEditId').value;
  const intel=getIntel();
  if(editId) { const i=intel.find(x=>x.id===editId); Object.assign(i,{title,category:cat,importance:imp,source:src,summary:sum}) }
  else { intel.push({id:'i'+Date.now(),title,category:cat,importance:imp,source:src,summary:sum,dateAdded:new Date().toISOString()}); logAct('üì°','intel','Added intel: '+title) }
  saveIntelData(intel); closeModal(); renderActiveTab(); toast(editId?'Updated':'Intel added');
}

// ============================================
// LLM TRACKER
// ============================================
const LLM_MODELS = [
  {id:'kimi-k2.5',name:'Kimi K2.5',provider:'Moonshot',ctx:256000,inCost:0.5,outCost:2,status:'online'},
  {id:'gemini-2.5-flash',name:'Gemini 2.5 Flash',provider:'Google',ctx:1000000,inCost:0.15,outCost:0.6,status:'online'},
  {id:'gemini-3-flash',name:'Gemini 3 Flash',provider:'Google',ctx:128000,inCost:0.075,outCost:0.3,status:'online',cap:10},
  {id:'trinity-large',name:'Trinity Large',provider:'OpenRouter',ctx:128000,inCost:1.5,outCost:3,status:'online'},
  {id:'claude-sonnet-4.6',name:'Claude Sonnet 4.6',provider:'Anthropic',ctx:200000,inCost:3,outCost:15,status:'online',cap:20},
  {id:'step-3.5-flash',name:'Step 3.5 Flash',provider:'Step',ctx:32000,inCost:0.5,outCost:2,status:'online'},
  {id:'minimax-m2.5',name:'MiniMax M2.5',provider:'MiniMax',ctx:8000,inCost:0.3,outCost:1.2,status:'online'}
];
const LLM_BUDGET = 60;

function getLLMData() {
  let d = S.get('llm_data',null);
  if(!d) {
    d = { spend:2.35, logs:[], daily:{}, model:{} };
    // Sample data
    for(let i=0;i<5;i++){
      const m=LLM_MODELS[i%LLM_MODELS.length];
      const ti=500+Math.floor(Math.random()*1000), to=200+Math.floor(Math.random()*500);
      const cost=(ti*m.inCost+to*m.outCost)/1000000;
      const dt=new Date(Date.now()-i*7200000);
      d.logs.push({ts:dt.toISOString(),model:m.name,ti,to,cost});
      const day=dt.toISOString().split('T')[0];
      d.daily[day]=(d.daily[day]||0)+ti+to;
      if(!d.model[m.id])d.model[m.id]={tokens:0,cost:0};
      d.model[m.id].tokens+=ti+to; d.model[m.id].cost+=cost;
    }
    S.set('llm_data',d);
  }
  return d;
}
function saveLLMData(d){S.set('llm_data',d)}

function renderLLMTab(el) {
  const d = getLLMData();
  const remaining = Math.max(0,LLM_BUDGET-d.spend);
  const pctLeft = (remaining/LLM_BUDGET*100);
  const pctSpent = (d.spend/LLM_BUDGET*100);
  const dayNum = new Date().getDate();
  const avgDaily = dayNum>1 ? d.spend/(dayNum-1) : d.spend;
  const estDays = avgDaily>0 ? Math.floor(remaining/avgDaily) : 30;

  // Chart data
  const days = [];
  for(let i=6;i>=0;i--){const dt=new Date();dt.setDate(dt.getDate()-i);const ds=dt.toISOString().split('T')[0];days.push({day:dt.toLocaleDateString('en-US',{weekday:'short'}),tokens:d.daily[ds]||0})}
  const maxT=Math.max(...days.map(x=>x.tokens),500);
  const weekTotal = days.reduce((s,x)=>s+x.tokens,0);

  el.innerHTML = `
    <div class="welcome-bar"><h1 class="welcome-title">ü§ñ LLM Tracker</h1><p class="welcome-subtitle">Monitor your AI constellation</p></div>
    <div style="background:rgba(139,92,246,.1);border:1px solid var(--accent);border-radius:12px;padding:.875rem 1.25rem;margin-bottom:1.5rem;display:flex;align-items:center;justify-content:space-between">
      <span style="font-size:.9rem">üí∞ Monthly Budget</span><span style="font-weight:600;color:var(--accent)">$${d.spend.toFixed(2)} / $${LLM_BUDGET}</span>
    </div>
    <div class="llm-wallet-grid">
      <div class="card" style="position:relative;overflow:hidden"><div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),#ec4899)"></div>
        <div class="metric-label">Credits Left</div><div class="metric-value">$${remaining.toFixed(2)}</div>
        <div class="llm-progress-bg"><div class="llm-progress-fill ${pctLeft<20?'danger':pctLeft<40?'warning':'normal'}" style="width:${pctLeft}%"></div></div>
        <div style="font-size:.8rem;color:var(--text-muted);margin-top:.375rem">${pctLeft.toFixed(0)}% remaining</div>
      </div>
      <div class="card" style="position:relative;overflow:hidden"><div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--warning),#fbbf24)"></div>
        <div class="metric-label">Spent This Month</div><div class="metric-value">$${d.spend.toFixed(2)}</div>
        <div class="llm-progress-bg"><div class="llm-progress-fill ${pctSpent>80?'danger':pctSpent>60?'warning':'normal'}" style="width:${pctSpent}%"></div></div>
        <div style="font-size:.8rem;color:var(--text-muted);margin-top:.375rem">${pctSpent.toFixed(0)}% of budget</div>
      </div>
      <div class="card" style="position:relative;overflow:hidden"><div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--success),#34d399)"></div>
        <div class="metric-label">Est. Days Left</div><div class="metric-value">${estDays}</div>
        <div style="font-size:.85rem;color:var(--text-secondary);margin-top:.5rem">$${avgDaily.toFixed(2)}/day avg</div>
      </div>
    </div>
    <div class="card-header"><span class="card-title">üåê Connected Models</span></div>
    <div class="llm-models-grid">${LLM_MODELS.map(m=>{
      const u=d.model[m.id]||{tokens:0,cost:0};
      return`<div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem">
          <span style="font-weight:600">${m.name}</span>
          <span style="width:8px;height:8px;border-radius:50%;background:var(--success);box-shadow:0 0 8px var(--success)"></span>
        </div>
        <div style="font-size:.8rem;color:var(--text-muted);margin-bottom:.5rem">${m.provider} ¬∑ ${(m.ctx/1000)}k ctx${m.cap?' ¬∑ $'+m.cap+'/mo cap':''}</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;font-size:.8rem">
          <div style="background:rgba(255,255,255,.03);padding:.5rem;border-radius:6px"><div style="color:var(--text-muted);font-size:.7rem">In / 1M</div><div style="font-weight:600;color:var(--text-secondary)">$${m.inCost.toFixed(2)}</div></div>
          <div style="background:rgba(255,255,255,.03);padding:.5rem;border-radius:6px"><div style="color:var(--text-muted);font-size:.7rem">Out / 1M</div><div style="font-weight:600;color:var(--text-secondary)">$${m.outCost.toFixed(2)}</div></div>
        </div>
        <div style="margin-top:.75rem;padding-top:.5rem;border-top:1px solid var(--border-subtle);font-size:.8rem;color:var(--text-secondary)">üíµ $${u.cost.toFixed(4)} ¬∑ ${(u.tokens/1000).toFixed(1)}k tokens</div>
      </div>`;
    }).join('')}</div>
    <div class="card" style="margin-bottom:1.5rem">
      <div class="card-header"><span class="card-title">üìä Token Usage (7 Days)</span><span style="font-size:.8rem;color:var(--text-muted)">${(weekTotal/1000).toFixed(1)}k total</span></div>
      <div class="llm-chart-container">${days.map(x=>`<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:.375rem"><div style="font-size:.75rem;font-weight:600;color:var(--text-secondary)">${(x.tokens/1000).toFixed(0)}k</div><div class="llm-chart-bar" style="height:${Math.max((x.tokens/maxT)*100,4)}%"></div><div style="font-size:.7rem;color:var(--text-muted)">${x.day}</div></div>`).join('')}</div>
    </div>
    <div class="card">
      <div class="card-header"><span class="card-title">üìù Recent Logs</span></div>
      ${d.logs.length?`<div style="overflow-x:auto"><table class="llm-logs-table"><thead><tr><th>Time</th><th>Model</th><th>In</th><th>Out</th><th>Cost</th></tr></thead><tbody>${d.logs.slice(0,20).map(l=>`<tr><td>${new Date(l.ts).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}</td><td>${esc(l.model)}</td><td>${l.ti.toLocaleString()}</td><td>${l.to.toLocaleString()}</td><td>$${l.cost.toFixed(4)}</td></tr>`).join('')}</tbody></table></div>`:`<div style="text-align:center;padding:2rem;color:var(--text-muted)">No usage logs yet</div>`}
    </div>
    <div style="display:flex;gap:.75rem;margin-top:1.5rem;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="resetLLMUsage()">üóëÔ∏è Reset Monthly</button>
      <button class="btn" style="background:rgba(255,255,255,.05);border:1px solid var(--border-subtle);color:var(--text-secondary)" onclick="exportLLMData()">üì§ Export</button>
    </div>
  `;
}

function resetLLMUsage(){if(!confirm('Reset all monthly usage?'))return;S.set('llm_data',{spend:0,logs:[],daily:{},model:{}});renderActiveTab();toast('Usage reset');logAct('üóëÔ∏è','system','Reset LLM usage')}
function exportLLMData(){const d=getLLMData();const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='llm-usage-'+todayStr()+'.json';a.click();toast('Exported')}

// ============================================
// BRAIN TAB - VIEW-ONLY DASHBOARD
// ============================================
let brainConnected = false;
let brainLastPing = null;

function renderBrainTab(el) {
  const apiUrl = S.get('brain_url','');
  const apiKey = S.get('brain_key','');
  
  // Get stats from localStorage
  const sessions = S.get('brain_sessions', 0);
  const commands = S.get('brain_commands', 0);
  const lastActivity = S.get('brain_last_activity', null);
  const brainActivityLog = S.get('brain_activity_log', []);
  
  // Status indicator
  const statusColor = brainConnected ? 'var(--success)' : 'var(--text-muted)';
  const statusText = brainConnected ? 'Online' : 'Offline';
  const pingText = brainLastPing ? timeAgo(brainLastPing) : 'Never';
  
  el.innerHTML = `
    <div class="welcome-bar"><h1 class="welcome-title">üß† Brain</h1><p class="welcome-subtitle">Agent status dashboard ‚Äî view only</p></div>
    <div class="brain-container">
      <div style="display:flex;flex-direction:column;gap:1.25rem">
        <!-- Connection Status Card -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem">
            <div><h3 style="font-size:.95rem;font-weight:600">üîó Agent Status</h3><p style="font-size:.8rem;color:var(--text-muted)">OpenClaw Gateway Connection</p></div>
            <div style="display:flex;align-items:center;gap:.5rem">
              <div class="brain-status-indicator ${brainConnected?'online':'offline'}"></div>
              <span style="font-size:.85rem;color:${statusColor};font-weight:500">${statusText}</span>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:.75rem">
            <div style="background:rgba(255,255,255,.03);padding:.75rem;border-radius:10px">
              <div style="font-size:.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.04em">Last Ping</div>
              <div style="font-size:1.1rem;font-weight:600;color:var(--text-secondary)">${pingText}</div>
            </div>
            <div style="background:rgba(255,255,255,.03);padding:.75rem;border-radius:10px">
              <div style="font-size:.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.04em">Session Count</div>
              <div style="font-size:1.1rem;font-weight:600;color:var(--text-secondary)">${sessions}</div>
            </div>
          </div>
          <div style="display:flex;gap:.5rem">
            <button class="btn btn-primary" style="flex:1" onclick="testBrainConnection()">üîÑ Test Connection</button>
            <button class="btn" style="flex:1;background:rgba(255,255,255,.08);color:var(--text-secondary)" onclick="saveBrainConfig()">üíæ Save Config</button>
          </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="card">
          <div class="card-title" style="margin-bottom:.75rem">üìä Quick Stats</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem">
            <div style="text-align:center;padding:.75rem;background:rgba(255,255,255,.03);border-radius:10px">
              <div style="font-size:1.5rem;font-weight:700;color:var(--accent)">${sessions}</div>
              <div style="font-size:.75rem;color:var(--text-muted)">Sessions</div>
            </div>
            <div style="text-align:center;padding:.75rem;background:rgba(255,255,255,.03);border-radius:10px">
              <div style="font-size:1.5rem;font-weight:700;color:var(--info)">${commands}</div>
              <div style="font-size:.75rem;color:var(--text-muted)">Commands</div>
            </div>
            <div style="text-align:center;padding:.75rem;background:rgba(255,255,255,.03);border-radius:10px">
              <div style="font-size:1.5rem;font-weight:700;color:var(--success)">~${Math.floor(sessions * 12)}</div>
              <div style="font-size:.75rem;color:var(--text-muted)">Est. Memory (MB)</div>
            </div>
          </div>
          ${lastActivity ? `<div style="margin-top:.75rem;padding:.5rem;background:rgba(139,92,246,.08);border-radius:8px;font-size:.8rem;color:var(--text-secondary)">üìÖ Last activity: ${new Date(lastActivity).toLocaleString()}</div>` : ''}
        </div>
        
        <!-- Activity Log (Read-Only) -->
        <div class="card" style="max-height:300px;overflow-y:auto">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
            <div class="card-title">üì° Recent Activity</div>
            <span style="font-size:.75rem;color:var(--text-muted)">${brainActivityLog.length} events</span>
          </div>
          <div id="brainActivityLog">
            ${brainActivityLog.length > 0 ? brainActivityLog.slice(0, 20).map(a => `
              <div class="brain-activity-item">
                <span style="color:var(--text-muted);font-size:.75rem;min-width:50px">${new Date(a.time).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}</span>
                <span>${a.icon}</span>
                <span style="color:var(--text-secondary);flex:1">${esc(a.msg)}</span>
              </div>
            `).join('') : '<div style="padding:1rem;color:var(--text-muted);text-align:center">No activity recorded yet</div>'}
          </div>
        </div>
        
        <!-- API Configuration -->
        <div class="card">
          <div class="card-title" style="margin-bottom:.75rem">‚öôÔ∏è API Configuration</div>
          <div style="margin-bottom:.5rem">
            <label class="modal-label">API URL</label>
            <input class="modal-input" id="brainUrl" placeholder="https://api.yourdomain.com" value="${esc(apiUrl)}" style="margin-bottom:.375rem">
          </div>
          <div>
            <label class="modal-label">API Key</label>
            <input type="password" class="modal-input" id="brainKey" placeholder="sk-..." value="${esc(apiKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '')}">
          </div>
        </div>
      </div>
      
      <div style="display:flex;flex-direction:column;gap:1.25rem">
        <!-- File Browser (Static) -->
        <div class="card" style="max-height:400px;overflow-y:auto">
          <div class="card-title" style="margin-bottom:.5rem">üìÅ File Browser</div>
          <ul style="list-style:none;font-size:.85rem;font-family:'Inter',monospace">
            <li class="brain-file-item" style="font-weight:600">üìÅ workspace/</li>
            <li class="brain-file-item" style="margin-left:1rem">üìù memory/2025-02-20.md</li>
            <li class="brain-file-item" style="margin-left:1rem">üìù memory/2025-02-19.md</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è AGENTS.md</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è USER.md</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è TOOLS.md</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è MEMORY.md</li>
            <li class="brain-file-item" style="font-weight:600">üìÅ .openclaw/</li>
            <li class="brain-file-item" style="margin-left:1rem">üóÑÔ∏è memory.db</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è gateway.yaml</li>
            <li class="brain-file-item" style="margin-left:1rem">üîê secrets.yaml</li>
            <li class="brain-file-item" style="font-weight:600">üìÅ skills/</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è gog/SKILL.md</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è web/SKILL.md</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è search/SKILL.md</li>
            <li class="brain-file-item">üìù README.md</li>
            <li class="brain-file-item">‚öôÔ∏è index.html</li>
          </ul>
        </div>
        
        <!-- Quick Actions (with confirmation) -->
        <div class="card">
          <h3 style="font-size:.85rem;font-weight:600;margin-bottom:.5rem">‚ö° Quick Actions</h3>
          <div style="display:flex;flex-direction:column;gap:.375rem">
            <button class="btn btn-ghost btn-sm" onclick="brainQuickAction('üìä View Status')">üìä View Status</button>
            <button class="btn btn-ghost btn-sm" onclick="brainQuickAction('üí¨ List Sessions')">üí¨ List Sessions</button>
            <button class="btn btn-ghost btn-sm" onclick="brainQuickAction('üõ†Ô∏è Reload Skills')">üõ†Ô∏è Reload Skills</button>
            <button class="btn btn-ghost btn-sm" onclick="brainQuickAction('üíæ Create Backup')">üíæ Create Backup</button>
            <button class="btn btn-ghost btn-sm" onclick="brainQuickAction('üîÑ Check Updates')">üîÑ Check Updates</button>
          </div>
        </div>
        
        <!-- Help Info -->
        <div class="card" style="background:rgba(139,92,246,.08);border-color:rgba(139,92,246,.2)">
          <h3 style="font-size:.85rem;font-weight:600;margin-bottom:.5rem;color:var(--accent)">‚ÑπÔ∏è Dashboard Mode</h3>
          <p style="font-size:.8rem;color:var(--text-secondary);line-height:1.5">This is a read-only view of your agent status. To send commands, use your OpenClaw client directly or configure the API endpoint above.</p>
        </div>
      </div>
    </div>
  `;
}

function saveBrainConfig(){
  const urlInput = document.getElementById('brainUrl')?.value || '';
  const keyInput = document.getElementById('brainKey')?.value || '';
  if(urlInput) S.set('brain_url', urlInput);
  if(keyInput && !keyInput.includes('‚Ä¢')) S.set('brain_key', keyInput);
  toast('Configuration saved');
  logAct('‚öôÔ∏è','system','Brain API configuration updated');
}

async function testBrainConnection(){
  const url = document.getElementById('brainUrl')?.value || S.get('brain_url','');
  if(!url){
    toast('Enter API URL first','error');
    return;
  }
  
  // Simulate connection test (no hardcoded localhost)
  toast('Testing connection...');
  
  try {
    // Only attempt fetch if URL is configured and not localhost
    if(url.includes('localhost') || url.includes('127.0.0.1')){
      throw new Error('Localhost connections disabled in production');
    }
    
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 5000);
    
    const r = await fetch(url + '/status', { 
      method: 'GET',
      signal: controller.signal
    });
    clearTimeout(timeout);
    
    if(r.ok){
      brainConnected = true;
      brainLastPing = new Date().toISOString();
      S.set('brain_last_ping', brainLastPing);
      toast('Connected successfully!');
      addBrainLog('‚úÖ','Connection test successful');
    } else {
      throw new Error('Status ' + r.status);
    }
  } catch(e){
    brainConnected = false;
    toast('Connection failed: ' + e.message,'error');
    addBrainLog('‚ùå','Connection failed: ' + e.message);
  }
  renderActiveTab();
}

function addBrainLog(icon, text){
  const log = S.get('brain_activity_log', []);
  log.unshift({
    icon: icon,
    msg: text,
    time: new Date().toISOString()
  });
  if(log.length > 50) log.pop();
  S.set('brain_activity_log', log);
  renderActiveTab();
}

function brainQuickAction(action){
  // Show confirmation modal instead of executing
  openModal(`
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Confirm Action</h3>
      <button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button>
    </div>
    <p style="color:var(--text-secondary);margin-bottom:1rem">You are about to request: <strong>${esc(action)}</strong></p>
    <p style="color:var(--text-muted);font-size:.85rem;margin-bottom:1rem">This action requires confirmation and will be sent to your OpenClaw agent.</p>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="confirmBrainAction('${esc(action)}')">Confirm</button>
    </div>
  `);
}

function confirmBrainAction(action){
  closeModal();
  addBrainLog('‚ö°', action + ' requested');
  setTimeout(() => {
    addBrainLog('‚úÖ', action + ' acknowledged');
    toast(action + ' acknowledged');
  }, 800);
  logAct('üß†','system','Brain action: ' + action);
}

// ============================================
// TIMELINE
// ============================================
function renderTimelineTab(el) {
  const phases = getTimeline();
  el.innerHTML = `
    <div class="welcome-bar"><h1 class="welcome-title">üåô The Journey</h1><p class="welcome-subtitle">Where you've been, where you're going</p></div>
    <div class="timeline">${phases.map(p => `
      <div class="timeline-phase ${p.status}">
        <div class="timeline-phase-title">‚ú¶ ${esc(p.title)} ${p.status==='current'?'<span style="font-size:.75rem;background:rgba(139,92,246,.2);color:var(--accent);padding:.15rem .5rem;border-radius:6px">NOW</span>':''}</div>
        <div class="timeline-phase-date">${esc(p.date)}</div>
        <div class="timeline-phase-desc">${esc(p.desc)}</div>
        <ul class="timeline-milestones">${p.milestones.map(m => `
          <li class="timeline-milestone">
            <div class="milestone-check ${m.done?'done':''}" onclick="toggleMilestone(${p.id},${m.id})"></div>
            <span style="${m.done?'text-decoration:line-through;color:var(--text-muted)':''}">${esc(m.text)}</span>
          </li>
        `).join('')}</ul>
        <button class="btn btn-ghost btn-sm" style="margin-top:.5rem" onclick="addMilestone(${p.id})">+ Add milestone</button>
      </div>
    `).join('')}</div>
    <button class="btn btn-primary" style="margin-top:1.5rem" onclick="addTimelinePhase()" aria-label="Add phase">+ Add Phase</button>
  `;
}

function toggleMilestone(pid, mid) {
  const t=getTimeline(); const p=t.find(x=>x.id===pid); const m=p?.milestones.find(x=>x.id===mid);
  if(m){m.done=!m.done;saveTimeline(t);logAct(m.done?'‚úÖ':'‚¨ú','task',`${m.done?'Completed':'Unchecked'} milestone: ${m.text}`);renderActiveTab()}
}
function addMilestone(pid) {
  const text=prompt('Milestone:');if(!text)return;
  const t=getTimeline();const p=t.find(x=>x.id===pid);
  p.milestones.push({id:Date.now(),text,done:false});saveTimeline(t);renderActiveTab();toast('Milestone added');
}
function addTimelinePhase() {
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">Add Phase</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <input class="modal-input" id="phaseTitle" placeholder="Phase title">
    <input class="modal-input" id="phaseDate" placeholder="Date range (e.g. 2026+)">
    <textarea class="modal-input textarea" id="phaseDesc" placeholder="Description"></textarea>
    <label class="modal-label">Status</label>
    <select class="modal-input modal-select" id="phaseStatus"><option value="future">Future</option><option value="current">Current</option><option value="completed">Completed</option></select>
    <div class="modal-actions"><button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button><button class="modal-btn modal-btn-primary" onclick="savePhase()">Add</button></div>
  `);
}
function savePhase(){
  const title=document.getElementById('phaseTitle').value.trim();if(!title)return toast('Enter a title','error');
  const t=getTimeline();t.push({id:Date.now(),title,date:document.getElementById('phaseDate').value,desc:document.getElementById('phaseDesc').value,status:document.getElementById('phaseStatus').value,milestones:[]});
  saveTimeline(t);closeModal();renderActiveTab();toast('Phase added');logAct('üåô','system','Added journey phase: '+title);
}

// ============================================
// NOTES
// ============================================
let notesSaveTimer = null;
function renderNotesTab(el) {
  const notes = S.get('notes','');
  const lastSaved = S.get('notes_saved', null);
  const words = notes.trim() ? notes.trim().split(/\s+/).length : 0;

  el.innerHTML = `
    <div class="welcome-bar"><h1 class="welcome-title">üìù Field Notes</h1><p class="welcome-subtitle">Unstructured thoughts, observations, fragments</p></div>
    <div class="card notes-editor">
      <textarea class="notes-textarea" id="notesArea" placeholder="What's on your mind?">${esc(notes)}</textarea>
      <div class="notes-status">
        <span id="notesWordCount">${words} words ¬∑ ${notes.length} chars</span>
        <span id="notesSaveStatus">${lastSaved ? 'Saved '+timeAgo(lastSaved) : 'Not yet saved'}</span>
      </div>
    </div>
  `;

  const ta = document.getElementById('notesArea');
  ta.addEventListener('input', () => {
    const val = ta.value;
    S.set('notes', val);
    const w = val.trim() ? val.trim().split(/\s+/).length : 0;
    document.getElementById('notesWordCount').textContent = `${w} words ¬∑ ${val.length} chars`;
    document.getElementById('notesSaveStatus').textContent = 'Saving...';
    clearTimeout(notesSaveTimer);
    notesSaveTimer = setTimeout(() => {
      S.set('notes_saved', new Date().toISOString());
      document.getElementById('notesSaveStatus').textContent = 'Saved just now';
    }, 500);
  });
}

// ============================================
// INIT
// ============================================
function boot() {
  initNav();
  initSearch();
  renderActiveTab();
  logAct('‚ú¶','system','Pleiades OS awakened');

  // Server status - configurable, no hardcoded localhost
  const serverUrl = S.get('server_url', '');
  if(serverUrl && !serverUrl.includes('localhost') && !serverUrl.includes('127.0.0.1')){
    fetch(serverUrl + '/status').then(r=>r.json()).then(d=>{
      if(d.health==='online'){
        const si=document.getElementById('serverStatus');
        si.classList.remove('offline');si.classList.add('online');
        document.getElementById('serverStatusText').textContent='Connected';
      }
    }).catch(()=>{});
  }

  // Hide loader
  setTimeout(()=>{const l=document.getElementById('loader');if(l){l.style.opacity='0';setTimeout(()=>l.remove(),500)}},600);
}

boot();

// PWA: Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('[PWA] ServiceWorker registered with scope:', registration.scope);
        
        // Handle updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New content available, show update notification
              console.log('[PWA] New content available, refreshing...');
              // Optional: Show a toast notification to the user
              if (typeof toast === 'function') {
                toast('Update available! Refresh to see changes.', 'info');
              }
            }
          });
        });
      })
      .catch(error => {
        console.error('[PWA] ServiceWorker registration failed:', error);
      });
    
    // Listen for messages from service worker
    navigator.serviceWorker.addEventListener('message', event => {
      if (event.data?.type === 'SYNC_COMPLETED') {
        console.log('[PWA] Background sync completed');
      }
    });
  });
}

// PWA: Handle beforeinstallprompt for install button
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  // Prevent the mini-infobar from appearing on mobile
  e.preventDefault();
  // Store the event for later use
  deferredPrompt = e;
  console.log('[PWA] Install prompt available');
});

// PWA: Handle app installed
window.addEventListener('appinstalled', () => {
  console.log('[PWA] Pleiades OS was installed');
  deferredPrompt = null;
  if (typeof toast === 'function') {
    toast('Pleiades OS installed! ‚ú®', 'success');
  }
});

// PWA: Lazy loading for tab content - only render active tab initially
// This is handled by the existing renderActiveTab function
// Additional optimization: IntersectionObserver for heavy elements
if ('IntersectionObserver' in window) {
  const lazyElements = document.querySelectorAll('[data-lazy]');
  const lazyObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('lazy-loaded');
        lazyObserver.unobserve(entry.target);
      }
    });
  }, { rootMargin: '50px' });
  
  lazyElements.forEach(el => lazyObserver.observe(el));
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // ‚åò/Ctrl + K = Focus search
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    document.getElementById('globalSearch')?.focus();
  }

  // ‚åò/Ctrl + N = Add new (context-aware based on active tab)
  if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
    e.preventDefault();
    // Call appropriate add function based on activeTab
    if (activeTab === 'dashboard') addPriority();
    else if (activeTab === 'projects') addTask('backlog');
    else if (activeTab === 'meetings') addMeeting();
    else if (activeTab === 'intel') addIntel();
    else if (activeTab === 'command') quickAddNotion('actions');
    else if (activeTab === 'timeline') addTimelinePhase();
  }

  // 1-9 = Switch to tab 1-9
  if (!e.metaKey && !e.ctrlKey && /^[1-9]$/.test(e.key)) {
    const tabIndex = parseInt(e.key) - 1;
    if (TABS[tabIndex]) switchTab(TABS[tabIndex].id);
  }

  // ? = Show help
  if (e.key === '?' && !e.metaKey && !e.ctrlKey) {
    showKeyboardHelp();
  }

  // Escape = Close modal or unfocus search
  if (e.key === 'Escape') {
    if (document.getElementById('universalModal').classList.contains('open')) {
      closeModal();
    } else if (document.getElementById('globalSearch') === document.activeElement) {
      document.getElementById('globalSearch').blur();
    }
  }
});

function showKeyboardHelp() {
  openModal(`
    <div class="modal-header"><h3 class="modal-title">‚å®Ô∏è Keyboard Shortcuts</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
    <div style="padding:1rem">
      <div style="margin-bottom:.5rem"><kbd style="background:rgba(255,255,255,.1);padding:.25rem .5rem;border-radius:4px">‚åòK</kbd> Focus search</div>
      <div style="margin-bottom:.5rem"><kbd style="background:rgba(255,255,255,.1);padding:.25rem .5rem;border-radius:4px">‚åòN</kbd> Add new item</div>
      <div style="margin-bottom:.5rem"><kbd style="background:rgba(255,255,255,.1);padding:.25rem .5rem;border-radius:4px">1-9</kbd> Switch tabs</div>
      <div style="margin-bottom:.5rem"><kbd style="background:rgba(255,255,255,.1);padding:.25rem .5rem;border-radius:4px">?</kbd> Show this help</div>
      <div><kbd style="background:rgba(255,255,255,.1);padding:.25rem .5rem;border-radius:4px">Esc</kbd> Close modal/unfocus</div>
    </div>
  `);
}
</script>
</body>
</html>
