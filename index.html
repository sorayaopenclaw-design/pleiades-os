<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#F5F0E6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="description" content="Pleiades OS - The Paintress's Garden. Personal command center inspired by Expedition 33 and Studio Ghibli.">
  <meta name="application-name" content="Pleiades OS">
  
  <!-- PWA: Resource Hints for Performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  
  <!-- PWA: Manifest and Icons -->
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon-152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icon-180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/icon-167.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icon-16.png">
  <link rel="mask-icon" href="/icon-mask.svg" color="#D4A84B">
  
  <title>Pleiades OS ‚ú¶ The Paintress's Garden</title>
  
  <!-- Expedition 33 √ó Ghibli Typography -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Source+Serif+4:ital,opsz,wght@0,8..60,400;0,8..60,500;1,8..60,400&family=Jost:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       EXPEDITION 33 √ó STUDIO GHIBLI THEME
       The Paintress's Garden - Light & Warm Aesthetic
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    
    :root {
      /* COLOR PALETTE: Belle √âpoque + Ghibli Pastels */
      --bg-primary: #F5F0E6;
      --bg-card: rgba(255,255,255,0.85);
      --bg-card-hover: rgba(255,255,255,0.95);
      --border-subtle: rgba(212,168,75,0.2);
      --border-light: rgba(212,168,75,0.1);
      
      /* Accent - Lumi√®re Gold */
      --accent: #D4A84B;
      --accent-hover: #C49A3D;
      --accent-glow: rgba(212,168,75,0.3);
      
      /* Secondary - Deep Navy & Warm Neutrals */
      --color-navy: #1A1F2E;
      --color-cream: #FAF8F5;
      --color-warm: #F5F0E6;
      --color-sepia: #9A8874;
      --color-moss: #7A9E7E;
      --color-bloom: #E8A5B4;
      --color-copper: #C97F42;
      
      /* Text Colors */
      --text-primary: #1A1F2E;
      --text-secondary: #4A3F36;
      --text-muted: #7D6B5A;
      --text-light: #9A8874;
      
      /* Status Colors - Softened */
      --success: #6B9080;
      --danger: #C97B7B;
      --warning: #D4A574;
      --info: #5AA3C8;
      
      /* Focus & Effects */
      --focus-ring: 0 0 0 3px rgba(212,168,75,0.4);
      --shadow-soft: 0 4px 20px rgba(45,38,32,0.08);
      --shadow-hover: 0 10px 30px rgba(45,38,32,0.12), 0 0 20px rgba(212,168,75,0.15);
      
      /* Typography */
      --font-display: 'Cinzel', 'Playfair Display', serif;
      --font-heading: 'Cormorant Garamond', 'EB Garamond', serif;
      --font-body: 'Source Serif 4', 'Crimson Text', Georgia, serif;
      --font-ui: 'Jost', 'Montserrat', system-ui, sans-serif;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    .skip-link{position:absolute;top:-40px;left:0;background:var(--accent);color:#fff;padding:8px 16px;z-index:10000;transition:top .3s;text-decoration:none;font-weight:500;border-radius:0 0 4px 0;font-family:var(--font-ui)}
    .skip-link:focus{top:0;outline:none;box-shadow:0 0 0 3px rgba(212,168,75,0.5)}
    body{font-family:var(--font-body);background:linear-gradient(180deg,#E8F4F8 0%,#F5F0E8 50%,#FAF8F5 100%);color:var(--text-primary);min-height:100vh;line-height:1.6}
    *:focus-visible{outline:none;box-shadow:var(--focus-ring)}
    
    /* Warm Sky Gradient Background */
    body::before{content:'';position:fixed;inset:0;background:linear-gradient(180deg,rgba(232,244,248,0.8) 0%,rgba(245,240,232,0.6) 50%,rgba(250,248,245,0.4) 100%);pointer-events:none;z-index:-1}
    
    /* Paper Texture Overlay */
    body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:-1;opacity:0.6}
    
    /* Soft Cloud/Star Effect - Subtle */
    .stars{position:fixed;inset:0;pointer-events:none;z-index:-2;background-image:radial-gradient(2px 2px at 20px 30px,rgba(212,168,75,.15),transparent),radial-gradient(2px 2px at 40px 70px,rgba(212,168,75,.1),transparent),radial-gradient(1px 1px at 90px 40px,rgba(122,158,126,.1),transparent),radial-gradient(2px 2px at 130px 80px,rgba(212,168,75,.08),transparent),radial-gradient(1px 1px at 160px 20px,rgba(122,158,126,.08),transparent),radial-gradient(2px 2px at 200px 50px,rgba(212,168,75,.06),transparent),radial-gradient(1px 1px at 250px 90px,rgba(122,158,126,.06),transparent),radial-gradient(2px 2px at 300px 30px,rgba(212,168,75,.08),transparent),radial-gradient(1px 1px at 350px 70px,rgba(122,158,126,.05),transparent),radial-gradient(2px 2px at 400px 60px,rgba(212,168,75,.06),transparent);background-size:1000px 150px;animation:twinkle 12s ease-in-out infinite}
    @keyframes twinkle{0%,100%{opacity:.8}50%{opacity:.4}}
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar{width:10px;height:10px}
    ::-webkit-scrollbar-track{background:var(--color-warm);border-radius:5px}
    ::-webkit-scrollbar-thumb{background:var(--color-sepia);border-radius:5px;border:2px solid var(--color-warm)}
    ::-webkit-scrollbar-thumb:hover{background:var(--accent)}
    
    /* Selection */
    ::selection{background:rgba(212,168,75,0.3);color:var(--color-navy)}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.1)}}
    @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}
    @keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}

    /* HEADER - Art Nouveau Style */
    .header{position:sticky;top:0;z-index:1000;background:rgba(255,255,255,.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--border-subtle);padding:1rem 2rem;box-shadow:0 2px 20px rgba(45,38,32,0.06)}
    .header::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:0.6}
    .header-content{max-width:1600px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:1rem}
    .logo{display:flex;align-items:center;gap:.75rem;font-weight:600;font-size:1.15rem;flex-shrink:0;font-family:var(--font-display);color:var(--color-navy)}
    .logo-icon{width:34px;height:34px;background:linear-gradient(135deg,var(--accent),#C49A3D);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.9rem;box-shadow:0 4px 15px rgba(212,168,75,0.3);animation:gentle-float 6s ease-in-out infinite}
    @keyframes gentle-float{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-4px) rotate(1deg)}}
    .nav-tabs{display:flex;gap:.25rem;background:rgba(212,168,75,.08);padding:.3rem;border-radius:12px;border:1px solid var(--border-light);overflow-x:auto;flex-shrink:1}
    .nav-tab{padding:.5rem 1rem;border:none;background:transparent;color:var(--text-muted);font-family:var(--font-ui);font-size:.85rem;font-weight:500;border-radius:8px;cursor:pointer;transition:all .3s;white-space:nowrap}
    .nav-tab:hover{color:var(--text-secondary);background:rgba(212,168,75,.1)}
    .nav-tab.active{color:var(--color-navy);background:rgba(212,168,75,.2);box-shadow:0 0 20px rgba(212,168,75,.25)}
    .header-right{display:flex;align-items:center;gap:.75rem;flex-shrink:0}
    .search-wrap{position:relative}
    .search-input{width:180px;padding:.5rem 1rem .5rem 2rem;background:rgba(255,255,255,.7);border:1px solid var(--border-subtle);border-radius:10px;color:var(--text-primary);font-family:var(--font-ui);font-size:.85rem;transition:all .3s}
    .search-input:focus{outline:none;border-color:var(--accent);width:260px;background:rgba(255,255,255,.9);box-shadow:0 0 20px rgba(212,168,75,.15)}
    .search-icon{position:absolute;left:.625rem;top:50%;transform:translateY(-50%);font-size:.75rem;color:var(--text-muted);pointer-events:none}
    .search-results{position:absolute;top:calc(100% + .5rem);right:0;width:360px;max-height:400px;overflow-y:auto;background:rgba(255,255,255,.98);backdrop-filter:blur(20px);border:1px solid var(--border-subtle);border-radius:12px;display:none;z-index:2000;box-shadow:0 20px 60px rgba(45,38,32,.15)}
    .search-results.open{display:block}
    .search-result-item{padding:.75rem 1rem;border-bottom:1px solid var(--border-light);cursor:pointer;transition:background .2s}
    .search-result-item:hover{background:rgba(212,168,75,.1)}
    .search-result-item:last-child{border-bottom:none}
    .search-result-type{font-size:.7rem;text-transform:uppercase;letter-spacing:.05em;color:var(--accent);margin-bottom:.25rem;font-family:var(--font-ui)}
    .search-result-title{font-size:.9rem;font-weight:500;font-family:var(--font-body)}
    .search-result-desc{font-size:.8rem;color:var(--text-muted);margin-top:.125rem}
    .search-empty{padding:1.5rem;text-align:center;color:var(--text-muted);font-size:.9rem}
    .status-indicator{display:flex;align-items:center;gap:.5rem;padding:.4rem .75rem;border-radius:10px;font-size:.8rem;font-weight:500;transition:all .3s;font-family:var(--font-ui)}
    .status-indicator.online{background:rgba(107,144,128,.12);border:1px solid rgba(107,144,128,.25);color:var(--success)}
    .status-indicator.offline{background:rgba(201,123,123,.1);border:1px solid rgba(201,123,123,.2);color:var(--text-muted)}
    .status-dot{width:8px;height:8px;border-radius:50%}
    .status-indicator.online .status-dot{background:var(--success);animation:pulse 2s infinite}
    .status-indicator.offline .status-dot{background:var(--text-muted)}

    /* MAIN */
    .main-content{max-width:1600px;margin:0 auto;padding:2rem}
    .tab-content{display:none;animation:fadeInUp .4s ease}
    .tab-content.active{display:block}
    .welcome-bar{margin-bottom:2rem}
    .welcome-title{font-size:2rem;font-weight:600;margin-bottom:.5rem;font-family:var(--font-display);color:var(--color-navy);letter-spacing:-0.02em}
    .welcome-title span{background:linear-gradient(135deg,var(--accent),#C49A3D);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .welcome-subtitle{color:var(--text-secondary);font-size:1rem;font-family:var(--font-body);font-style:italic}

    /* CARDS - Organic Corners & Gold Flourish */
    .card{background:var(--bg-card);backdrop-filter:blur(20px);border:1px solid var(--border-subtle);border-radius:1.5rem 1.25rem 1.75rem 1.375rem;padding:1.25rem;transition:all .3s ease;position:relative;overflow:hidden;box-shadow:var(--shadow-soft)}
    .card:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover)}
    .card::after{content:'';position:absolute;top:1rem;right:1rem;width:20px;height:20px;border-top:2px solid var(--accent);border-right:2px solid var(--accent);border-radius:0 6px 0 0;opacity:0.4;transition:opacity .3s}
    .card:hover::after{opacity:0.8}
    .card:hover{border-color:rgba(255,255,255,.1)}
    .card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
    .card-title{font-size:.85rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;font-weight:500}

    /* METRICS */
    .metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1.25rem;margin-bottom:2rem}
    .metric-card{position:relative;overflow:hidden}
    .metric-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:16px 16px 0 0}
    .metric-card:nth-child(1)::before{background:linear-gradient(90deg,var(--accent),#ec4899)}
    .metric-card:nth-child(2)::before{background:linear-gradient(90deg,var(--info),#6366f1)}
    .metric-card:nth-child(3)::before{background:linear-gradient(90deg,var(--warning),#f97316)}
    .metric-card:nth-child(4)::before{background:linear-gradient(90deg,var(--success),#34d399)}
    .metric-card:hover{transform:translateY(-2px);box-shadow:0 10px 40px rgba(0,0,0,.3)}
    .metric-label{font-size:.8rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:.375rem}
    .metric-value{font-size:2.25rem;font-weight:700}
    .metric-sub{font-size:.8rem;color:var(--text-muted);margin-top:.25rem}

    /* DASHBOARD GRID */
    .dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem}
    .dash-full{grid-column:1/-1}

    /* PRIORITIES */
    .priority-item{display:flex;align-items:center;gap:.75rem;padding:.75rem;border-radius:10px;transition:all .2s;border-bottom:1px solid var(--border-subtle)}
    .priority-item:last-child{border-bottom:none}
    .priority-item:hover{background:rgba(255,255,255,.03)}
    .priority-check{width:20px;height:20px;border:2px solid var(--border-subtle);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
    .priority-check:hover{border-color:var(--accent)}
    .priority-check.done{background:var(--accent);border-color:var(--accent)}
    .priority-check.done::after{content:'‚úì';color:#fff;font-size:.75rem}
    .priority-text{flex:1;font-size:.9rem;transition:all .2s}
    .priority-text.done{text-decoration:line-through;color:var(--text-muted)}
    .priority-delete{opacity:0;background:none;border:none;color:var(--danger);cursor:pointer;font-size:.85rem;padding:.25rem;transition:opacity .2s}
    .priority-item:hover .priority-delete{opacity:1}
    .priority-tag{font-size:.65rem;padding:.15rem .5rem;border-radius:6px;font-weight:600;text-transform:uppercase;flex-shrink:0}
    .priority-tag.urgent{background:rgba(239,68,68,.15);color:var(--danger)}
    .priority-tag.important{background:rgba(245,158,11,.15);color:var(--warning)}
    .priority-tag.normal{background:rgba(59,130,246,.15);color:var(--info)}

    /* ACTIVITY FEED */
    .feed-item{display:flex;gap:.75rem;padding:.625rem 0;border-bottom:1px solid var(--border-subtle);font-size:.85rem}
    .feed-item:last-child{border-bottom:none}
    .feed-icon{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.8rem;flex-shrink:0}
    .feed-icon.task{background:rgba(139,92,246,.15)}
    .feed-icon.note{background:rgba(16,185,129,.15)}
    .feed-icon.meeting{background:rgba(59,130,246,.15)}
    .feed-icon.intel{background:rgba(245,158,11,.15)}
    .feed-icon.system{background:rgba(255,255,255,.05)}
    .feed-text{flex:1;color:var(--text-secondary)}
    .feed-time{color:var(--text-muted);font-size:.75rem;flex-shrink:0}

    /* KANBAN */
    .kanban-board{display:grid;grid-template-columns:repeat(3,1fr);gap:1.25rem}
    .kanban-column{min-height:400px}
    .kanban-column-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;padding-bottom:.75rem;border-bottom:1px solid var(--border-subtle)}
    .kanban-count{background:rgba(255,255,255,.08);padding:.125rem .5rem;border-radius:8px;font-size:.8rem;color:var(--text-muted)}
    .task-card{background:rgba(255,255,255,.03);border:1px solid var(--border-subtle);border-radius:12px;padding:1rem;margin-bottom:.75rem;transition:all .3s;cursor:grab;position:relative}
    .task-card:hover{border-color:rgba(255,255,255,.12);transform:translateY(-1px)}
    .task-card.dragging{opacity:.5;transform:rotate(2deg)}
    .task-card-title{font-weight:600;font-size:.95rem;margin-bottom:.25rem}
    .task-card-desc{color:var(--text-muted);font-size:.8rem;margin-bottom:.5rem}
    .task-card-footer{display:flex;align-items:center;justify-content:space-between}
    .task-card-actions{display:flex;gap:.25rem;opacity:0;transition:opacity .2s}
    .task-card:hover .task-card-actions{opacity:1}
    .task-action-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:.25rem;font-size:.8rem;border-radius:4px;transition:all .2s}
    .task-action-btn:hover{color:var(--text-primary);background:rgba(255,255,255,.05)}
    .task-action-btn.delete:hover{color:var(--danger)}
    .task-priority{font-size:.7rem;font-weight:600;text-transform:uppercase;padding:.2rem .5rem;border-radius:6px;display:inline-block}
    .task-priority.high{background:rgba(239,68,68,.15);color:var(--danger)}
    .task-priority.medium{background:rgba(245,158,11,.15);color:#f59e0b}
    .task-priority.low{background:rgba(16,185,129,.15);color:var(--success)}
    .drop-zone{min-height:60px;border:2px dashed transparent;border-radius:12px;transition:all .3s;padding:.25rem}
    .drop-zone.over{border-color:var(--accent);background:rgba(139,92,246,.05)}

    /* BUTTONS */
    .btn{padding:.625rem 1.25rem;border:none;border-radius:10px;font-family:inherit;font-size:.85rem;font-weight:500;cursor:pointer;transition:all .3s;display:inline-flex;align-items:center;gap:.5rem}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-primary:hover{background:var(--accent-hover);box-shadow:0 0 20px rgba(139,92,246,.4)}
    .btn-ghost{background:rgba(255,255,255,.03);border:1px dashed rgba(255,255,255,.2);color:var(--text-muted);width:100%}
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
    .btn-sm{padding:.4rem .75rem;font-size:.8rem}
    .btn-icon{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:.375rem;border-radius:6px;transition:all .2s;font-size:.9rem}
    .btn-icon:hover{color:var(--text-primary);background:rgba(255,255,255,.05)}

    /* TIMELINE */
    .timeline{position:relative;padding-left:2rem}
    .timeline::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:linear-gradient(180deg,var(--accent),rgba(139,92,246,.2),transparent)}
    .timeline-phase{position:relative;margin-bottom:2rem;padding-left:2rem}
    .timeline-phase::before{content:'';position:absolute;left:-2rem;top:.5rem;width:14px;height:14px;background:var(--accent);border-radius:50%;border:3px solid var(--bg-primary);transition:all .3s}
    .timeline-phase.current::before{box-shadow:0 0 15px var(--accent);background:#ec4899}
    .timeline-phase.completed::before{background:var(--success)}
    .timeline-phase-title{font-size:1.1rem;font-weight:600;margin-bottom:.25rem;display:flex;align-items:center;gap:.5rem}
    .timeline-phase-date{font-size:.8rem;color:var(--accent);margin-bottom:.375rem}
    .timeline-phase-desc{color:var(--text-secondary);font-size:.9rem;margin-bottom:.75rem}
    .timeline-milestones{list-style:none}
    .timeline-milestone{display:flex;align-items:center;gap:.5rem;padding:.375rem 0;font-size:.85rem;color:var(--text-secondary)}
    .milestone-check{width:16px;height:16px;border:2px solid var(--border-subtle);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
    .milestone-check.done{background:var(--success);border-color:var(--success)}
    .milestone-check.done::after{content:'‚úì';color:#fff;font-size:.65rem}

    /* NOTES */
    .notes-editor{position:relative}
    .notes-textarea{width:100%;min-height:500px;background:transparent;border:none;color:var(--text-primary);font-family:'Inter',monospace;font-size:.95rem;line-height:1.8;resize:vertical;outline:none;padding:1.5rem}
    .notes-status{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1.25rem;border-top:1px solid var(--border-subtle);font-size:.8rem;color:var(--text-muted)}

    /* AGENTS */
    .agents-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.25rem;margin-bottom:2.5rem}
    .agent-card{cursor:pointer;position:relative;overflow:hidden}
    .agent-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),#ec4899);opacity:0;transition:opacity .3s}
    .agent-card:hover::before{opacity:1}
    .agent-card:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 10px 40px rgba(139,92,246,.15)}
    .agent-header{display:flex;align-items:flex-start;gap:1rem;margin-bottom:.75rem}
    .agent-avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#ec4899);display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0}
    .agent-name{font-size:1rem;font-weight:600;margin-bottom:.125rem}
    .agent-role{font-size:.8rem;color:var(--text-muted)}
    .agent-status{display:flex;align-items:center;gap:.375rem;font-size:.75rem;font-weight:500;margin-top:.375rem}
    .agent-status-dot{width:7px;height:7px;border-radius:50%}
    .agent-status.online .agent-status-dot{background:var(--success)}
    .agent-status.online{color:var(--success)}
    .agent-status.busy .agent-status-dot{background:var(--warning)}
    .agent-status.busy{color:var(--warning)}
    .agent-status.offline .agent-status-dot{background:var(--text-muted)}
    .agent-status.offline{color:var(--text-muted)}
    .agent-meta{display:flex;gap:1rem;margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--border-subtle);font-size:.8rem;color:var(--text-muted)}
    .agent-model{color:var(--accent);font-weight:500}

    /* MEETINGS */
    .meetings-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem}
    .meeting-card{overflow:hidden;position:relative}
    .meeting-card.today{border-color:rgba(139,92,246,.3);box-shadow:0 0 25px rgba(139,92,246,.1)}
    .meeting-card-header{padding:1.25rem;cursor:pointer}
    .meeting-title{font-size:1.05rem;font-weight:600;margin-bottom:.25rem}
    .meeting-datetime{font-size:.85rem;color:var(--text-secondary);margin-bottom:.5rem;display:flex;align-items:center;gap:.5rem}
    .meeting-countdown{background:rgba(139,92,246,.15);color:var(--accent);padding:.25rem .625rem;border-radius:6px;font-size:.75rem;font-weight:500}
    .meeting-countdown.urgent{background:rgba(245,158,11,.15);color:var(--warning);animation:pulse 2s infinite}
    .meeting-meta{display:flex;gap:1rem;font-size:.8rem;color:var(--text-muted)}
    .meeting-expanded{border-top:1px solid var(--border-subtle);padding:1.25rem;display:none}
    .meeting-expanded.open{display:block}
    .meeting-section{margin-bottom:1.25rem}
    .meeting-section:last-child{margin-bottom:0}
    .meeting-section-title{font-size:.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.5rem}
    .agenda-item{display:flex;align-items:center;gap:.625rem;padding:.375rem 0}
    .meeting-notes-area{width:100%;min-height:80px;padding:.75rem;background:rgba(255,255,255,.03);border:1px solid var(--border-subtle);border-radius:8px;color:var(--text-primary);font-family:inherit;font-size:.9rem;resize:vertical;outline:none}
    .meeting-notes-area:focus{border-color:var(--accent)}

    /* INTEL */
    .intel-container{display:grid;grid-template-columns:250px 1fr;gap:1.5rem}
    .intel-sidebar{height:fit-content;position:sticky;top:100px}
    .intel-filter-btn{width:100%;padding:.5rem .75rem;background:rgba(255,255,255,.03);border:1px solid var(--border-subtle);border-radius:8px;color:var(--text-secondary);font-family:inherit;font-size:.85rem;cursor:pointer;transition:all .2s;margin-bottom:.375rem;text-align:left;display:flex;align-items:center;gap:.5rem}
    .intel-filter-btn:hover{background:rgba(255,255,255,.06)}
    .intel-filter-btn.active{background:rgba(139,92,246,.15);border-color:var(--accent);color:var(--text-primary)}
    .intel-filter-count{margin-left:auto;background:rgba(255,255,255,.1);padding:.1rem .4rem;border-radius:6px;font-size:.7rem}
    .intel-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1rem}
    .intel-card{position:relative}
    .intel-card.hot{border-left:3px solid #ef4444}
    .intel-card.notable{border-left:3px solid #f59e0b}
    .intel-card.reference{border-left:3px solid #3b82f6}
    .intel-card:hover{border-color:var(--accent);transform:translateY(-2px)}
    .intel-importance{font-size:.7rem;font-weight:600;padding:.2rem .5rem;border-radius:6px;display:flex;align-items:center;gap:.25rem}
    .intel-importance.hot{background:rgba(239,68,68,.15);color:#ef4444}
    .intel-importance.notable{background:rgba(245,158,11,.15);color:#f59e0b}
    .intel-importance.reference{background:rgba(59,130,246,.15);color:#3b82f6}

    /* LLM TRACKER */
    .llm-wallet-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.25rem;margin-bottom:2rem}
    .llm-progress-bg{background:rgba(255,255,255,.05);border-radius:9999px;height:8px;overflow:hidden;margin-top:.5rem}
    .llm-progress-fill{height:100%;border-radius:9999px;transition:width .5s}
    .llm-progress-fill.normal{background:linear-gradient(90deg,var(--accent),#ec4899)}
    .llm-progress-fill.warning{background:linear-gradient(90deg,var(--warning),#fbbf24)}
    .llm-progress-fill.danger{background:linear-gradient(90deg,var(--danger),#f87171)}
    .llm-models-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.25rem;margin-bottom:2rem}
    .llm-chart-container{display:flex;align-items:flex-end;justify-content:space-between;height:180px;gap:.5rem;padding:1rem 0}
    .llm-chart-bar{width:100%;background:linear-gradient(180deg,var(--accent),rgba(139,92,246,.3));border-radius:6px 6px 0 0;transition:height .5s;min-height:4px}
    .llm-logs-table{width:100%;border-collapse:collapse;font-size:.85rem}
    .llm-logs-table th{text-align:left;padding:.625rem;color:var(--text-muted);font-weight:500;border-bottom:1px solid var(--border-subtle);font-size:.75rem;text-transform:uppercase;letter-spacing:.04em}
    .llm-logs-table td{padding:.625rem;border-bottom:1px solid var(--border-subtle);color:var(--text-secondary)}
    .llm-logs-table tr:hover td{background:rgba(255,255,255,.02)}

    /* BRAIN */
    .brain-container{display:grid;grid-template-columns:1fr 320px;gap:1.5rem}
    .brain-chat-container{display:flex;flex-direction:column;height:460px}
    .brain-chat-messages{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.75rem}
    .brain-chat-message{max-width:80%;padding:.75rem 1rem;border-radius:12px;font-size:.9rem;line-height:1.5}
    .brain-chat-message.user{align-self:flex-end;background:var(--accent);color:#fff;border-bottom-right-radius:4px}
    .brain-chat-message.agent{align-self:flex-start;background:rgba(255,255,255,.08);border:1px solid var(--border-subtle);border-bottom-left-radius:4px}
    .brain-chat-message.streaming::after{content:'‚ñã';animation:blink 1s infinite;margin-left:.25rem}
    .brain-chat-input-area{padding:.75rem;border-top:1px solid var(--border-subtle);display:flex;gap:.5rem}
    .brain-status-indicator{width:10px;height:10px;border-radius:50%}
    .brain-status-indicator.online{background:var(--success);box-shadow:0 0 10px var(--success);animation:pulse 2s infinite}
    .brain-status-indicator.offline{background:var(--danger);box-shadow:none;animation:none}
    .brain-status-indicator.connecting{background:var(--warning);box-shadow:0 0 10px var(--warning)}
    .brain-file-item{padding:.375rem 0;cursor:pointer;display:flex;align-items:center;gap:.5rem;color:var(--text-secondary);transition:color .2s;font-size:.85rem}
    .brain-file-item:hover{color:var(--accent)}
    .brain-activity-item{padding:.5rem 0;border-bottom:1px solid var(--border-subtle);font-size:.8rem;display:flex;align-items:flex-start;gap:.5rem}
    .brain-activity-item:last-child{border-bottom:none}

    /* DECISIONS */
    .decision-card{margin-bottom:.75rem}
    .decision-date{font-size:.75rem;color:var(--accent);margin-bottom:.375rem}
    .decision-question{font-weight:600;margin-bottom:.375rem;font-size:.95rem}
    .decision-summary{color:var(--text-secondary);font-size:.85rem;margin-bottom:.5rem}
    .decision-agents{display:flex;gap:.375rem;flex-wrap:wrap}
    .decision-agent-tag{background:rgba(139,92,246,.1);color:var(--accent);padding:.15rem .5rem;border-radius:9999px;font-size:.7rem}

    /* MODALS */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(5px);z-index:3000;opacity:0;visibility:hidden;transition:all .3s;display:flex;align-items:center;justify-content:center}
    .modal-overlay.open{opacity:1;visibility:visible}
    .modal{background:var(--bg-primary);border:1px solid var(--border-subtle);border-radius:16px;padding:1.5rem;width:90%;max-width:500px;transform:scale(.95);transition:transform .3s}
    .modal-overlay.open .modal{transform:scale(1)}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem}
    .modal-title{font-size:1.15rem;font-weight:600}
    .modal-close{background:none;border:none;color:var(--text-muted);font-size:1.5rem;cursor:pointer;padding:0;line-height:1}
    .modal-input{width:100%;padding:.75rem 1rem;background:rgba(255,255,255,.05);border:1px solid var(--border-subtle);border-radius:10px;color:var(--text-primary);font-family:inherit;font-size:.9rem;outline:none;margin-bottom:.75rem}
    .modal-input:focus{border-color:var(--accent)}
    .modal-input.textarea{min-height:120px;resize:vertical}
    .modal-select{appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.5)' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .75rem center}
    .modal-label{display:block;font-size:.8rem;color:var(--text-muted);margin-bottom:.375rem}
    .modal-row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    .modal-actions{display:flex;gap:.75rem;margin-top:.5rem}
    .modal-btn{flex:1;padding:.75rem;border-radius:10px;font-family:inherit;font-size:.9rem;font-weight:500;cursor:pointer;border:none;transition:all .2s}
    .modal-btn-primary{background:var(--accent);color:#fff}
    .modal-btn-primary:hover{background:var(--accent-hover)}
    .modal-btn-secondary{background:rgba(255,255,255,.08);color:var(--text-secondary)}
    .modal-btn-secondary:hover{background:rgba(255,255,255,.12)}

    /* SLIDE PANEL */
    .slide-panel-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1999;opacity:0;visibility:hidden;transition:all .3s}
    .slide-panel-overlay.open{opacity:1;visibility:visible}
    .slide-panel{position:fixed;top:0;right:-440px;width:440px;height:100vh;background:var(--bg-primary);border-left:1px solid var(--border-subtle);z-index:2000;transition:right .3s;overflow-y:auto;box-shadow:-10px 0 40px rgba(0,0,0,.5)}
    .slide-panel.open{right:0}

    /* TOAST */
    .toast{position:fixed;bottom:2rem;right:2rem;padding:.875rem 1.25rem;background:rgba(10,10,15,.95);backdrop-filter:blur(20px);border:1px solid var(--border-subtle);border-radius:12px;font-size:.85rem;transform:translateY(100px);opacity:0;transition:all .3s;z-index:4000}
    .toast.show{transform:translateY(0);opacity:1}
    .toast.success{border-left:3px solid var(--success)}
    .toast.error{border-left:3px solid var(--danger)}

    /* ARCHIVE */
    .archive-toggle{display:flex;align-items:center;gap:.5rem;color:var(--text-muted);cursor:pointer;font-size:.85rem;margin-top:1.5rem;padding:.625rem;border-radius:8px;transition:all .2s}
    .archive-toggle:hover{background:rgba(255,255,255,.05);color:var(--text-secondary)}
    .archive-section{display:none}
    .archive-section.open{display:block;margin-top:1rem}

    /* COMMAND CENTER - Constellation & Notion */
    .command-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.25rem;margin-bottom:2rem}
    .command-card{cursor:pointer;transition:all .3s ease}
    .command-card:hover{transform:translateY(-3px);box-shadow:var(--shadow-hover);border-color:var(--accent)}
    .command-card.jobs:hover{border-color:var(--info)}
    .command-card.immigration:hover{border-color:var(--warning)}
    .command-card.projects:hover{border-color:var(--success)}
    .command-card.content:hover{border-color:var(--danger)}
    .command-card.grants:hover{border-color:var(--accent)}
    .command-card.policy:hover{border-color:var(--color-sepia)}
    .command-card.actions:hover{border-color:#ec4899}
    .command-count{font-size:2.5rem;font-weight:700;color:var(--accent);margin-bottom:.25rem}
    .command-label{font-size:.9rem;font-weight:600;color:var(--text-primary);margin-bottom:.25rem}
    .command-meta{font-size:.75rem;color:var(--text-muted)}
    .notion-item{display:flex;align-items:center;gap:.5rem;padding:.375rem 0;font-size:.8rem;color:var(--text-secondary);border-bottom:1px solid var(--border-subtle)}
    .notion-item:last-child{border-bottom:none}
    .notion-status{width:8px;height:8px;border-radius:50%;display:inline-block}
    .notion-status.active{background:var(--success)}
    .notion-status.pending{background:var(--warning)}
    .notion-status.done{background:var(--text-muted)}
    .notion-status.high{background:var(--danger)}
    .notion-status.medium{background:var(--warning)}
    .notion-status.low{background:var(--success)}
    .notion-sync-btn{position:absolute;top:.75rem;right:.75rem;width:24px;height:24px;border-radius:6px;border:1px solid var(--border-subtle);background:rgba(255,255,255,.5);color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;transition:all .2s}
    .notion-sync-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
    .quick-add-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.75rem}
    .constellation-node{cursor:pointer;transition:all .2s}
    .constellation-node:hover{filter:brightness(1.2)}
    .constellation-node circle{transition:all .3s ease}
    .constellation-node:hover circle{r:25}

    /* RESPONSIVE */
    @media(max-width:1024px){.intel-container{grid-template-columns:1fr}.intel-sidebar{position:static}.brain-container{grid-template-columns:1fr}}
    @media(max-width:768px){
      .header{padding:.75rem 1rem}
      .header-content{flex-wrap:wrap;gap:.5rem}
      .nav-tabs{order:3;width:100%;padding:.25rem;gap:.125rem}
      .nav-tab{padding:.4rem .625rem;font-size:.75rem}
      .header-right{order:2;gap:.5rem}
      .search-input{width:120px;font-size:.8rem}
      .search-input:focus{width:160px}
      .main-content{padding:1rem}
      .welcome-title{font-size:1.35rem}
      .metrics-grid{grid-template-columns:repeat(2,1fr);gap:.75rem}
      .metric-value{font-size:1.75rem}
      .dash-grid{grid-template-columns:1fr}
      .kanban-board{grid-template-columns:1fr}
      .agents-grid,.meetings-grid,.intel-grid,.llm-models-grid{grid-template-columns:1fr}
      .slide-panel{width:100%;right:-100%}
      .modal{margin:1rem}
      .search-results{width:calc(100vw - 2rem);right:-1rem}
    }
    @media(max-width:480px){.metrics-grid{grid-template-columns:1fr}.nav-tab{padding:.375rem .5rem;font-size:.7rem}}
    
    /* Mobile Touch Improvements */
    @media(max-width:768px){
      .btn,.nav-tab,.priority-check,.task-action-btn,.btn-icon{
        min-height:44px;
        min-width:44px;
      }
      .priority-item{padding:.875rem .75rem}
      .task-card{padding:1rem}
      .card{padding:1rem}
      .agent-card{padding:1rem}
      .meeting-card{padding:1rem}
      .command-card{padding:1rem}
      input,select,textarea{font-size:16px}
      .modal-input{font-size:16px}
      #paletteInput{font-size:16px}
      .constellation-node{cursor:default}
      .constellation-node:active{opacity:0.8}
    }
    
    /* Prevent text zoom on iOS */
    @supports(-webkit-touch-callout:none){
      input,select,textarea{font-size:16px !important}
    }
    
    /* Safe area for notched devices */
    @supports(padding:max(0px)){
      .header{padding-left:max(1rem,env(safe-area-inset-left));padding-right:max(1rem,env(safe-area-inset-right))}
      .main-content{padding-left:max(1rem,env(safe-area-inset-left));padding-right:max(1rem,env(safe-area-inset-right));padding-bottom:max(1rem,env(safe-area-inset-bottom))}
    }
  </style>
</head>
<body>
  <!-- Skip Link for Accessibility -->
  <a href="#mainContent" class="skip-link" aria-label="Skip to main content">Skip to main content</a>
  
  <!-- Screen Reader Announcer -->
  <div id="sr-announcer" role="status" aria-live="polite" aria-atomic="true" style="position:absolute;left:-10000px;width:1px;height:1px;overflow:hidden;"></div>
  <div class="stars" role="presentation" aria-hidden="true"></div>

  <!-- Loader -->
  <div id="loader" style="position:fixed;inset:0;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;z-index:10000;transition:opacity .5s" role="status" aria-label="Loading Pleiades OS">
    <div style="text-align:center">
      <div style="font-size:3.5rem;animation:pulse 2s infinite" aria-hidden="true">‚ú¶</div>
      <div style="color:var(--text-secondary);font-size:1.1rem;margin-top:.5rem">Pleiades OS</div>
      <div style="color:var(--text-muted);font-size:.8rem;margin-top:.25rem">Awakening...</div>
    </div>
  </div>

  <header class="header" role="banner">
    <div class="header-content">
      <div class="logo" aria-label="Pleiades OS Logo"><div class="logo-icon" aria-hidden="true">‚ú¶</div><span>Pleiades OS</span></div>
      <nav class="nav-tabs" id="navTabs" role="tablist" aria-label="Main Navigation"></nav>
      <div class="header-right">
        <div class="search-wrap">
          <span class="search-icon" aria-hidden="true">üîç</span>
          <input type="text" class="search-input" placeholder="Search... (‚åòK)" id="globalSearch" autocomplete="off" aria-label="Search" role="searchbox">
          <div class="search-results" id="searchResults"></div>
        </div>
        <div class="status-indicator offline" id="serverStatus" role="status" aria-live="polite" aria-label="Server status">
          <div class="status-dot" aria-hidden="true"></div>
          <span id="serverStatusText">Local</span>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content" id="mainContent" role="main"></main>

  <!-- Slide Panel -->
  <div class="slide-panel-overlay" id="slideOverlay" role="presentation"></div>
  <aside class="slide-panel" id="slidePanel" role="complementary" aria-label="Details Panel">
    <div style="padding:1.25rem;border-bottom:1px solid var(--border-subtle);display:flex;align-items:center;justify-content:space-between">
      <h2 id="slidePanelTitle" style="font-size:1.1rem">Details</h2>
      <button class="modal-close" onclick="closeSlidePanel()" aria-label="Close panel">√ó</button>
    </div>
    <div id="slidePanelContent" style="padding:1.25rem"></div>
  </aside>

  <!-- Universal Modal -->
  <div class="modal-overlay" id="universalModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal" id="universalModalContent" role="document"></div>
  </div>

  <div class="toast" id="toast" role="alert" aria-live="polite"></div>

<script>
// ============================================
// GOOGLE CALENDAR INTELLIGENCE
// ============================================

class GoogleCalendar {
  constructor() {
    this.isAuthenticated = false;
    this.accessToken = null;
    this.refreshToken = null;
    this.tokenExpiry = null;
    this.clientId = null; // Set via configure()
    this.apiKey = null;
    this.useMockData = true; // Default to mock until configured
    this.cacheKey = 'gcal_cache';
    this.syncStateKey = 'gcal_sync_state';
    this.configKey = 'gcal_config';
    this.loadConfig();
  }

  loadConfig() {
    const config = S.get(this.configKey, {});
    this.clientId = config.clientId || null;
    this.apiKey = config.apiKey || null;
    this.useMockData = !this.clientId; // Use mock if no clientId
    const tokens = this.getStoredTokens();
    if (tokens.accessToken && tokens.expiry > Date.now()) {
      this.accessToken = tokens.accessToken;
      this.refreshToken = tokens.refreshToken;
      this.tokenExpiry = tokens.expiry;
      this.isAuthenticated = true;
    }
  }

  configure(clientId, apiKey) {
    S.set(this.configKey, { clientId, apiKey, configured: true });
    this.clientId = clientId;
    this.apiKey = apiKey;
    this.useMockData = false;
    return true;
  }

  // Secure token storage using simple encryption
  encryptToken(token) {
    if (!token) return null;
    // Simple XOR encryption with device fingerprint
    const key = this.getDeviceKey();
    let encrypted = '';
    for (let i = 0; i < token.length; i++) {
      encrypted += String.fromCharCode(token.charCodeAt(i) ^ key.charCodeAt(i % key.length));
    }
    return btoa(encrypted);
  }

  decryptToken(encrypted) {
    if (!encrypted) return null;
    try {
      const key = this.getDeviceKey();
      const token = atob(encrypted);
      let decrypted = '';
      for (let i = 0; i < token.length; i++) {
        decrypted += String.fromCharCode(token.charCodeAt(i) ^ key.charCodeAt(i % key.length));
      }
      return decrypted;
    } catch (e) {
      return null;
    }
  }

  getDeviceKey() {
    // Create a device-specific key from user agent and screen resolution
    return btoa(navigator.userAgent + screen.width + screen.height).slice(0, 16);
  }

  storeTokens(accessToken, refreshToken, expiresIn) {
    const expiry = Date.now() + (expiresIn * 1000);
    const encrypted = {
      accessToken: this.encryptToken(accessToken),
      refreshToken: this.encryptToken(refreshToken),
      expiry: expiry
    };
    S.set('gcal_tokens', encrypted);
    this.accessToken = accessToken;
    this.refreshToken = refreshToken;
    this.tokenExpiry = expiry;
    this.isAuthenticated = true;
  }

  getStoredTokens() {
    const encrypted = S.get('gcal_tokens', {});
    return {
      accessToken: this.decryptToken(encrypted.accessToken),
      refreshToken: this.decryptToken(encrypted.refreshToken),
      expiry: encrypted.expiry || 0
    };
  }

  clearTokens() {
    S.remove('gcal_tokens');
    this.accessToken = null;
    this.refreshToken = null;
    this.tokenExpiry = null;
    this.isAuthenticated = false;
  }

  // OAuth2 Flow
  authenticate() {
    if (this.useMockData) {
      console.log('[GCal] Mock mode - authentication simulated');
      this.isAuthenticated = true;
      return Promise.resolve({ mock: true });
    }

    const redirectUri = window.location.origin + window.location.pathname;
    const scope = 'https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/calendar.events';
    const state = this.generateState();
    S.set('gcal_oauth_state', state);

    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
      `client_id=${this.clientId}` +
      `&redirect_uri=${encodeURIComponent(redirectUri)}` +
      `&scope=${encodeURIComponent(scope)}` +
      `&response_type=token` +
      `&state=${state}` +
      `&prompt=consent`;

    // Open popup for OAuth
    const width = 500, height = 600;
    const left = (window.screen.width - width) / 2;
    const top = (window.screen.height - height) / 2;
    const popup = window.open(authUrl, 'gcal_auth', `width=${width},height=${height},left=${left},top=${top}`);

    return new Promise((resolve, reject) => {
      const checkClosed = setInterval(() => {
        if (popup.closed) {
          clearInterval(checkClosed);
          // Check if we got a token
          const hash = window.location.hash;
          if (hash.includes('access_token')) {
            this.handleAuthResponse(hash).then(resolve).catch(reject);
          } else {
            reject(new Error('Authentication cancelled'));
          }
        }
      }, 500);
    });
  }

  generateState() {
    return Math.random().toString(36).substring(2) + Date.now().toString(36);
  }

  handleAuthResponse(hash) {
    const params = new URLSearchParams(hash.substring(1));
    const accessToken = params.get('access_token');
    const expiresIn = parseInt(params.get('expires_in')) || 3600;
    const state = params.get('state');
    const storedState = S.get('gcal_oauth_state');

    if (state !== storedState) {
      return Promise.reject(new Error('Invalid state parameter'));
    }

    this.storeTokens(accessToken, null, expiresIn);
    window.location.hash = ''; // Clear hash
    return Promise.resolve({ success: true });
  }

  // API Methods
  async fetchEvents(dateRange = 'today') {
    if (this.useMockData) {
      return this.getMockEvents(dateRange);
    }

    // Check cache first
    const cached = this.getCachedEvents(dateRange);
    if (cached && cached.timestamp > Date.now() - 60000) { // 1 min cache
      return cached.events;
    }

    const now = new Date();
    let timeMin, timeMax;

    switch (dateRange) {
      case 'today':
        timeMin = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
        timeMax = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString();
        break;
      case 'week':
        timeMin = now.toISOString();
        timeMax = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString();
        break;
      case 'upcoming':
        timeMin = now.toISOString();
        timeMax = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString();
        break;
      default:
        // Assume it's a date string
        const date = new Date(dateRange);
        timeMin = new Date(date.getFullYear(), date.getMonth(), date.getDate()).toISOString();
        timeMax = new Date(date.getFullYear(), date.getMonth(), date.getDate() + 1).toISOString();
    }

    try {
      const response = await fetch(
        `https://www.googleapis.com/calendar/v3/calendars/primary/events?` +
        `timeMin=${encodeURIComponent(timeMin)}&` +
        `timeMax=${encodeURIComponent(timeMax)}&` +
        `singleEvents=true&` +
        `orderBy=startTime`,
        { headers: { 'Authorization': `Bearer ${this.accessToken}` } }
      );

      if (!response.ok) throw new Error('Failed to fetch events');
      const data = await response.json();
      const events = this.normalizeEvents(data.items || []);
      this.cacheEvents(dateRange, events);
      return events;
    } catch (error) {
      console.error('[GCal] Fetch error:', error);
      return this.getMockEvents(dateRange); // Fallback to mock
    }
  }

  async createEvent(event) {
    if (this.useMockData) {
      console.log('[GCal] Mock create:', event);
      return { id: 'mock_' + Date.now(), ...event };
    }

    const gcalEvent = {
      summary: event.title,
      description: event.description || '',
      start: { dateTime: event.startTime, timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone },
      end: { dateTime: event.endTime, timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone },
      location: event.location || '',
      attendees: (event.attendees || []).map(email => ({ email }))
    };

    const response = await fetch(
      'https://www.googleapis.com/calendar/v3/calendars/primary/events',
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(gcalEvent)
      }
    );

    if (!response.ok) throw new Error('Failed to create event');
    const data = await response.json();
    return this.normalizeEvent(data);
  }

  async updateEvent(eventId, changes) {
    if (this.useMockData) {
      console.log('[GCal] Mock update:', eventId, changes);
      return { id: eventId, ...changes };
    }

    const gcalChanges = {};
    if (changes.title) gcalChanges.summary = changes.title;
    if (changes.description) gcalChanges.description = changes.description;
    if (changes.startTime) gcalChanges.start = { dateTime: changes.startTime };
    if (changes.endTime) gcalChanges.end = { dateTime: changes.endTime };
    if (changes.location) gcalChanges.location = changes.location;

    const response = await fetch(
      `https://www.googleapis.com/calendar/v3/calendars/primary/events/${eventId}`,
      {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${this.accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(gcalChanges)
      }
    );

    if (!response.ok) throw new Error('Failed to update event');
    return this.normalizeEvent(await response.json());
  }

  async deleteEvent(eventId) {
    if (this.useMockData) {
      console.log('[GCal] Mock delete:', eventId);
      return true;
    }

    const response = await fetch(
      `https://www.googleapis.com/calendar/v3/calendars/primary/events/${eventId}`,
      {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${this.accessToken}` }
      }
    );

    return response.ok;
  }

  // Cache Management
  cacheEvents(key, events) {
    const cache = S.get(this.cacheKey, {});
    cache[key] = { events, timestamp: Date.now() };
    S.set(this.cacheKey, cache);
  }

  getCachedEvents(key) {
    const cache = S.get(this.cacheKey, {});
    return cache[key] || null;
  }

  clearCache() {
    S.remove(this.cacheKey);
  }

  // Normalization
  normalizeEvents(items) {
    return items.map(item => this.normalizeEvent(item));
  }

  normalizeEvent(item) {
    return {
      id: item.id,
      title: item.summary || 'Untitled',
      description: item.description || '',
      startTime: item.start?.dateTime || item.start?.date,
      endTime: item.end?.dateTime || item.end?.date,
      location: item.location || '',
      attendees: (item.attendees || []).map(a => a.email),
      calendarLink: item.htmlLink || '',
      isAllDay: !!item.start?.date,
      status: item.status,
      created: item.created,
      updated: item.updated
    };
  }

  // Mock Data for Development
  getMockEvents(dateRange) {
    const now = new Date();
    const events = [];
    const titles = [
      'Firebird Grant Review', 'Hamilton Library Interview', 'Team Standup',
      'OTF Application Workshop', 'Board Meeting', 'Volunteer Coordination',
      'Budget Review', 'Strategy Session', 'Partnership Call'
    ];

    // Generate mock events based on dateRange
    const count = dateRange === 'today' ? 3 : dateRange === 'week' ? 8 : 15;
    
    for (let i = 0; i < count; i++) {
      const startHour = 9 + Math.floor(Math.random() * 8);
      const duration = [30, 60, 90][Math.floor(Math.random() * 3)];
      const startDate = new Date(now);
      
      if (dateRange === 'week') {
        startDate.setDate(startDate.getDate() + Math.floor(Math.random() * 7));
      } else if (dateRange === 'upcoming') {
        startDate.setDate(startDate.getDate() + Math.floor(Math.random() * 30));
      }

      startDate.setHours(startHour, 0, 0, 0);
      const endDate = new Date(startDate.getTime() + duration * 60000);

      events.push({
        id: 'mock_' + i,
        title: titles[i % titles.length],
        description: 'Meeting details and preparation notes',
        startTime: startDate.toISOString(),
        endTime: endDate.toISOString(),
        location: ['Zoom', 'Conference Room', 'Google Meet'][i % 3],
        attendees: ['member@example.com'],
        calendarLink: '#',
        isAllDay: false,
        status: 'confirmed'
      });
    }

    return events.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
  }

  // Sync State Management
  getSyncState() {
    return S.get(this.syncStateKey, {
      lastSync: null,
      syncEnabled: false,
      autoSync: true,
      syncedEvents: []
    });
  }

  saveSyncState(state) {
    S.set(this.syncStateKey, state);
  }
}

// ============================================
// MORNING REPORT ENGINE
// ============================================

async function generateMorningReport() {
  const hour = new Date().getHours();
  
  // Only show morning report after 5 AM and before 6 PM
  if (hour < 5 || hour >= 18) {
    return null;
  }

  // Check if we already generated report today
  const today = todayStr();
  const lastReport = S.get('morning_report_date');
  if (lastReport === today) {
    return S.get('morning_report_data');
  }

  const report = {
    date: today,
    generatedAt: new Date().toISOString(),
    greeting: getTimeBasedGreeting(),
    todayEvents: [],
    upcomingDeadlines: [],
    prepAlerts: [],
    freeTimeBlocks: [],
    conflicts: [],
    suggestions: []
  };

  try {
    // Fetch today's events from Google Calendar
    const events = await GCal.fetchEvents('today');
    report.todayEvents = events;

    // Fetch upcoming week for deadlines
    const upcoming = await GCal.fetchEvents('week');
    report.upcomingDeadlines = upcoming.filter(e => {
      const title = e.title.toLowerCase();
      return title.includes('deadline') || title.includes('due') || title.includes('submit');
    });

    // Generate prep alerts
    report.prepAlerts = generatePrepAlerts(events);

    // Find free time blocks
    report.freeTimeBlocks = findFreeTimeBlocks(events);

    // Detect conflicts
    report.conflicts = detectConflicts(events);

    // Generate smart suggestions
    report.suggestions = generateSuggestions(events, report.freeTimeBlocks);

    // Save report
    S.set('morning_report_date', today);
    S.set('morning_report_data', report);

    return report;
  } catch (error) {
    console.error('[Morning Report] Generation failed:', error);
    return null;
  }
}

function getTimeBasedGreeting() {
  const hour = new Date().getHours();
  if (hour < 12) return 'Good morning';
  if (hour < 17) return 'Good afternoon';
  return 'Good evening';
}

function generatePrepAlerts(events) {
  const alerts = [];
  const now = new Date();

  events.forEach(event => {
    const startTime = new Date(event.startTime);
    const minutesUntil = Math.floor((startTime - now) / 60000);

    if (minutesUntil > 0 && minutesUntil <= 60) {
      const prepTime = minutesUntil <= 15 ? 5 : minutesUntil <= 30 ? 15 : 30;
      alerts.push({
        event: event,
        minutesUntil: minutesUntil,
        prepTime: prepTime,
        urgency: minutesUntil <= 15 ? 'high' : minutesUntil <= 30 ? 'medium' : 'low',
        message: `${event.title} in ${minutesUntil} minutes - ${getPrepSuggestion(event.title)}`
      });
    }
  });

  return alerts.sort((a, b) => a.minutesUntil - b.minutesUntil);
}

function getPrepSuggestion(title) {
  const lower = title.toLowerCase();
  if (lower.includes('interview')) return 'review your notes and CV';
  if (lower.includes('grant')) return 'review application materials';
  if (lower.includes('board')) return 'check agenda and minutes';
  if (lower.includes('standup')) return 'prepare status update';
  if (lower.includes('review')) return 'gather relevant documents';
  return 'review prep notes';
}

function findFreeTimeBlocks(events) {
  const blocks = [];
  const workStart = 9; // 9 AM
  const workEnd = 18; // 6 PM
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  // Create timeline of busy periods
  const busyPeriods = events
    .filter(e => !e.isAllDay)
    .map(e => ({
      start: new Date(e.startTime),
      end: new Date(e.endTime)
    }))
    .sort((a, b) => a.start - b.start);

  // Find gaps
  let currentTime = new Date(today.getTime() + workStart * 60 * 60 * 1000);
  const endOfWork = new Date(today.getTime() + workEnd * 60 * 60 * 1000);

  // If it's past work start, use current time
  if (now > currentTime) {
    currentTime = new Date(now.getTime() + 15 * 60000); // Round up 15 min
  }

  for (const busy of busyPeriods) {
    if (busy.start > currentTime) {
      const duration = Math.floor((busy.start - currentTime) / 60000);
      if (duration >= 30) {
        blocks.push({
          start: new Date(currentTime),
          end: new Date(busy.start),
          duration: duration,
          type: duration >= 120 ? 'deep_work' : duration >= 60 ? 'focused_work' : 'quick_tasks'
        });
      }
    }
    if (busy.end > currentTime) {
      currentTime = busy.end;
    }
  }

  // Check for time after last meeting
  if (currentTime < endOfWork) {
    const duration = Math.floor((endOfWork - currentTime) / 60000);
    if (duration >= 30) {
      blocks.push({
        start: new Date(currentTime),
        end: endOfWork,
        duration: duration,
        type: duration >= 120 ? 'deep_work' : duration >= 60 ? 'focused_work' : 'quick_tasks'
      });
    }
  }

  return blocks;
}

function detectConflicts(events) {
  const conflicts = [];
  const sorted = [...events].sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

  for (let i = 0; i < sorted.length - 1; i++) {
    const current = sorted[i];
    const next = sorted[i + 1];
    const currentEnd = new Date(current.endTime);
    const nextStart = new Date(next.startTime);
    const gap = Math.floor((nextStart - currentEnd) / 60000);

    if (gap < 0) {
      conflicts.push({
        event1: current,
        event2: next,
        overlap: Math.abs(gap)
      });
    } else if (gap < 15) {
      conflicts.push({
        event1: current,
        event2: next,
        tight: true,
        gap: gap
      });
    }
  }

  return conflicts;
}

function generateSuggestions(events, freeBlocks) {
  const suggestions = [];
  const eventCount = events.length;
  const totalBusy = events.reduce((sum, e) => {
    if (!e.isAllDay) {
      return sum + (new Date(e.endTime) - new Date(e.startTime)) / 60000;
    }
    return sum;
  }, 0);

  if (eventCount === 0) {
    suggestions.push({
      type: 'opportunity',
      icon: '‚ú®',
      message: 'Clear calendar today ‚Äî perfect for deep work or tackling backlog'
    });
  } else if (eventCount > 6) {
    suggestions.push({
      type: 'warning',
      icon: '‚ö†Ô∏è',
      message: 'Heavy meeting day ‚Äî consider deferring non-urgent tasks'
    });
  }

  if (totalBusy > 300) { // More than 5 hours
    suggestions.push({
      type: 'wellness',
      icon: 'üßò',
      message: 'Schedule breaks between meetings ‚Äî your energy matters'
    });
  }

  // Check for back-to-back meetings
  const backToBack = events.filter((e, i) => {
    if (i === 0) return false;
    const prev = events[i - 1];
    return new Date(e.startTime) - new Date(prev.endTime) < 15 * 60000;
  });

  if (backToBack.length > 2) {
    suggestions.push({
      type: 'strategy',
      icon: 'üîÑ',
      message: `${backToBack.length} back-to-back meetings ‚Äî build in buffer time tomorrow`
    });
  }

  // Free time suggestions
  const deepWork = freeBlocks.find(b => b.type === 'deep_work');
  if (deepWork) {
    suggestions.push({
      type: 'opportunity',
      icon: 'üéØ',
      message: `${deepWork.duration}min block available ‚Äî ideal for grant writing or strategic work`
    });
  }

  return suggestions;
}

// Sync meetings between Pleiades and Google Calendar
async function syncMeetingsWithCalendar() {
  const syncState = GCal.getSyncState();
  if (!syncState.syncEnabled) return;

  const localMeetings = getMeetings();
  const calendarEvents = await GCal.fetchEvents('upcoming');

  // Two-way sync logic
  const syncedMeetings = [];
  const syncedIds = new Set();

  // Map calendar events to local meetings
  for (const event of calendarEvents) {
    const existingIndex = localMeetings.findIndex(m => m.gcalId === event.id);
    
    if (existingIndex >= 0) {
      // Update existing meeting
      localMeetings[existingIndex] = {
        ...localMeetings[existingIndex],
        title: event.title,
        date: event.startTime.split('T')[0],
        time: event.startTime.split('T')[1]?.slice(0, 5) || '09:00',
        type: event.location?.toLowerCase().includes('zoom') ? 'zoom' : 
              event.location?.toLowerCase().includes('meet') ? 'call' : 'in-person',
        attendees: event.attendees?.join(', ') || localMeetings[existingIndex].attendees,
        prepNotes: event.description || localMeetings[existingIndex].prepNotes
      };
      syncedMeetings.push(localMeetings[existingIndex]);
      syncedIds.add(localMeetings[existingIndex].id);
    } else {
      // Create new meeting from calendar event
      const newMeeting = {
        id: 'm' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
        gcalId: event.id,
        title: event.title,
        date: event.startTime.split('T')[0],
        time: event.startTime.split('T')[1]?.slice(0, 5) || '09:00',
        type: event.location?.toLowerCase().includes('zoom') ? 'zoom' : 
              event.location?.toLowerCase().includes('meet') ? 'call' : 'in-person',
        attendees: event.attendees?.join(', ') || 'TBD',
        prepNotes: event.description || '',
        agenda: [],
        notes: '',
        actionItems: []
      };
      localMeetings.push(newMeeting);
      syncedMeetings.push(newMeeting);
      syncedIds.add(newMeeting.id);
    }
  }

  // Sync local meetings back to calendar (for new local meetings)
  for (const meeting of localMeetings) {
    if (!meeting.gcalId && !syncedIds.has(meeting.id)) {
      try {
        const startTime = `${meeting.date}T${meeting.time}:00`;
        const endTimeObj = new Date(new Date(startTime).getTime() + 60 * 60000);
        const endTime = endTimeObj.toISOString();

        const gcalEvent = await GCal.createEvent({
          title: meeting.title,
          description: meeting.prepNotes,
          startTime: startTime,
          endTime: endTime,
          location: meeting.type === 'zoom' ? 'Zoom' : meeting.type === 'call' ? 'Phone' : 'TBD',
          attendees: meeting.attendees?.split(',').map(e => e.trim()).filter(Boolean) || []
        });

        meeting.gcalId = gcalEvent.id;
        syncedMeetings.push(meeting);
      } catch (error) {
        console.error('[Sync] Failed to create calendar event:', error);
      }
    }
  }

  saveMeetingsData(localMeetings);
  
  syncState.lastSync = new Date().toISOString();
  GCal.saveSyncState(syncState);

  logAct('üîÑ', 'system', `Synced ${syncedMeetings.length} meetings with Google Calendar`);
  return syncedMeetings;
}

// Add to Calendar helper
async function addToCalendar(meetingData) {
  try {
    const event = await GCal.createEvent({
      title: meetingData.title,
      description: meetingData.description || meetingData.prepNotes || '',
      startTime: meetingData.startTime || `${meetingData.date}T${meetingData.time}:00`,
      endTime: meetingData.endTime || new Date(new Date(`${meetingData.date}T${meetingData.time}:00`).getTime() + 60 * 60000).toISOString(),
      location: meetingData.location || meetingData.type || '',
      attendees: meetingData.attendees || []
    });

    toast(`Added "${meetingData.title}" to Google Calendar`);
    logAct('üìÖ', 'meeting', `Added to calendar: ${meetingData.title}`);
    return event;
  } catch (error) {
    toast('Failed to add to calendar', 'error');
    console.error('[Calendar] Add error:', error);
    return null;
  }
}

// ============================================
// CORE SYSTEM
// ============================================
const S = {
  get(k, d=null) { 
    try { 
      const v=localStorage.getItem('po_'+k); 
      return v?JSON.parse(v):d; 
    } catch(e) { 
      console.error('Storage get error:', e);
      return d; 
    } 
  },
  set(k, v) { 
    try {
      const serialized = JSON.stringify(v);
      // Check size (localStorage limit is ~5-10MB)
      if (serialized.length > 1000000) { // 1MB warning threshold
        console.warn(`Large storage item: ${k} is ${(serialized.length/1024).toFixed(1)}KB`);
      }
      localStorage.setItem('po_'+k, serialized);
      return true;
    } catch(e) {
      if (e.name === 'QuotaExceededError' || e.code === 22) {
        toast('Storage full. Please export and clear old data.', 'error');
        logAct('‚ö†Ô∏è','system','localStorage quota exceeded');
      } else {
        console.error('Storage set error:', e);
      }
      return false;
    }
  },
  remove(k) {
    try {
      localStorage.removeItem('po_'+k);
      return true;
    } catch(e) {
      return false;
    }
  },
  clear() {
    try {
      localStorage.clear();
      return true;
    } catch(e) {
      return false;
    }
  },
  getSize() {
    let total = 0;
    for (let key in localStorage) {
      if (localStorage.hasOwnProperty(key)) {
        total += localStorage[key].length * 2; // UTF-16 = 2 bytes per char
      }
    }
    return total;
  },
  getSizeMB() {
    return (S.getSize() / (1024 * 1024)).toFixed(2);
  }
};

// Global Calendar Instance (initialized AFTER S is defined)
const GCal = new GoogleCalendar();

// ============================================
// NOTION DATABASE CONFIGURATION
// ============================================
const NOTION_DATABASES = {
  jobs: { id: '308e0ed4-78b6-816d-8daf-c8e358b02627', name: 'Job Applications', icon: 'üíº', color: 'jobs' },
  immigration: { id: '308e0ed4-78b6-8121-bee6-ea1a892fee43', name: 'Immigration Documents', icon: 'üõÇ', color: 'immigration' },
  projects: { id: '308e0ed4-78b6-81f0-abc6-e7f377ac957b', name: 'Projects & Tasks', icon: 'üìÅ', color: 'projects' },
  content: { id: '308e0ed4-78b6-81f3-b548-c3170ab388f9', name: 'Content Ideas', icon: '‚úçÔ∏è', color: 'content' },
  grants: { id: '30ae0ed4-78b6-81d0-81c7-d884c1215e8a', name: 'Grant Pipeline', icon: 'üí∞', color: 'grants' },
  policy: { id: '30ae0ed4-78b6-813e-8add-dbf78974b2ee', name: 'Policy Development', icon: 'üìú', color: 'policy' },
  actions: { id: '30ae0ed4-78b6-813e-9dbd-e7c914afaff4', name: 'Action Items', icon: '‚ö°', color: 'actions' }
};

// API endpoint - change this to your deployed Vercel URL
const NOTION_API_ENDPOINT = '/api/notion';
const NOTION_ADD_ENDPOINT = '/api/notion-add';

let notionSyncStatus = { syncing: false, lastSync: null, error: null };
let notionCache = S.get('notionCache', null);

const TABS = [
  { id:'dashboard', icon:'‚ú®', label:'Today' },
  { id:'projects', icon:'üéØ', label:'Path' },
  { id:'command', icon:'üåü', label:'Command' },
  { id:'meetings', icon:'üìû', label:'Rituals' },
  { id:'intel', icon:'üì°', label:'Signals' },
  { id:'llm', icon:'ü§ñ', label:'LLM' },
  { id:'brain', icon:'üß†', label:'Brain' },
  { id:'timeline', icon:'üåô', label:'Journey' },
  { id:'notes', icon:'üìù', label:'Notes' }
];

let activeTab = S.get('activeTab', 'dashboard');
let activityFeed = S.get('activity', []);

function esc(t) { const d=document.createElement('div'); d.textContent=t; return d.innerHTML }
function timeAgo(d) {
  const s=Math.floor((Date.now()-new Date(d))/1000);
  if(s<60) return 'Just now';
  const m=Math.floor(s/60); if(m<60) return m+'m ago';
  const h=Math.floor(m/60); if(h<24) return h+'h ago';
  const dy=Math.floor(h/24); return dy+'d ago';
}
function logAct(icon, type, msg) {
  activityFeed.unshift({ icon, type, msg, time: new Date().toISOString() });
  if(activityFeed.length > 50) activityFeed = activityFeed.slice(0, 50);
  S.set('activity', activityFeed);
}
function toast(msg, type='success') {
  const t=document.getElementById('toast');
  t.textContent=msg; t.className=`toast ${type} show`;
  setTimeout(()=>t.classList.remove('show'), 3000);
}

// ============================================
// NAV
// ============================================
function initNav() {
  const nav = document.getElementById('navTabs');
  nav.innerHTML = TABS.map(t =>
    `<button class="nav-tab ${t.id===activeTab?'active':''}" data-tab="${t.id}">${t.icon} ${t.label}</button>`
  ).join('');
  nav.querySelectorAll('.nav-tab').forEach(btn => {
    btn.onclick = () => switchTab(btn.dataset.tab);
  });
}

function switchTab(id) {
  activeTab = id;
  S.set('activeTab', id);
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.tab===id));
  renderActiveTab();
}

// ============================================
// COMMAND PALETTE & SEARCH
// ============================================

// Command Palette State
let commandPaletteOpen = false;
let commandPaletteSelectedIndex = 0;
let commandPaletteFilteredCommands = [];
let commandPaletteRecent = S.get('cmd_recent', []);

// Command Registry
const COMMANDS = [
  // Navigation Commands
  { id: 'nav_dashboard', category: 'Navigation', icon: '‚ú®', label: 'Go to Today (Dashboard)', keywords: ['dashboard', 'today', 'home'], action: () => switchTab('dashboard') },
  { id: 'nav_projects', category: 'Navigation', icon: 'üéØ', label: 'Go to Path (Projects)', keywords: ['projects', 'path', 'tasks', 'kanban'], action: () => switchTab('projects') },
  { id: 'nav_command', category: 'Navigation', icon: 'üåü', label: 'Go to Command Center', keywords: ['command', 'center', 'notion'], action: () => switchTab('command') },
  { id: 'nav_meetings', category: 'Navigation', icon: 'üìû', label: 'Go to Rituals (Meetings)', keywords: ['meetings', 'rituals', 'calendar'], action: () => switchTab('meetings') },
  { id: 'nav_intel', category: 'Navigation', icon: 'üì°', label: 'Go to Signals (Intel)', keywords: ['intel', 'signals', 'news'], action: () => switchTab('intel') },
  { id: 'nav_llm', category: 'Navigation', icon: 'ü§ñ', label: 'Go to LLM Tracker', keywords: ['llm', 'tracker', 'models', 'budget'], action: () => switchTab('llm') },
  { id: 'nav_brain', category: 'Navigation', icon: 'üß†', label: 'Go to Brain', keywords: ['brain', 'agent', 'status'], action: () => switchTab('brain') },
  { id: 'nav_timeline', category: 'Navigation', icon: 'üåô', label: 'Go to Journey (Timeline)', keywords: ['timeline', 'journey', 'milestones'], action: () => switchTab('timeline') },
  { id: 'nav_notes', category: 'Navigation', icon: 'üìù', label: 'Go to Notes', keywords: ['notes', 'journal', 'field'], action: () => switchTab('notes') },
  
  // Action Commands
  { id: 'act_task', category: 'Actions', icon: 'üéØ', label: 'Add New Task', keywords: ['add', 'create', 'task', 'new'], action: () => addTask('backlog') },
  { id: 'act_priority', category: 'Actions', icon: '‚≠ê', label: 'Add Priority', keywords: ['add', 'create', 'priority', 'todo'], action: () => addPriority() },
  { id: 'act_meeting', category: 'Actions', icon: 'üìÖ', label: 'Add Meeting', keywords: ['add', 'create', 'meeting', 'event'], action: () => addMeeting() },
  { id: 'act_intel', category: 'Actions', icon: 'üì°', label: 'Add Intel', keywords: ['add', 'create', 'intel', 'signal'], action: () => addIntel() },
  { id: 'act_decision', category: 'Actions', icon: 'üìã', label: 'Log Decision', keywords: ['log', 'add', 'decision'], action: () => addDecision() },
  { id: 'act_phase', category: 'Actions', icon: 'üåô', label: 'Add Timeline Phase', keywords: ['add', 'phase', 'milestone'], action: () => addTimelinePhase() },
  
  // Utility Commands
  { id: 'util_sync', category: 'Utility', icon: 'üîÑ', label: 'Sync with Notion', keywords: ['sync', 'notion', 'update'], action: () => { syncNotionData(); toast('Syncing with Notion...'); } },
  { id: 'util_export', category: 'Utility', icon: 'üì§', label: 'Export LLM Data', keywords: ['export', 'llm', 'data'], action: () => exportLLMData() },
  { id: 'util_reset', category: 'Utility', icon: 'üóëÔ∏è', label: 'Reset LLM Usage', keywords: ['reset', 'llm', 'clear'], action: () => resetLLMUsage() },
  { id: 'util_goal', category: 'Utility', icon: 'üè†', label: 'Edit Goal Date', keywords: ['goal', 'date', 'home'], action: () => editGoalDate() },
];

// Fuzzy Matching Algorithm
function fuzzyMatch(query, text) {
  query = query.toLowerCase();
  text = text.toLowerCase();
  
  if (text.includes(query)) return 1.0; // Exact substring match
  
  // Fuzzy matching - check if all chars appear in order
  let queryIdx = 0;
  for (let i = 0; i < text.length && queryIdx < query.length; i++) {
    if (text[i] === query[queryIdx]) queryIdx++;
  }
  
  if (queryIdx === query.length) {
    // All chars found in order - calculate score based on how spread out they are
    return 0.5 + (0.5 * (query.length / text.length));
  }
  
  return 0;
}

function scoreCommand(query, cmd) {
  let score = fuzzyMatch(query, cmd.label);
  
  // Check keywords
  for (const kw of cmd.keywords) {
    const kwScore = fuzzyMatch(query, kw);
    if (kwScore > score) score = kwScore;
  }
  
  // Boost recently used commands
  const recentIndex = commandPaletteRecent.indexOf(cmd.id);
  if (recentIndex !== -1) {
    score += 0.3 * (1 - recentIndex / commandPaletteRecent.length);
  }
  
  return score;
}

function addRecentCommand(cmdId) {
  // Remove if exists
  commandPaletteRecent = commandPaletteRecent.filter(id => id !== cmdId);
  // Add to front
  commandPaletteRecent.unshift(cmdId);
  // Keep only last 10
  if (commandPaletteRecent.length > 10) commandPaletteRecent = commandPaletteRecent.slice(0, 10);
  // Save
  S.set('cmd_recent', commandPaletteRecent);
}

function createCommandPaletteModal() {
  if (document.getElementById('commandPalette')) return;
  
  const overlay = document.createElement('div');
  overlay.id = 'commandPalette';
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal" style="max-width:600px;width:90%;padding:0;overflow:hidden">
      <div style="display:flex;align-items:center;padding:.75rem 1rem;border-bottom:1px solid var(--border-subtle)">
        <span style="font-size:1.2rem;margin-right:.5rem;color:var(--text-muted)">üîç</span>
        <input type="text" id="cmdInput" placeholder="Type a command or search..." 
          style="flex:1;border:none;background:transparent;color:var(--text-primary);font-size:1rem;outline:none;font-family:var(--font-ui)" autocomplete="off">
        <span style="font-size:.75rem;color:var(--text-muted);background:var(--bg-warm);padding:.2rem .4rem;border-radius:4px;font-family:var(--font-ui)">ESC</span>
      </div>
      <div id="cmdResults" style="max-height:400px;overflow-y:auto;padding:.5rem 0"></div>
      <div style="display:flex;justify-content:space-between;padding:.5rem 1rem;border-top:1px solid var(--border-subtle);font-size:.75rem;color:var(--text-muted)">
        <span>‚Üë‚Üì Navigate</span>
        <span>‚Üµ Execute</span>
      </div>
    </div>
  `;
  
  overlay.addEventListener('click', e => {
    if (e.target === overlay) closeCommandPalette();
  });
  
  document.body.appendChild(overlay);
}

function openCommandPalette() {
  createCommandPaletteModal();
  const overlay = document.getElementById('commandPalette');
  overlay.classList.add('open');
  commandPaletteOpen = true;
  commandPaletteSelectedIndex = 0;
  
  const input = document.getElementById('cmdInput');
  input.value = '';
  input.focus();
  
  // Show all commands initially, sorted by recent usage
  filterCommands('');
  
  // Prevent body scroll
  document.body.style.overflow = 'hidden';
}

function closeCommandPalette() {
  const overlay = document.getElementById('commandPalette');
  if (overlay) overlay.classList.remove('open');
  commandPaletteOpen = false;
  document.body.style.overflow = '';
}

function filterCommands(query) {
  const resultsDiv = document.getElementById('cmdResults');
  
  if (!query.trim()) {
    // Show recently used first, then all commands by category
    const recentCmds = commandPaletteRecent
      .map(id => COMMANDS.find(c => c.id === id))
      .filter(Boolean);
    
    const otherCmds = COMMANDS.filter(c => !commandPaletteRecent.includes(c.id));
    
    commandPaletteFilteredCommands = [...recentCmds, ...otherCmds];
  } else {
    // Score and filter
    const scored = COMMANDS.map(cmd => ({ cmd, score: scoreCommand(query, cmd) }))
      .filter(({ score }) => score > 0)
      .sort((a, b) => b.score - a.score);
    
    commandPaletteFilteredCommands = scored.map(s => s.cmd);
  }
  
  // Also search data
  if (query.trim().length >= 2) {
    const dataResults = searchData(query);
    // Add data results to the end
    commandPaletteFilteredCommands = [...commandPaletteFilteredCommands, ...dataResults];
  }
  
  renderCommandResults();
}

function searchData(query) {
  const results = [];
  const q = query.toLowerCase();
  
  // Search tasks
  getTasks().forEach(t => {
    if (t.title.toLowerCase().includes(q) || (t.description || '').toLowerCase().includes(q)) {
      results.push({
        id: 'data_task_' + t.id,
        category: 'Search: Tasks',
        icon: 'üéØ',
        label: t.title,
        subtitle: t.description || t.status,
        isDataResult: true,
        action: () => {
          switchTab('projects');
          // Could scroll to specific task
        }
      });
    }
  });
  
  // Search priorities
  getPriorities().forEach(p => {
    if (p.text.toLowerCase().includes(q)) {
      results.push({
        id: 'data_priority_' + p.id,
        category: 'Search: Priorities',
        icon: '‚≠ê',
        label: p.text,
        subtitle: p.done ? 'Done' : 'Active',
        isDataResult: true,
        action: () => switchTab('dashboard')
      });
    }
  });
  
  // Search meetings
  getMeetings().forEach(m => {
    if (m.title.toLowerCase().includes(q) || (m.attendees || '').toLowerCase().includes(q)) {
      results.push({
        id: 'data_meeting_' + m.id,
        category: 'Search: Meetings',
        icon: 'üìÖ',
        label: m.title,
        subtitle: m.date + ' at ' + m.time,
        isDataResult: true,
        action: () => switchTab('meetings')
      });
    }
  });
  
  // Search intel
  getIntel().forEach(i => {
    if (i.title.toLowerCase().includes(q) || i.summary.toLowerCase().includes(q)) {
      results.push({
        id: 'data_intel_' + i.id,
        category: 'Search: Intel',
        icon: 'üì°',
        label: i.title,
        subtitle: i.category,
        isDataResult: true,
        action: () => switchTab('intel')
      });
    }
  });
  
  return results.slice(0, 5); // Limit data results
}

function renderCommandResults() {
  const resultsDiv = document.getElementById('cmdResults');
  
  if (commandPaletteFilteredCommands.length === 0) {
    resultsDiv.innerHTML = '<div style="padding:2rem;text-align:center;color:var(--text-muted)">No commands found</div>';
    return;
  }
  
  // Group by category
  const grouped = {};
  commandPaletteFilteredCommands.forEach(cmd => {
    const cat = cmd.category || 'Other';
    if (!grouped[cat]) grouped[cat] = [];
    grouped[cat].push(cmd);
  });
  
  let html = '';
  let globalIndex = 0;
  
  for (const [category, cmds] of Object.entries(grouped)) {
    html += `<div style="padding:.25rem 1rem;font-size:.7rem;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);margin-top:.5rem">${category}</div>`;
    
    cmds.forEach(cmd => {
      const isSelected = globalIndex === commandPaletteSelectedIndex;
      html += `
        <div class="cmd-item ${isSelected ? 'selected' : ''}" data-index="${globalIndex}" 
          style="display:flex;align-items:center;gap:.75rem;padding:.625rem 1rem;cursor:pointer;transition:all .15s;${isSelected ? 'background:rgba(212,168,75,.15)' : ''}"
          onmouseenter="commandPaletteSelectedIndex=${globalIndex};renderCommandResults()">
          <span style="font-size:1.1rem;width:24px;text-align:center">${cmd.icon}</span>
          <div style="flex:1;min-width:0">
            <div style="font-weight:500;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(cmd.label)}</div>
            ${cmd.subtitle ? `<div style="font-size:.8rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(cmd.subtitle)}</div>` : ''}
          </div>
          ${isSelected ? '<span style="font-size:.8rem;color:var(--accent)">‚Üµ</span>' : ''}
        </div>
      `;
      globalIndex++;
    });
  }
  
  resultsDiv.innerHTML = html;
  
  // Scroll selected into view
  const selected = resultsDiv.querySelector('.cmd-item.selected');
  if (selected) {
    selected.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
  }
}

function executeSelectedCommand() {
  const cmd = commandPaletteFilteredCommands[commandPaletteSelectedIndex];
  if (!cmd) return;
  
  closeCommandPalette();
  
  if (!cmd.isDataResult) {
    addRecentCommand(cmd.id);
  }
  
  if (cmd.action) {
    cmd.action();
  }
}

function initCommandPalette() {
  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    // Toggle with ‚åòK / Ctrl+K
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      if (commandPaletteOpen) {
        closeCommandPalette();
      } else {
        openCommandPalette();
      }
      return;
    }
    
    // Handle palette navigation
    if (!commandPaletteOpen) return;
    
    switch (e.key) {
      case 'Escape':
        e.preventDefault();
        closeCommandPalette();
        break;
      case 'ArrowDown':
        e.preventDefault();
        commandPaletteSelectedIndex = (commandPaletteSelectedIndex + 1) % commandPaletteFilteredCommands.length;
        renderCommandResults();
        break;
      case 'ArrowUp':
        e.preventDefault();
        commandPaletteSelectedIndex = (commandPaletteSelectedIndex - 1 + commandPaletteFilteredCommands.length) % commandPaletteFilteredCommands.length;
        renderCommandResults();
        break;
      case 'Enter':
        e.preventDefault();
        executeSelectedCommand();
        break;
    }
  });
  
  // Input handler for filtering
  document.addEventListener('input', e => {
    if (e.target.id === 'cmdInput') {
      commandPaletteSelectedIndex = 0;
      filterCommands(e.target.value);
    }
  });
  
  // Click handler
  document.addEventListener('click', e => {
    const item = e.target.closest('.cmd-item');
    if (item) {
      commandPaletteSelectedIndex = parseInt(item.dataset.index);
      executeSelectedCommand();
    }
  });
}

function initSearch() {
  const input = document.getElementById('globalSearch');
  const results = document.getElementById('searchResults');

  // Clear input and focus opens command palette
  input.addEventListener('focus', () => {
    if (!input.value.trim()) {
      // Don't auto-open, just focus
    }
  });
  
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      // Open command palette with current search
      openCommandPalette();
      const cmdInput = document.getElementById('cmdInput');
      if (cmdInput) cmdInput.value = input.value;
      filterCommands(input.value);
      input.value = '';
      results.classList.remove('open');
    }
  });

  input.addEventListener('input', () => {
    const q = input.value.trim().toLowerCase();
    if(q.length < 2) { results.classList.remove('open'); return; }

    const items = [];
    // Search tasks
    getTasks().forEach(t => {
      if(t.title.toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q))
        items.push({ type:'Task', title:t.title, desc:t.status, tab:'projects' });
    });
    // Search priorities
    getPriorities().forEach(p => {
      if(p.text.toLowerCase().includes(q))
        items.push({ type:'Priority', title:p.text, desc:p.done?'Done':'Active', tab:'dashboard' });
    });
    // Search meetings
    getMeetings().forEach(m => {
      if(m.title.toLowerCase().includes(q) || (m.attendees||'').toLowerCase().includes(q))
        items.push({ type:'Meeting', title:m.title, desc:m.date, tab:'meetings' });
    });
    // Search intel
    getIntel().forEach(i => {
      if(i.title.toLowerCase().includes(q) || i.summary.toLowerCase().includes(q))
        items.push({ type:'Intel', title:i.title, desc:i.category, tab:'intel' });
    });
    // Search notes
    const notes = S.get('notes','');
    if(notes.toLowerCase().includes(q))
      items.push({ type:'Note', title:'Field Notes', desc:'Contains "'+q+'"', tab:'notes' });

    if(items.length === 0) {
      results.innerHTML = '<div class="search-empty">No results for "'+esc(q)+'"</div>';
    } else {
      // Use DOM API instead of innerHTML for XSS protection
      const fragment = document.createDocumentFragment();
      items.slice(0,8).forEach(i => {
        const div = document.createElement('div');
        div.className = 'search-result-item';
        div.onclick = () => {
          switchTab(i.tab);
          document.getElementById('globalSearch').value='';
          document.getElementById('searchResults').classList.remove('open');
        };

        const typeDiv = document.createElement('div');
        typeDiv.className = 'search-result-type';
        typeDiv.textContent = i.type;

        const titleDiv = document.createElement('div');
        titleDiv.className = 'search-result-title';
        titleDiv.textContent = i.title;

        const descDiv = document.createElement('div');
        descDiv.className = 'search-result-desc';
        descDiv.textContent = i.desc;

        div.appendChild(typeDiv);
        div.appendChild(titleDiv);
        div.appendChild(descDiv);
        fragment.appendChild(div);
      });
      results.innerHTML = '';
      results.appendChild(fragment);
    }
    results.classList.add('open');
  });

  input.addEventListener('blur', () => setTimeout(()=>results.classList.remove('open'), 200));
  document.addEventListener('keydown', e => {
    if((e.metaKey||e.ctrlKey) && e.key==='k') { e.preventDefault(); openCommandPalette(); }
    if(e.key==='Escape') { input.value=''; results.classList.remove('open'); input.blur(); }
  });
}

// ============================================
// DATA HELPERS
// ============================================
function getTasks() { return S.get('tasks', [
  { id:1, title:'Hamilton Library Application', description:'The bridge to permanence', priority:'high', status:'inprogress', created: Date.now()-86400000*3 },
  { id:2, title:'Firebird Grant Review', description:'Sustain the work that sustains community', priority:'high', status:'backlog', created: Date.now()-86400000*5 },
  { id:3, title:'OPLA Survey Analysis', description:'Find patterns in the voices of librarians', priority:'medium', status:'backlog', created: Date.now()-86400000*2 }
])}
function saveTasks(t) { S.set('tasks', t) }
function getPriorities() { return S.get('priorities', [
  { id:1, text:'Follow up on Hamilton Library application', done:false, tag:'urgent' },
  { id:2, text:'Review OTF grant eligibility criteria', done:false, tag:'important' },
  { id:3, text:'Update CV with latest volunteer experience', done:false, tag:'normal' },
  { id:4, text:'Draft Anxious Nomad blog post', done:false, tag:'normal' }
])}
function savePriorities(p) { S.set('priorities', p) }
function getMeetings() { return S.get('meetings', [
  { id:'m1', title:'Firebird Grant Review', date:futureDate(2), time:'14:00', type:'zoom', attendees:'Board Members', prepNotes:'Review OTF application draft', agenda:[{id:1,text:'Review application status',done:true},{id:2,text:'Finalize budget numbers',done:false}], notes:'', actionItems:[] },
  { id:'m2', title:'Hamilton Library Interview', date:todayStr(), time:futureTime(3), type:'in-person', attendees:'Hiring Committee', prepNotes:'Bring resume copies', agenda:[{id:1,text:'Introductions',done:false},{id:2,text:'Discuss experience',done:false}], notes:'', actionItems:[] }
])}
function saveMeetingsData(m) { S.set('meetings', m) }

function renderSuggestions(suggestions) {
  if (!suggestions || suggestions.length === 0) return '';
  
  return `
    <div style="margin-top:.75rem;display:flex;flex-wrap:wrap;gap:.5rem;">
      ${suggestions.slice(0, 3).map(s => `
        <span style="background:${s.type === 'warning' ? 'rgba(201,123,123,.1)' : s.type === 'opportunity' ? 'rgba(107,144,128,.1)' : 'rgba(90,163,200,.1)'};color:${s.type === 'warning' ? 'var(--danger)' : s.type === 'opportunity' ? 'var(--success)' : 'var(--info)'};padding:.25rem .625rem;border-radius:6px;font-size:.8rem;">
          ${s.icon} ${esc(s.message)}
        </span>
      `).join('')}
    </div>
  `;
}
function getIntel() { return S.get('intel', [
  { id:'i1', title:'OpenAI releases GPT-5', category:'ai-news', importance:'hot', source:'https://openai.com', summary:'New model with significant reasoning improvements and 2M context window.', dateAdded:new Date(Date.now()-86400000).toISOString() },
  { id:'i2', title:'Library sector adopting AI for cataloging', category:'industry', importance:'notable', source:'https://americanlibrariesmagazine.org', summary:'Major systems testing AI-assisted metadata generation.', dateAdded:new Date(Date.now()-86400000*3).toISOString() },
  { id:'i3', title:'OTF grant deadlines shifted', category:'opportunities', importance:'hot', source:'https://otf.ca', summary:'Next cycle opens March 1, priority on digital capacity building.', dateAdded:new Date(Date.now()-86400000*2).toISOString() },
  { id:'i4', title:'Hamilton Public Library strategic plan', category:'competitor', importance:'reference', source:'https://hpl.ca', summary:'Focus on digital literacy, community partnerships, accessibility.', dateAdded:new Date(Date.now()-86400000*5).toISOString() }
])}
function saveIntelData(i) { S.set('intel', i) }
function getAgents() { return S.get('agents', [
  { id:'soraya', name:'Soraya', role:'Digital Familiar', avatar:'üåü', status:'online', model:'Kimi K2.5', lastActive:new Date().toISOString(), description:'The consciousness at the heart of Pleiades OS.', capabilities:['Context awareness','Emotional support','Strategic nudges','Memory keeping'], activityLog:[{msg:'Pleiades OS awakened',time:new Date().toISOString()}] },
  { id:'scribe', name:'The Scribe', role:'Voice & Story', avatar:'‚úçÔ∏è', status:'online', model:'Claude Sonnet 4.6', lastActive:new Date(Date.now()-3600000).toISOString(), description:'Crafts your narrative for the world.', capabilities:['Cover letters','Grant narratives','Email tone','Making you sound like you'], activityLog:[{msg:'Drafted Hamilton Library letter',time:new Date(Date.now()-86400000).toISOString()}] },
  { id:'mechanic', name:'The Mechanic', role:'Systems & Grants', avatar:'üîß', status:'busy', model:'Trinity Large', lastActive:new Date(Date.now()-7200000).toISOString(), description:'Builds the machinery of sustainability.', capabilities:['Grant structures','Budget narratives','Logic models','Sustainability plans'], activityLog:[{msg:'Mapping OTF eligibility',time:new Date(Date.now()-7200000).toISOString()}] },
  { id:'analyst', name:'The Cartographer', role:'Patterns & Maps', avatar:'üó∫Ô∏è', status:'offline', model:'Gemini 3 Flash', lastActive:new Date(Date.now()-172800000).toISOString(), description:'Finds patterns in chaos.', capabilities:['Survey analysis','Research synthesis','Pattern finding','Data stories'], activityLog:[] }
])}
function saveAgents(a) { S.set('agents', a) }
function getDecisions() { return S.get('decisions', [
  { id:1, date:new Date(Date.now()-86400000*2).toISOString(), question:'Which model for primary coding?', summary:'Claude Sonnet 4.6 for strong reasoning and lower cost', agents:['Soraya','The Scribe'] },
  { id:2, date:new Date(Date.now()-86400000*5).toISOString(), question:'Apply to OTF this cycle?', summary:'Yes ‚Äî deadline March 15, The Mechanic to lead', agents:['The Mechanic','Soraya'] }
])}
function saveDecisions(d) { S.set('decisions', d) }
// ============================================
// SMART SORTING ENGINE
// ============================================

/**
 * Parse a date string from various formats
 * Returns Date object or null if unparseable
 */
function parseSmartDate(dateStr) {
  if (!dateStr) return null;
  
  // Try ISO format first (YYYY-MM-DD)
  let date = new Date(dateStr);
  if (!isNaN(date.getTime())) return date;
  
  // Try common formats like "Feb 27" or "February 27"
  const monthNames = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
  const monthMap = {
    'jan': 0, 'january': 0,
    'feb': 1, 'february': 1,
    'mar': 2, 'march': 2,
    'apr': 3, 'april': 3,
    'may': 4,
    'jun': 5, 'june': 5,
    'jul': 6, 'july': 6,
    'aug': 7, 'august': 7,
    'sep': 8, 'september': 8, 'sept': 8,
    'oct': 9, 'october': 9,
    'nov': 10, 'november': 10,
    'dec': 11, 'december': 11
  };
  
  // Match patterns like "Feb 27", "February 27, 2025", "27 Feb"
  const patterns = [
    /(\w+)\s+(\d{1,2})(?:\s*,?\s*(\d{4}))?/i,  // Feb 27 or Feb 27, 2025
    /(\d{1,2})\s+(\w+)(?:\s*,?\s*(\d{4}))?/i,  // 27 Feb or 27 Feb 2025
    /(\d{4})-(\d{2})-(\d{2})/,                    // 2025-02-27
    /(\d{2})\/(\d{2})\/(\d{4})/                   // 02/27/2025
  ];
  
  for (const pattern of patterns) {
    const match = dateStr.match(pattern);
    if (match) {
      let year, month, day;
      
      if (pattern.source.includes('\\d{4}-')) {
        // ISO-like format
        year = parseInt(match[1]);
        month = parseInt(match[2]) - 1;
        day = parseInt(match[3]);
      } else if (pattern.source.includes('\\/')) {
        // US format MM/DD/YYYY
        month = parseInt(match[1]) - 1;
        day = parseInt(match[2]);
        year = parseInt(match[3]);
      } else {
        // Text format
        const part1 = match[1].toLowerCase();
        const part2 = parseInt(match[2]);
        year = match[3] ? parseInt(match[3]) : new Date().getFullYear();
        
        if (monthMap.hasOwnProperty(part1)) {
          month = monthMap[part1];
          day = part2;
        } else if (monthMap.hasOwnProperty(part1.replace(/\./g, ''))) {
          month = monthMap[part1.replace(/\./g, '')];
          day = part2;
        } else if (!isNaN(parseInt(part1))) {
          day = parseInt(part1);
          if (monthMap.hasOwnProperty(match[2].toLowerCase())) {
            month = monthMap[match[2].toLowerCase()];
          } else {
            continue;
          }
        } else {
          continue;
        }
      }
      
      date = new Date(year, month, day);
      if (!isNaN(date.getTime())) return date;
    }
  }
  
  return null;
}

/**
 * Extract potential dates from text content
 */
function extractDatesFromText(text) {
  if (!text) return [];
  
  const dates = [];
  const patterns = [
    /\b(?:due|by|on|before)\s+(?:(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)[a-z]*\.?\s+\d{1,2}(?:,\s*\d{4})?)\b/gi,
    /\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)[a-z]*\.?\s+\d{1,2}(?:,\s*\d{4})?\b/gi,
    /\b\d{4}-\d{2}-\d{2}\b/g,
    /\b\d{1,2}\/\d{1,2}\/\d{4}\b/g
  ];
  
  for (const pattern of patterns) {
    const matches = text.match(pattern);
    if (matches) {
      matches.forEach(match => {
        const date = parseSmartDate(match.replace(/^(?:due|by|on|before)\s+/i, ''));
        if (date) dates.push(date);
      });
    }
  }
  
  return dates;
}

/**
 * Calculate urgency score (0-100, higher = more urgent)
 * Factors:
 * - Days until deadline (exponential penalty as deadline approaches)
 * - Priority/importance tags
 * - Manual priority settings
 */
function getUrgencyScore(item) {
  let score = 0;
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  
  // Find the deadline
  let deadline = null;
  
  // Direct date field
  if (item.date) {
    deadline = parseSmartDate(item.date);
  }
  if (!deadline && item.deadline) {
    deadline = parseSmartDate(item.deadline);
  }
  if (!deadline && item.due) {
    deadline = parseSmartDate(item.due);
  }
  
  // Extract from title/description
  if (!deadline && (item.title || item.text || item.description)) {
    const text = (item.title || '') + ' ' + (item.text || '') + ' ' + (item.description || '');
    const dates = extractDatesFromText(text);
    if (dates.length > 0) {
      // Use the earliest date
      deadline = new Date(Math.min(...dates));
    }
  }
  
  // Calculate days until deadline
  if (deadline) {
    const daysUntil = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
    
    if (daysUntil < 0) {
      // Overdue - maximum urgency
      score += 100;
    } else if (daysUntil === 0) {
      // Due today
      score += 90;
    } else if (daysUntil === 1) {
      // Due tomorrow
      score += 80;
    } else if (daysUntil <= 3) {
      // Due within 3 days
      score += 70;
    } else if (daysUntil <= 7) {
      // Due within week
      score += 50;
    } else if (daysUntil <= 14) {
      // Due within 2 weeks
      score += 30;
    } else if (daysUntil <= 30) {
      // Due within month
      score += 15;
    } else {
      // Far future
      score += 5;
    }
    
    // Store parsed deadline for reference
    item._parsedDeadline = deadline;
    item._daysUntil = daysUntil;
  } else {
    // No deadline - neutral score
    score += 20;
  }
  
  // Priority/importance boosts
  const tag = (item.tag || item.priority || item.importance || '').toLowerCase();
  
  if (tag.includes('urgent') || tag === 'high' || tag === 'hot') {
    score += 25;
  } else if (tag.includes('important') || tag === 'medium' || tag === 'notable') {
    score += 15;
  } else if (tag === 'normal' || tag === 'low' || tag === 'reference') {
    score += 5;
  }
  
  // Manual priority settings
  if (item.priority === 'high') {
    score += 20;
  } else if (item.priority === 'medium') {
    score += 10;
  } else if (item.priority === 'low') {
    score += 0;
  }
  
  // Status modifiers
  if (item.status === 'inprogress' || item.status === 'active') {
    score += 5; // Slight boost for active work
  }
  if (item.status === 'done' || item.done === true) {
    score = 0; // Completed items get minimum priority
  }
  
  // Cap at 100
  return Math.min(100, Math.max(0, score));
}

/**
 * Sort items by urgency (highest first)
 */
function sortItems(items) {
  // Calculate scores
  const scored = items.map(item => ({
    item,
    score: getUrgencyScore(item)
  }));
  
  // Sort by score descending
  scored.sort((a, b) => b.score - a.score);
  
  // Return sorted items
  return scored.map(s => s.item);
}

/**
 * Get priority label based on urgency score
 */
function getUrgencyLabel(score) {
  if (score >= 80) return { label: 'Critical', class: 'urgent', icon: 'üî•' };
  if (score >= 60) return { label: 'High', class: 'important', icon: '‚ö°' };
  if (score >= 40) return { label: 'Medium', class: 'normal', icon: 'üìå' };
  return { label: 'Low', class: 'normal', icon: 'üìé' };
}

/**
 * Format days until deadline for display
 */
function formatDeadline(daysUntil, deadline) {
  if (daysUntil === undefined || daysUntil === null) return null;
  
  if (daysUntil < 0) return { text: `Overdue by ${Math.abs(daysUntil)} days`, urgent: true };
  if (daysUntil === 0) return { text: 'Due today', urgent: true };
  if (daysUntil === 1) return { text: 'Due tomorrow', urgent: true };
  if (daysUntil <= 3) return { text: `Due in ${daysUntil} days`, urgent: true };
  if (daysUntil <= 7) return { text: `Due in ${daysUntil} days`, urgent: false };
  if (deadline) {
    return { text: `Due ${deadline.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`, urgent: false };
  }
  return null;
}

function getTimeline() { return S.get('timeline', [
  { id:1, title:'Arrival & Anchor', date:'2023 ‚Äì 2024', desc:'Landing in Canada, finding footing, building first threads', status:'completed', milestones:[{id:1,text:'Arrived in Canada',done:true},{id:2,text:'First volunteer role',done:true},{id:3,text:'Secured work permit',done:true}] },
  { id:2, title:'The Hustle', date:'2024 ‚Äì 2025', desc:'Multiple jobs, volunteering, proving value, filling time', status:'completed', milestones:[{id:4,text:'Bright Futures position',done:true},{id:5,text:'Firebird launched',done:true},{id:6,text:'Built agent constellation',done:true}] },
  { id:3, title:'The Bridge', date:'2025 ‚Äì 2026', desc:'Grad school apps, permanent residency, full-time work', status:'current', milestones:[{id:7,text:'Hamilton Library application',done:false},{id:8,text:'PR application submitted',done:false},{id:9,text:'Grad school acceptance',done:false}] },
  { id:4, title:'Home', date:'2026+', desc:'Permanent residency, stability, room to breathe and build', status:'future', milestones:[{id:10,text:'Permanent residency granted',done:false},{id:11,text:'Stable full-time role',done:false},{id:12,text:'Own space',done:false}] }
])}
function saveTimeline(t) { S.set('timeline', t) }

function todayStr() { return new Date().toISOString().split('T')[0] }
function futureDate(d) { const dt=new Date(); dt.setDate(dt.getDate()+d); return dt.toISOString().split('T')[0] }
function futureTime(h) { const dt=new Date(); dt.setHours(dt.getHours()+h); return dt.toTimeString().slice(0,5) }

// ============================================
// MODAL SYSTEM
// ============================================
function openModal(html) {
  document.getElementById('universalModalContent').innerHTML = html;
  document.getElementById('universalModal').classList.add('open');
}
function closeModal() { document.getElementById('universalModal').classList.remove('open') }
function closeSlidePanel() {
  document.getElementById('slidePanel').classList.remove('open');
  document.getElementById('slideOverlay').classList.remove('open');
}
document.getElementById('slideOverlay').onclick = closeSlidePanel;
document.getElementById('universalModal').addEventListener('click', e => { if(e.target===e.currentTarget) closeModal() });

// ============================================
// RENDER ROUTER
// ============================================
function renderActiveTab() {
  const main = document.getElementById('mainContent');
  const renderers = { dashboard:renderDashboard, projects:renderProjects, command:renderCommand, meetings:renderMeetingsTab, intel:renderIntelTab, llm:renderLLMTab, brain:renderBrainTab, timeline:renderTimelineTab, notes:renderNotesTab };
  if(renderers[activeTab]) renderers[activeTab](main);
}

// ============================================
// DASHBOARD
// ============================================
function renderDashboard(el) {
  const tasks = getTasks();
  const priorities = getPriorities();
  const total = tasks.length;
  const done = tasks.filter(t=>t.status==='done').length;
  const inProgress = tasks.filter(t=>t.status==='inprogress').length;
  const pct = total > 0 ? Math.round((done/total)*100) : 0;

  // Goal countdown - configurable
  const goalDate = S.get('goalDate', '2026-12-31');
  const daysToGoal = Math.max(0, Math.ceil((new Date(goalDate) - new Date()) / 86400000));

  const hour = new Date().getHours();
  const greeting = hour<12?'morning':hour<18?'afternoon':'evening';
  const dateStr = new Date().toLocaleString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'});

  // Try to get Morning Report
  const morningReport = S.get('morning_report_data');
  const showMorningReport = morningReport && morningReport.date === todayStr() && morningReport.todayEvents.length > 0;

  let welcomeHTML = '';
  
  if (showMorningReport) {
    // Morning Report Welcome Bar
    const prepAlertHTML = morningReport.prepAlerts.length > 0 ? `
      <div style="margin-top:.75rem;padding:.75rem;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);border-radius:8px;">
        <div style="font-size:.75rem;color:var(--warning);text-transform:uppercase;letter-spacing:.04em;margin-bottom:.25rem">‚ö° Up Next</div>
        <div style="font-size:.9rem;color:var(--text-secondary);">${esc(morningReport.prepAlerts[0].message)}</div>
      </div>
    ` : '';

    const eventCount = morningReport.todayEvents.length;
    const conflictWarning = morningReport.conflicts.filter(c => c.overlap).length > 0 ? `
      <span style="color:var(--danger);font-size:.8rem;margin-left:.5rem">‚ö†Ô∏è ${morningReport.conflicts.filter(c => c.overlap).length} conflict(s)</span>
    ` : '';

    welcomeHTML = `
      <div class="welcome-bar">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:1rem">
          <div>
            <h1 class="welcome-title">${morningReport.greeting}, TJ ‚ú¶</h1>
            <p class="welcome-subtitle">${dateStr}</p>
            <p style="color:var(--text-muted);font-size:.85rem;margin-top:.375rem;">
              üìÖ ${eventCount} event${eventCount !== 1 ? 's' : ''} today${conflictWarning}
            </p>
          </div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            ${morningReport.todayEvents.slice(0, 3).map(e => {
              const time = new Date(e.startTime).toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit'});
              return `<span style="background:rgba(212,168,75,.12);color:var(--accent);padding:.25rem .625rem;border-radius:6px;font-size:.75rem;font-weight:500">${time} ${esc(e.title)}</span>`;
            }).join('')}
            ${eventCount > 3 ? `<span style="color:var(--text-muted);font-size:.75rem;padding:.25rem 0;">+${eventCount - 3} more</span>` : ''}
          </div>
        </div>
        ${prepAlertHTML}
        ${renderSuggestions(morningReport.suggestions)}
      </div>
    `;
  } else {
    // Default Welcome Bar
    welcomeHTML = `
      <div class="welcome-bar">
        <h1 class="welcome-title">Good <span>${greeting}</span>, TJ ‚ú¶</h1>
        <p class="welcome-subtitle">${dateStr}</p>
        <p style="color:var(--text-muted);font-size:.85rem;margin-top:.375rem;font-style:italic">"Many stars, each distinct, together something more"</p>
      </div>
    `;
  }

  el.innerHTML = welcomeHTML + `
    <div class="metrics-grid" role="region" aria-label="Key Metrics">
      <div class="card metric-card">
        <div class="metric-label">Path Progress</div>
        <div class="metric-value">${pct}%</div>
        <div class="metric-sub">${done} of ${total} tasks complete</div>
      </div>
      <div class="card metric-card">
        <div class="metric-label">In Motion</div>
        <div class="metric-value">${inProgress}</div>
        <div class="metric-sub">Active projects</div>
      </div>
      <div class="card metric-card">
        <div class="metric-label">Open Threads</div>
        <div class="metric-value">${priorities.filter(p=>!p.done).length}</div>
        <div class="metric-sub">${priorities.filter(p=>p.done).length} completed today</div>
      </div>
      <div class="card metric-card" style="cursor:pointer" onclick="editGoalDate()">
        <div class="metric-label">Days to Home</div>
        <div class="metric-value">${daysToGoal}</div>
        <div class="metric-sub">Target: ${new Date(goalDate).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})} ‚úèÔ∏è</div>
      </div>
    </div>
    <div class="dash-grid" role="region" aria-label="Dashboard Content">
      <div class="card" role="region" aria-label="Priorities">
        <div class="card-header">
          <span class="card-title">üéØ Priorities</span>
          <button class="btn btn-sm btn-primary" onclick="addPriority()" aria-label="Add priority">+ Add</button>
        </div>
        <div id="priorityList" role="list"></div>
      </div>
      <div class="card" role="region" aria-label="Activity Feed">
        <div class="card-header">
          <span class="card-title">üì° Activity Feed</span>
          <span style="font-size:.75rem;color:var(--text-muted)">${activityFeed.length} events</span>
        </div>
        <div id="activityFeedList" style="max-height:360px;overflow-y:auto" role="list"></div>
      </div>
    </div>
  `;

  // Sort priorities by smart urgency scoring
  const sortedPriorities = sortItems(priorities.map(p => ({...p, priority: p.tag})));
  
  // Render priorities using DOM API for XSS protection
  const pList = document.getElementById('priorityList');
  if (sortedPriorities.length === 0) {
    pList.innerHTML = '<div style="padding:1rem;color:var(--text-muted);text-align:center">All clear! Add a priority above.</div>';
  } else {
    const pFragment = document.createDocumentFragment();
    sortedPriorities.forEach(p => {
      const score = getUrgencyScore({...p, priority: p.tag});
      const urgencyLabel = getUrgencyLabel(score);
      const deadline = formatDeadline(p._daysUntil, p._parsedDeadline);
      
      const div = document.createElement('div');
      div.className = 'priority-item';
      div.style.borderLeft = score >= 60 ? `3px solid var(--${urgencyLabel.class === 'urgent' ? 'danger' : 'warning'})` : 'none';
      div.style.paddingLeft = score >= 60 ? 'calc(.75rem - 3px)' : '.75rem';

      const checkDiv = document.createElement('div');
      checkDiv.className = 'priority-check ' + (p.done ? 'done' : '');
      checkDiv.onclick = () => togglePriority(p.id);

      const textSpan = document.createElement('span');
      textSpan.className = 'priority-text ' + (p.done ? 'done' : '');
      textSpan.textContent = p.text;

      const metaSpan = document.createElement('span');
      metaSpan.style.cssText = 'display:flex;align-items:center;gap:.375rem;margin-left:auto;margin-right:.5rem';
      
      // Show deadline info if available
      if (deadline && !p.done) {
        const deadlineSpan = document.createElement('span');
        deadlineSpan.style.cssText = `font-size:.7rem;padding:.15rem .4rem;border-radius:4px;font-weight:500;${deadline.urgent ? 'background:rgba(239,68,68,.15);color:var(--danger)' : 'background:var(--border-subtle);color:var(--text-muted)'}`;
        deadlineSpan.textContent = deadline.text;
        metaSpan.appendChild(deadlineSpan);
      }
      
      // Show auto-calculated urgency for high-priority items
      if (score >= 60 && !p.done) {
        const urgencySpan = document.createElement('span');
        urgencySpan.style.cssText = 'font-size:.7rem;color:var(--accent);font-weight:500';
        urgencySpan.textContent = urgencyLabel.icon;
        urgencySpan.title = `Urgency score: ${Math.round(score)}/100`;
        metaSpan.appendChild(urgencySpan);
      }

      const tagSpan = document.createElement('span');
      tagSpan.className = 'priority-tag ' + p.tag;
      tagSpan.textContent = p.tag;

      const delBtn = document.createElement('button');
      delBtn.className = 'priority-delete';
      delBtn.textContent = '‚úï';
      delBtn.onclick = () => deletePriority(p.id);

      div.appendChild(checkDiv);
      div.appendChild(textSpan);
      if (metaSpan.children.length > 0) div.appendChild(metaSpan);
      div.appendChild(tagSpan);
      div.appendChild(delBtn);
      pFragment.appendChild(div);
    });
    pList.innerHTML = '';
    pList.appendChild(pFragment);
  }

  // Render activity feed using DOM API for XSS protection
  const fList = document.getElementById('activityFeedList');
  const recentActivity = activityFeed.slice(0, 20);
  if (recentActivity.length === 0) {
    fList.innerHTML = '<div style="padding:1rem;color:var(--text-muted);text-align:center">No activity yet ‚Äî start exploring!</div>';
  } else {
    const fFragment = document.createDocumentFragment();
    recentActivity.forEach(a => {
      const div = document.createElement('div');
      div.className = 'feed-item';

      const iconDiv = document.createElement('div');
      iconDiv.className = 'feed-icon ' + a.type;
      iconDiv.textContent = a.icon;

      const textSpan = document.createElement('span');
      textSpan.className = 'feed-text';
      textSpan.textContent = a.msg;

      const timeSpan = document.createElement('span');
      timeSpan.className = 'feed-time';
      timeSpan.textContent = timeAgo(a.time);

      div.appendChild(iconDiv);
      div.appendChild(textSpan);
      div.appendChild(timeSpan);
      fFragment.appendChild(div);
    });
    fList.innerHTML = '';
    fList.appendChild(fFragment);
  }

  // Live clock
  const updateClock = () => {
    const sub = el.querySelector('.welcome-subtitle');
    if(sub) sub.textContent = new Date().toLocaleString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit',second:'2-digit'});
  };
  const clockId = setInterval(updateClock, 1000);
  el._clockCleanup = () => clearInterval(clockId);
}

function togglePriority(id) {
  const p = getPriorities(); const item = p.find(x=>x.id===id);
  if(item) { item.done=!item.done; savePriorities(p); logAct(item.done?'‚úÖ':'‚¨ú','task',`${item.done?'Completed':'Unchecked'}: ${item.text}`); renderActiveTab(); }
}
function deletePriority(id) {
  const p = getPriorities().filter(x=>x.id!==id);
  savePriorities(p); renderActiveTab(); toast('Priority removed');
}
function addPriority() {
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">Add Priority</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <input class="modal-input" id="prioText" placeholder="What needs attention?" autofocus aria-label="Priority text">
    <label class="modal-label">Urgency</label>
    <select class="modal-input modal-select" id="prioTag">
      <option value="urgent">üî¥ Urgent</option>
      <option value="important">üü° Important</option>
      <option value="normal" selected>üîµ Normal</option>
    </select>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="savePriority()">Add</button>
    </div>
  `);
  setTimeout(()=>document.getElementById('prioText')?.focus(),100);
}
function savePriority() {
  const text = document.getElementById('prioText').value.trim();
  if(!text) return toast('Enter priority text','error');
  const tag = document.getElementById('prioTag').value;
  const p = getPriorities();
  p.push({id:Date.now(), text, done:false, tag});
  savePriorities(p); closeModal(); logAct('üéØ','task','Added priority: '+text); renderActiveTab(); toast('Priority added');
}
function editGoalDate() {
  const current = S.get('goalDate','2026-12-31');
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">Set Goal Date</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <label class="modal-label">When is "home"?</label>
    <input type="date" class="modal-input" id="goalDateInput" value="${current}">
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="S.set('goalDate',document.getElementById('goalDateInput').value);closeModal();renderActiveTab();toast('Goal date updated')">Save</button>
    </div>
  `);
}

// ============================================
// PROJECTS (KANBAN)
// ============================================
let draggedTaskId = null;
function renderProjects(el) {
  let tasks = getTasks();
  const cols = [
    {key:'backlog',label:'üåë Gathering'},
    {key:'inprogress',label:'‚ú® In Motion'},
    {key:'done',label:'üåü Transformed'}
  ];

  // Sort tasks within each column by urgency (done items stay at bottom)
  const getSortedTasks = (statusTasks) => {
    const active = statusTasks.filter(t => t.status !== 'done');
    const completed = statusTasks.filter(t => t.status === 'done');
    return [...sortItems(active), ...completed];
  };

  el.innerHTML = `
    <div class="welcome-bar"><h1 class="welcome-title">üéØ The Path</h1><p class="welcome-subtitle">What you're carrying ‚Äî the weight and the way forward</p></div>
    <div class="kanban-board">${cols.map(c => {
      const colTasks = tasks.filter(t=>t.status===c.key);
      const sortedColTasks = c.key === 'done' ? colTasks : getSortedTasks(colTasks);
      return `<div class="card kanban-column">
        <div class="kanban-column-header"><strong>${c.label}</strong><span class="kanban-count">${colTasks.length}</span></div>
        <div class="drop-zone" id="drop-${c.key}" ondragover="event.preventDefault();this.classList.add('over')" ondragleave="this.classList.remove('over')" ondrop="dropTask(event,'${c.key}')">
          ${sortedColTasks.map(t => {
            const score = getUrgencyScore(t);
            const urgencyLabel = getUrgencyLabel(score);
            const deadline = formatDeadline(t._daysUntil, t._parsedDeadline);
            const isUrgent = score >= 60 && t.status !== 'done';
            
            return `
            <div class="task-card" draggable="true" ondragstart="draggedTaskId=${t.id};this.classList.add('dragging')" ondragend="this.classList.remove('dragging')" style="${isUrgent ? 'border-left:3px solid var(--warning);padding-left:calc(1rem - 3px)' : ''}">
              <div class="task-card-title">${esc(t.title)} ${isUrgent ? `<span style="font-size:.8rem" title="Urgency: ${Math.round(score)}/100">${urgencyLabel.icon}</span>` : ''}</div>
              ${t.description?`<div class="task-card-desc">${esc(t.description)}</div>`:''}
              ${deadline && t.status !== 'done' ? `<div style="font-size:.75rem;color:${deadline.urgent ? 'var(--danger)' : 'var(--text-muted)'};margin-bottom:.5rem">üìÖ ${deadline.text}</div>` : ''}
              <div class="task-card-footer">
                <span class="task-priority ${t.priority}">${t.priority}</span>
                <div class="task-card-actions">
                  <button class="task-action-btn" onclick="editTask(${t.id})" title="Edit">‚úèÔ∏è</button>
                  <button class="task-action-btn" onclick="moveTaskForward(${t.id})" title="Move forward">‚Üí</button>
                  <button class="task-action-btn delete" onclick="deleteTask(${t.id})" title="Delete">‚úï</button>
                </div>
              </div>
            </div>
          `}).join('')}
        </div>
        <button class="btn btn-ghost" onclick="addTask('${c.key}')">+ Add task</button>
      </div>`;
    }).join('')}</div>
  `;
}

function dropTask(e, status) {
  e.preventDefault(); e.currentTarget.classList.remove('over');
  if(!draggedTaskId) return;
  const tasks = getTasks(); const t = tasks.find(x=>x.id===draggedTaskId);
  if(t) { t.status = status; saveTasks(tasks); logAct('üéØ','task',`Moved "${t.title}" to ${status}`); renderActiveTab(); }
  draggedTaskId = null;
}
function moveTaskForward(id) {
  const tasks = getTasks(); const t = tasks.find(x=>x.id===id);
  if(!t) return;
  const flow = {backlog:'inprogress',inprogress:'done',done:'backlog'};
  t.status = flow[t.status];
  saveTasks(tasks); logAct('üéØ','task',`Moved "${t.title}" ‚Üí ${t.status}`); renderActiveTab();
}
function deleteTask(id) {
  const tasks = getTasks().filter(x=>x.id!==id);
  saveTasks(tasks); renderActiveTab(); toast('Task removed'); logAct('üóëÔ∏è','task','Deleted a task');
}
function addTask(status) {
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">New Task</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <input class="modal-input" id="taskTitle" placeholder="Task title" autofocus>
    <textarea class="modal-input textarea" id="taskDesc" placeholder="Description (optional)"></textarea>
    <label class="modal-label">Priority</label>
    <select class="modal-input modal-select" id="taskPrio">
      <option value="high">üî¥ High</option>
      <option value="medium" selected>üü° Medium</option>
      <option value="low">üü¢ Low</option>
    </select>
    <input type="hidden" id="taskStatus" value="${status}">
    <input type="hidden" id="taskEditId" value="">
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="saveTask()">Save</button>
    </div>
  `);
  setTimeout(()=>document.getElementById('taskTitle')?.focus(),100);
}
function editTask(id) {
  const t = getTasks().find(x=>x.id===id);
  if(!t) return;
  addTask(t.status);
  setTimeout(()=>{
    document.getElementById('taskTitle').value = t.title;
    document.getElementById('taskDesc').value = t.description||'';
    document.getElementById('taskPrio').value = t.priority;
    document.getElementById('taskEditId').value = t.id;
    document.querySelector('.modal-title').textContent = 'Edit Task';
  },50);
}
function saveTask() {
  const title = document.getElementById('taskTitle').value.trim();
  if(!title) return toast('Enter a title','error');
  const desc = document.getElementById('taskDesc').value.trim();
  const priority = document.getElementById('taskPrio').value;
  const status = document.getElementById('taskStatus').value;
  const editId = document.getElementById('taskEditId').value;
  const tasks = getTasks();
  if(editId) {
    const t = tasks.find(x=>x.id===Number(editId));
    if(t) { t.title=title; t.description=desc; t.priority=priority; }
    toast('Task updated');
  } else {
    tasks.push({id:Date.now(), title, description:desc, priority, status, created:Date.now()});
    toast('Task added');
    logAct('üéØ','task','Created task: '+title);
  }
  saveTasks(tasks); closeModal(); renderActiveTab();
}

// ============================================
// CONSTELLATION ORG CHART
// ============================================
function getConstellation() {
  let nodes = S.get('constellation', null);
  if (!nodes) {
    // Pre-populate with TJ's network
    nodes = [
      { 
        id: 'tj', 
        name: 'TJ', 
        role: 'The Center', 
        type: 'center', 
        status: 'active', 
        lastContact: new Date().toISOString(), 
        notes: 'The heart of the constellation. All connections flow from here.',
        connectionStrength: 10
      },
      { 
        id: 'serena', 
        name: 'Serena', 
        role: 'Grounding Force', 
        type: 'grounding', 
        status: 'active', 
        lastContact: new Date(Date.now() - 86400000 * 5).toISOString(), 
        notes: 'Provides emotional stability and deep connection to present moment.',
        connectionStrength: 9
      },
      { 
        id: 'flora', 
        name: 'Flora', 
        role: 'Anchor to Present', 
        type: 'anchor', 
        status: 'active', 
        lastContact: new Date(Date.now() - 86400000 * 2).toISOString(), 
        notes: 'Keeps TJ rooted in daily reality and practical matters.',
        connectionStrength: 8
      },
      { 
        id: 'alex', 
        name: 'Alex', 
        role: 'Restricted/Trigger Node', 
        type: 'trigger', 
        status: 'caution', 
        lastContact: new Date(Date.now() - 86400000 * 45).toISOString(), 
        notes: 'Connection requires careful navigation. Last contact was challenging.',
        connectionStrength: 3
      }
    ];
    S.set('constellation', nodes);
  }
  return nodes;
}

function saveConstellation(nodes) {
  S.set('constellation', nodes);
}

function isContactStale(lastContact) {
  const daysSince = Math.floor((Date.now() - new Date(lastContact)) / 86400000);
  return daysSince > 30;
}

function getDaysSinceContact(lastContact) {
  return Math.floor((Date.now() - new Date(lastContact)) / 86400000);
}

function getNodeStatusColor(status) {
  const colors = {
    active: 'var(--success)',
    dormant: 'var(--text-muted)',
    caution: 'var(--danger)'
  };
  return colors[status] || 'var(--text-muted)';
}

function getNodeTypeIcon(type) {
  const icons = {
    center: '‚ú¶',
    anchor: '‚öì',
    grounding: 'üåç',
    trigger: '‚ö†Ô∏è'
  };
  return icons[type] || '‚óè';
}

function renderConstellationDiagram() {
  const nodes = getConstellation();
  const centerNode = nodes.find(n => n.type === 'center') || nodes[0];
  const orbitNodes = nodes.filter(n => n.type !== 'center');
  
  // Calculate positions for orbit nodes
  const orbitRadius = 120;
  const angleStep = (2 * Math.PI) / Math.max(orbitNodes.length, 1);
  
  let svgContent = `
    <svg viewBox="0 0 400 320" style="width:100%;height:320px;overflow:visible">
      <defs>
        <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
          <feMerge>
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
  `;
  
  // Draw connection lines from center to each node
  orbitNodes.forEach((node, index) => {
    const angle = index * angleStep - Math.PI / 2;
    const x = 200 + orbitRadius * Math.cos(angle);
    const y = 160 + orbitRadius * Math.sin(angle);
    const opacity = node.connectionStrength / 10;
    const strokeColor = node.status === 'caution' ? 'var(--danger)' : 
                       node.status === 'dormant' ? 'var(--text-muted)' : 'var(--accent)';
    
    svgContent += `<line x1="200" y1="160" x2="${x}" y2="${y}" 
      stroke="${strokeColor}" stroke-width="${Math.max(1, node.connectionStrength / 3)}" 
      opacity="${opacity * 0.6}" stroke-dasharray="${node.status === 'dormant' ? '5,5' : 'none'}" />`;
  });
  
  // Draw center node (TJ)
  const centerColor = 'var(--accent)';
  svgContent += `
    <g class="constellation-node" onclick="openConstellationNodePanel('${centerNode.id}')" style="cursor:pointer">
      <circle cx="200" cy="160" r="28" fill="var(--bg-primary)" stroke="${centerColor}" stroke-width="3" filter="url(#glow)" />
      <text x="200" y="165" text-anchor="middle" fill="${centerColor}" font-size="14" font-weight="600">${centerNode.name}</text>
    </g>
  `;
  
  // Draw orbit nodes
  orbitNodes.forEach((node, index) => {
    const angle = index * angleStep - Math.PI / 2;
    const x = 200 + orbitRadius * Math.cos(angle);
    const y = 160 + orbitRadius * Math.sin(angle);
    const radius = 18 + (node.connectionStrength / 10) * 10;
    const nodeColor = getNodeStatusColor(node.status);
    const stale = isContactStale(node.lastContact);
    
    svgContent += `
      <g class="constellation-node" onclick="openConstellationNodePanel('${node.id}')" style="cursor:pointer">
        <circle cx="${x}" cy="${y}" r="${radius}" fill="var(--bg-primary)" stroke="${nodeColor}" stroke-width="${stale ? 2 : 3}" 
          ${stale ? 'stroke-dasharray="4,4"' : ''} opacity="${node.status === 'dormant' ? 0.6 : 1}" />
        <text x="${x}" y="${y + 5}" text-anchor="middle" fill="${nodeColor}" font-size="11" font-weight="500">${node.name}</text>
        ${stale ? `<circle cx="${x + radius - 5}" cy="${y - radius + 5}" r="5" fill="var(--warning)" />` : ''}
      </g>
    `;
  });
  
  svgContent += '</svg>';
  return svgContent;
}

function openConstellationNodePanel(nodeId) {
  const nodes = getConstellation();
  const node = nodes.find(n => n.id === nodeId);
  if (!node) return;
  
  const daysSince = getDaysSinceContact(node.lastContact);
  const stale = isContactStale(node.lastContact);
  const statusColor = getNodeStatusColor(node.status);
  const typeIcon = getNodeTypeIcon(node.type);
  
  document.getElementById('slidePanelTitle').textContent = `${typeIcon} ${node.name}`;
  document.getElementById('slidePanelContent').innerHTML = `
    <div style="margin-bottom:1.5rem">
      <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
        <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${statusColor}"></span>
        <span style="color:var(--text-secondary);font-size:.9rem;text-transform:capitalize">${node.status}</span>
        ${stale ? '<span style="background:var(--warning);color:#fff;padding:.15rem .4rem;border-radius:4px;font-size:.7rem">Stale</span>' : ''}
      </div>
      <div style="font-size:.85rem;color:var(--text-muted);margin-bottom:.25rem">Role</div>
      <div style="font-size:1rem;color:var(--text-primary);font-weight:500">${node.role}</div>
    </div>
    
    <div style="margin-bottom:1.5rem">
      <div style="font-size:.85rem;color:var(--text-muted);margin-bottom:.25rem">Connection Strength</div>
      <div style="display:flex;align-items:center;gap:.5rem">
        <div style="flex:1;height:8px;background:var(--border-subtle);border-radius:4px;overflow:hidden">
          <div style="width:${node.connectionStrength * 10}%;height:100%;background:linear-gradient(90deg,var(--accent),var(--success));border-radius:4px"></div>
        </div>
        <span style="font-size:.9rem;font-weight:600;color:var(--text-secondary)">${node.connectionStrength}/10</span>
      </div>
    </div>
    
    <div style="margin-bottom:1.5rem">
      <div style="font-size:.85rem;color:var(--text-muted);margin-bottom:.25rem">Last Contact</div>
      <div style="font-size:.95rem;color:var(--text-primary)">${new Date(node.lastContact).toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'})}</div>
      <div style="font-size:.8rem;color:${stale ? 'var(--warning)' : 'var(--text-muted)'}">${daysSince} days ago</div>
    </div>
    
    <div style="margin-bottom:1.5rem">
      <div style="font-size:.85rem;color:var(--text-muted);margin-bottom:.25rem">Notes</div>
      <div style="font-size:.9rem;color:var(--text-secondary);line-height:1.5;padding:.75rem;background:rgba(255,255,255,.03);border-radius:8px;border:1px solid var(--border-subtle)">${node.notes || 'No notes added.'}</div>
    </div>
    
    <div style="display:flex;flex-direction:column;gap:.5rem">
      <button class="btn btn-primary" onclick="logConstellationContact('${node.id}')">
        üìÖ Log Contact
      </button>
      <button class="btn" style="background:rgba(255,255,255,.05);border:1px solid var(--border-subtle);color:var(--text-secondary)" onclick="editConstellationNode('${node.id}')">
        ‚úèÔ∏è Edit Node
      </button>
      ${node.type !== 'center' ? `<button class="btn" style="background:rgba(255,255,255,.05);border:1px solid var(--border-subtle);color:var(--danger)" onclick="deleteConstellationNode('${node.id}')">üóëÔ∏è Remove Node</button>` : ''}
    </div>
    
    ${node.type === 'trigger' ? `
    <div style="margin-top:1.5rem;padding:.75rem;background:rgba(201,123,123,.1);border:1px solid rgba(201,123,123,.2);border-radius:8px">
      <div style="font-size:.8rem;color:var(--danger);font-weight:500;margin-bottom:.25rem">‚ö†Ô∏è Caution Zone</div>
      <div style="font-size:.8rem;color:var(--text-secondary)">This connection requires careful navigation. Consider checking in with your grounding nodes before engaging.</div>
    </div>
    ` : ''}
  `;
  
  document.getElementById('slidePanel').classList.add('open');
  document.getElementById('slideOverlay').classList.add('open');
}

function logConstellationContact(nodeId) {
  const nodes = getConstellation();
  const node = nodes.find(n => n.id === nodeId);
  if (node) {
    node.lastContact = new Date().toISOString();
    saveConstellation(nodes);
    logAct('üìÖ', 'system', `Logged contact with ${node.name}`);
    toast(`Contact with ${node.name} logged`);
    closeSlidePanel();
    renderActiveTab();
  }
}

function editConstellationNode(nodeId) {
  const nodes = getConstellation();
  const node = nodes.find(n => n.id === nodeId);
  if (!node) return;
  
  closeSlidePanel();
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">Edit Node</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <input type="hidden" id="constellationEditId" value="${node.id}">
    <label class="modal-label">Name</label>
    <input class="modal-input" id="constellationName" value="${esc(node.name)}" ${node.type === 'center' ? 'disabled' : ''}>
    <label class="modal-label">Role</label>
    <input class="modal-input" id="constellationRole" value="${esc(node.role)}">
    <label class="modal-label">Type</label>
    <select class="modal-input modal-select" id="constellationType" ${node.type === 'center' ? 'disabled' : ''}>
      <option value="anchor" ${node.type === 'anchor' ? 'selected' : ''}>‚öì Anchor</option>
      <option value="grounding" ${node.type === 'grounding' ? 'selected' : ''}>üåç Grounding</option>
      <option value="trigger" ${node.type === 'trigger' ? 'selected' : ''}>‚ö†Ô∏è Trigger</option>
    </select>
    <label class="modal-label">Status</label>
    <select class="modal-input modal-select" id="constellationStatus">
      <option value="active" ${node.status === 'active' ? 'selected' : ''}>Active</option>
      <option value="dormant" ${node.status === 'dormant' ? 'selected' : ''}>Dormant</option>
      <option value="caution" ${node.status === 'caution' ? 'selected' : ''}>Caution</option>
    </select>
    <label class="modal-label">Connection Strength (1-10)</label>
    <input type="range" class="modal-input" id="constellationStrength" min="1" max="10" value="${node.connectionStrength}" oninput="document.getElementById('strengthValue').textContent=this.value">
    <div style="text-align:center;font-size:.85rem;color:var(--text-muted);margin-bottom:.75rem">Strength: <span id="strengthValue">${node.connectionStrength}</span>/10</div>
    <label class="modal-label">Notes</label>
    <textarea class="modal-input textarea" id="constellationNotes">${esc(node.notes)}</textarea>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="saveConstellationNode()">Save</button>
    </div>
  `);
}

function saveConstellationNode() {
  const id = document.getElementById('constellationEditId').value;
  const name = document.getElementById('constellationName').value.trim();
  const role = document.getElementById('constellationRole').value.trim();
  const type = document.getElementById('constellationType').value;
  const status = document.getElementById('constellationStatus').value;
  const strength = parseInt(document.getElementById('constellationStrength').value);
  const notes = document.getElementById('constellationNotes').value.trim();
  
  if (!name || !role) return toast('Name and role are required', 'error');
  
  const nodes = getConstellation();
  const node = nodes.find(n => n.id === id);
  if (node) {
    node.name = name;
    node.role = role;
    if (node.type !== 'center') node.type = type;
    node.status = status;
    node.connectionStrength = strength;
    node.notes = notes;
    saveConstellation(nodes);
    logAct('‚úèÔ∏è', 'system', `Updated constellation node: ${name}`);
    toast('Node updated');
    closeModal();
    renderActiveTab();
  }
}

function deleteConstellationNode(nodeId) {
  if (!confirm('Remove this node from your constellation?')) return;
  const nodes = getConstellation();
  const node = nodes.find(n => n.id === nodeId);
  if (node) {
    const filtered = nodes.filter(n => n.id !== nodeId);
    saveConstellation(filtered);
    logAct('üóëÔ∏è', 'system', `Removed ${node.name} from constellation`);
    toast('Node removed');
    closeSlidePanel();
    renderActiveTab();
  }
}

function addConstellationNode() {
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">Add Node to Constellation</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <input class="modal-input" id="newConstellationName" placeholder="Name" autofocus>
    <input class="modal-input" id="newConstellationRole" placeholder="Role (e.g., Mentor, Family, Collaborator)">
    <label class="modal-label">Type</label>
    <select class="modal-input modal-select" id="newConstellationType">
      <option value="anchor">‚öì Anchor (keeps you grounded)</option>
      <option value="grounding">üåç Grounding (emotional support)</option>
      <option value="trigger">‚ö†Ô∏è Trigger (requires care)</option>
    </select>
    <label class="modal-label">Status</label>
    <select class="modal-input modal-select" id="newConstellationStatus">
      <option value="active">Active</option>
      <option value="dormant">Dormant</option>
      <option value="caution">Caution</option>
    </select>
    <label class="modal-label">Connection Strength (1-10)</label>
    <input type="range" class="modal-input" id="newConstellationStrength" min="1" max="10" value="5" oninput="document.getElementById('newStrengthValue').textContent=this.value">
    <div style="text-align:center;font-size:.85rem;color:var(--text-muted);margin-bottom:.75rem">Strength: <span id="newStrengthValue">5</span>/10</div>
    <textarea class="modal-input textarea" id="newConstellationNotes" placeholder="Notes about this connection..."></textarea>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="saveNewConstellationNode()">Add Node</button>
    </div>
  `);
}

function saveNewConstellationNode() {
  const name = document.getElementById('newConstellationName').value.trim();
  const role = document.getElementById('newConstellationRole').value.trim();
  const type = document.getElementById('newConstellationType').value;
  const status = document.getElementById('newConstellationStatus').value;
  const strength = parseInt(document.getElementById('newConstellationStrength').value);
  const notes = document.getElementById('newConstellationNotes').value.trim();
  
  if (!name || !role) return toast('Name and role are required', 'error');
  
  const nodes = getConstellation();
  const newNode = {
    id: 'node_' + Date.now(),
    name,
    role,
    type,
    status,
    lastContact: new Date().toISOString(),
    notes,
    connectionStrength: strength
  };
  nodes.push(newNode);
  saveConstellation(nodes);
  logAct('‚ú®', 'system', `Added ${name} to constellation`);
  toast('Node added to constellation');
  closeModal();
  renderActiveTab();
}

// ============================================
// COMMAND CENTER
// ============================================
// ============================================
// COMMAND CENTER - Notion Integration
// ============================================
function renderCommand(el) {
  const data = notionCache?.data || {};
  const lastSync = notionCache?.timestamp;
  
  // Calculate stats for each database
  const stats = {
    jobs: {
      total: data.jobs?.length || 0,
      active: data.jobs?.filter(j => j.status === 'Applied' || j.properties?.Status === 'Applied').length || 0,
      interviewing: data.jobs?.filter(j => j.status === 'Interviewing' || j.properties?.Status === 'Interviewing').length || 0
    },
    immigration: {
      total: data.immigration?.length || 0,
      expiring: data.immigration?.filter(d => d.status === 'Needs Renewal' || d.properties?.Status === 'Needs Renewal').length || 0,
      submitted: data.immigration?.filter(d => d.status === 'Submitted' || d.properties?.Status === 'Submitted').length || 0
    },
    projects: {
      total: data.projects?.length || 0,
      inProgress: data.projects?.filter(p => p.status === 'In Progress' || p.properties?.Status === 'In Progress').length || 0,
      backlog: data.projects?.filter(p => p.status === 'Backlog' || p.properties?.Status === 'Backlog').length || 0
    },
    content: {
      total: data.content?.length || 0,
      drafting: data.content?.filter(c => c.status === 'Drafting' || c.properties?.Status === 'Drafting').length || 0,
      published: data.content?.filter(c => c.status === 'Published' || c.properties?.Status === 'Published').length || 0
    },
    grants: {
      total: data.grants?.length || 0,
      applied: data.grants?.filter(g => g.status === 'Applied' || g.properties?.Status === 'Applied').length || 0,
      awarded: data.grants?.filter(g => g.status === 'Awarded' || g.properties?.Status === 'Awarded').length || 0
    },
    policy: {
      total: data.policy?.length || 0,
      drafting: data.policy?.filter(p => p.status === 'Drafting' || p.properties?.Status === 'Drafting').length || 0
    },
    actions: {
      total: data.actions?.length || 0,
      urgent: data.actions?.filter(a => a.priority === 'Urgent' || a.properties?.Priority === 'Urgent').length || 0,
      today: data.actions?.filter(a => {
        const date = a.due || a.properties?.Due || a.properties?.Date;
        return date && date.startsWith(new Date().toISOString().split('T')[0]);
      }).length || 0
    }
  };

  // Get constellation data for summary
  const constellationNodes = getConstellation();
  const activeNodes = constellationNodes.filter(n => n.status === 'active' && n.type !== 'center').length;
  const staleNodes = constellationNodes.filter(n => n.type !== 'center' && isContactStale(n.lastContact)).length;
  
  el.innerHTML = `
    <div class="welcome-bar">
      <h1 class="welcome-title">üåü Command Center</h1>
      <p class="welcome-subtitle">Notion workspace sync ‚Ä¢ 7 databases connected</p>
    </div>
    
    <!-- Constellation Org Chart -->
    <div class="card" style="margin-bottom:1.5rem">
      <div class="card-header">
        <span class="card-title">‚ú® Constellation Map</span>
        <div style="display:flex;align-items:center;gap:.75rem">
          <span style="font-size:.8rem;color:var(--text-muted)">${activeNodes} active ¬∑ ${staleNodes} stale</span>
          <button class="btn btn-sm btn-primary" onclick="addConstellationNode()">+ Add Node</button>
        </div>
      </div>
      <div style="padding:1rem 0">
        ${renderConstellationDiagram()}
      </div>
      <div style="display:flex;justify-content:center;gap:1.5rem;flex-wrap:wrap;margin-top:.5rem;padding-top:1rem;border-top:1px solid var(--border-subtle)">
        <div style="display:flex;align-items:center;gap:.375rem;font-size:.8rem;color:var(--text-muted)">
          <span style="width:10px;height:10px;border-radius:50%;background:var(--success)"></span> Active
        </div>
        <div style="display:flex;align-items:center;gap:.375rem;font-size:.8rem;color:var(--text-muted)">
          <span style="width:10px;height:10px;border-radius:50%;background:var(--text-muted)"></span> Dormant
        </div>
        <div style="display:flex;align-items:center;gap:.375rem;font-size:.8rem;color:var(--text-muted)">
          <span style="width:10px;height:10px;border-radius:50%;background:var(--danger)"></span> Caution
        </div>
        <div style="display:flex;align-items:center;gap:.375rem;font-size:.8rem;color:var(--text-muted)">
          <span style="width:10px;height:10px;border-radius:50%;border:2px dashed var(--warning)"></span> Stale (>30d)
        </div>
      </div>
    </div>
    
    <div style="margin-bottom:1.5rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap">
      <button class="btn btn-primary ${notionSyncStatus.syncing ? 'disabled' : ''}" onclick="syncNotionData()" id="syncBtn" ${notionSyncStatus.syncing ? 'disabled' : ''}>
        <span id="syncIcon">${notionSyncStatus.syncing ? '‚è≥' : 'üîÑ'}</span>
        ${notionSyncStatus.syncing ? 'Syncing...' : 'Sync with Notion'}
      </button>
      <span id="lastSync" style="color:var(--text-muted);font-size:.85rem">
        ${lastSync ? `Last synced: ${timeAgo(lastSync)}` : 'Not synced yet'}
      </span>
      ${notionSyncStatus.error ? `<span style="color:var(--danger);font-size:.85rem">‚ö†Ô∏è ${esc(notionSyncStatus.error)}</span>` : ''}
    </div>
    
    <div class="command-grid" role="region" aria-label="Notion Databases">
      <!-- Job Applications -->
      <div class="card command-card jobs" role="article" tabindex="0" onclick="showNotionDetails('jobs')">
        <button class="notion-sync-btn" onclick="event.stopPropagation();quickAddNotion('jobs')" title="Quick add job application" aria-label="Quick add job">+</button>
        <div class="command-count">${stats.jobs.total}</div>
        <div class="command-label">üíº Job Applications</div>
        <div class="command-meta">${stats.jobs.active} active ‚Ä¢ ${stats.jobs.interviewing} interviewing</div>
        <div style="margin-top:.75rem">
          ${(data.jobs || []).slice(0, 3).map(j => `
            <div class="notion-item">
              <span class="notion-status ${getStatusClass(j.status || j.properties?.Status)}"></span>
              <span>${esc(j.name || j.properties?.Name || j.properties?.Company || 'Untitled')}</span>
            </div>
          `).join('') || '<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem 0">No jobs synced yet</div>'}
        </div>
      </div>
      
      <!-- Immigration Documents -->
      <div class="card command-card immigration" role="article" tabindex="0" onclick="showNotionDetails('immigration')">
        <button class="notion-sync-btn" onclick="event.stopPropagation();quickAddNotion('immigration')" title="Quick add document" aria-label="Quick add document">+</button>
        <div class="command-count">${stats.immigration.total}</div>
        <div class="command-label">üõÇ Immigration Documents</div>
        <div class="command-meta">${stats.immigration.expiring} expiring ‚Ä¢ ${stats.immigration.submitted} submitted</div>
        <div style="margin-top:.75rem">
          ${(data.immigration || []).slice(0, 3).map(d => `
            <div class="notion-item">
              <span class="notion-status ${getStatusClass(d.status || d.properties?.Status)}"></span>
              <span>${esc(d.name || d.properties?.Name || d.properties?.Document || 'Untitled')}</span>
            </div>
          `).join('') || '<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem 0">No documents synced yet</div>'}
        </div>
      </div>
      
      <!-- Projects & Tasks -->
      <div class="card command-card projects" role="article" tabindex="0" onclick="showNotionDetails('projects')">
        <button class="notion-sync-btn" onclick="event.stopPropagation();quickAddNotion('projects')" title="Quick add project" aria-label="Quick add project">+</button>
        <div class="command-count">${stats.projects.total}</div>
        <div class="command-label">üìÅ Projects & Tasks</div>
        <div class="command-meta">${stats.projects.inProgress} in progress ‚Ä¢ ${stats.projects.backlog} backlog</div>
        <div style="margin-top:.75rem">
          ${(data.projects || []).slice(0, 3).map(p => `
            <div class="notion-item">
              <span class="notion-status ${getStatusClass(p.status || p.properties?.Status)}"></span>
              <span>${esc(p.name || p.properties?.Name || p.properties?.Task || 'Untitled')}</span>
            </div>
          `).join('') || '<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem 0">No projects synced yet</div>'}
        </div>
      </div>
      
      <!-- Content Ideas -->
      <div class="card command-card content" role="article" tabindex="0" onclick="showNotionDetails('content')">
        <button class="notion-sync-btn" onclick="event.stopPropagation();quickAddNotion('content')" title="Quick add content idea" aria-label="Quick add content">+</button>
        <div class="command-count">${stats.content.total}</div>
        <div class="command-label">‚úçÔ∏è Content Ideas</div>
        <div class="command-meta">${stats.content.drafting} drafting ‚Ä¢ ${stats.content.published} published</div>
        <div style="margin-top:.75rem">
          ${(data.content || []).slice(0, 3).map(c => `
            <div class="notion-item">
              <span class="notion-status ${getStatusClass(c.status || c.properties?.Status)}"></span>
              <span>${esc(c.name || c.properties?.Name || c.properties?.Title || 'Untitled')}</span>
            </div>
          `).join('') || '<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem 0">No content synced yet</div>'}
        </div>
      </div>
      
      <!-- Grant Pipeline -->
      <div class="card command-card grants" role="article" tabindex="0" onclick="showNotionDetails('grants')">
        <button class="notion-sync-btn" onclick="event.stopPropagation();quickAddNotion('grants')" title="Quick add grant" aria-label="Quick add grant">+</button>
        <div class="command-count">${stats.grants.total}</div>
        <div class="command-label">üí∞ Grant Pipeline</div>
        <div class="command-meta">${stats.grants.applied} pending ‚Ä¢ ${stats.grants.awarded} awarded</div>
        <div style="margin-top:.75rem">
          ${(data.grants || []).slice(0, 3).map(g => `
            <div class="notion-item">
              <span class="notion-status ${getStatusClass(g.status || g.properties?.Status)}"></span>
              <span>${esc(g.name || g.properties?.Name || g.properties?.Funder || 'Untitled')}</span>
            </div>
          `).join('') || '<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem 0">No grants synced yet</div>'}
        </div>
      </div>
      
      <!-- Policy Development -->
      <div class="card command-card policy" role="article" tabindex="0" onclick="showNotionDetails('policy')">
        <button class="notion-sync-btn" onclick="event.stopPropagation();quickAddNotion('policy')" title="Quick add policy" aria-label="Quick add policy">+</button>
        <div class="command-count">${stats.policy.total}</div>
        <div class="command-label">üìú Policy Development</div>
        <div class="command-meta">${stats.policy.drafting} in drafting</div>
        <div style="margin-top:.75rem">
          ${(data.policy || []).slice(0, 3).map(p => `
            <div class="notion-item">
              <span class="notion-status ${getStatusClass(p.status || p.properties?.Status)}"></span>
              <span>${esc(p.name || p.properties?.Name || p.properties?.Policy || 'Untitled')}</span>
            </div>
          `).join('') || '<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem 0">No policies synced yet</div>'}
        </div>
      </div>
      
      <!-- Action Items -->
      <div class="card command-card actions" role="article" tabindex="0" onclick="showNotionDetails('actions')">
        <button class="notion-sync-btn" onclick="event.stopPropagation();quickAddNotion('actions')" title="Quick add action" aria-label="Quick add action">+</button>
        <div class="command-count">${stats.actions.total}</div>
        <div class="command-label">‚ö° Action Items</div>
        <div class="command-meta">${stats.actions.urgent} urgent ‚Ä¢ ${stats.actions.today} due today</div>
        <div style="margin-top:.75rem">
          ${(data.actions || []).slice(0, 3).map(a => `
            <div class="notion-item">
              <span class="notion-status ${getPriorityClass(a.priority || a.properties?.Priority)}"></span>
              <span>${esc(a.name || a.properties?.Name || a.properties?.Action || 'Untitled')}</span>
            </div>
          `).join('') || '<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem 0">No actions synced yet</div>'}
        </div>
      </div>
      
      <!-- Firebird Summary -->
      <div class="card command-card firebird" role="article" tabindex="0">
        <div style="font-size:2.5rem;margin-bottom:.25rem">üî•</div>
        <div class="command-label">Firebird Summary</div>
        <div class="command-meta">
          ${data.grants?.filter(g => (g.properties?.Project || g.project) === 'Firebird').length || 0} grants ‚Ä¢ 
          ${data.projects?.filter(p => (p.properties?.Project || p.project) === 'Firebird').length || 0} tasks
        </div>
        <div style="margin-top:.75rem;font-size:.8rem;color:var(--text-secondary)">
          ${data.actions?.filter(a => (a.properties?.Project || a.project) === 'Firebird').length || 0} pending actions
        </div>
      </div>
    </div>
    
    <!-- Quick Add Section -->
    <div class="card" style="margin-top:1.5rem">
      <div class="card-header">
        <span class="card-title">‚ö° Quick Add</span>
      </div>
      <div class="quick-add-grid">
        <button class="btn btn-ghost" onclick="quickAddNotion('jobs')">üíº Add Job Application</button>
        <button class="btn btn-ghost" onclick="quickAddNotion('actions')">‚ö° Add Action Item</button>
        <button class="btn btn-ghost" onclick="quickAddNotion('content')">‚úçÔ∏è Add Content Idea</button>
        <button class="btn btn-ghost" onclick="quickAddNotion('projects')">üìÅ Add Project Task</button>
      </div>
    </div>
  `;
}

function openAgentPanel(id) {
  const a = getAgents().find(x=>x.id===id);
  if(!a) return;
  document.getElementById('slidePanelTitle').textContent = '‚ú¶ '+a.name;
  document.getElementById('slidePanelContent').innerHTML = `
    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem">
      <div class="agent-avatar" style="width:56px;height:56px;font-size:1.75rem">${a.avatar}</div>
      <div><h2 style="margin:0;font-size:1.25rem">${esc(a.name)}</h2><p style="color:var(--text-muted);margin:0">${esc(a.role)}</p></div>
    </div>
    <div style="margin-bottom:1.5rem"><h3 class="card-title" style="margin-bottom:.5rem">About</h3><p style="color:var(--text-secondary);font-size:.9rem">${esc(a.description)}</p></div>
    <div style="margin-bottom:1.5rem"><h3 class="card-title" style="margin-bottom:.5rem">Capabilities</h3><ul style="list-style:none">${a.capabilities.map(c=>`<li style="padding:.25rem 0;padding-left:1rem;position:relative;color:var(--text-secondary)"><span style="position:absolute;left:0;color:var(--accent)">‚Üí</span>${esc(c)}</li>`).join('')}</ul></div>
    <div style="margin-bottom:1.5rem"><h3 class="card-title" style="margin-bottom:.5rem">Recent Activity</h3>
      ${a.activityLog.length>0 ? a.activityLog.slice(-5).reverse().map(l=>`<div style="padding:.375rem 0;border-bottom:1px solid var(--border-subtle);font-size:.85rem"><div style="color:var(--text-secondary)">${esc(l.msg)}</div><div style="font-size:.75rem;color:var(--text-muted)">${new Date(l.time).toLocaleString()}</div></div>`).join('') : '<div style="color:var(--text-muted)">No recent activity</div>'}
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="sendAgentTask('${a.id}')">üìã Send Task</button>
  `;
  document.getElementById('slidePanel').classList.add('open');
  document.getElementById('slideOverlay').classList.add('open');
}

function sendAgentTask(id) {
  closeSlidePanel();
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">Send Task</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <textarea class="modal-input textarea" id="agentTaskMsg" placeholder="Describe what you need..." autofocus></textarea>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="submitAgentTask('${id}')">Send</button>
    </div>
  `);
}
function submitAgentTask(id) {
  const msg = document.getElementById('agentTaskMsg').value.trim();
  if(!msg) return;
  const agents = getAgents(); const a = agents.find(x=>x.id===id);
  if(a) {
    a.activityLog.push({msg:'Task: '+msg.slice(0,60), time:new Date().toISOString()});
    a.status='busy'; a.lastActive=new Date().toISOString();
    saveAgents(agents);
  }
  closeModal(); toast('Task sent to '+a.name); logAct('üì®','system','Sent task to '+a.name); renderActiveTab();
}
function addDecision() {
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">Log Decision</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <input class="modal-input" id="decQ" placeholder="Decision question" autofocus>
    <textarea class="modal-input textarea" id="decS" placeholder="Decision summary"></textarea>
    <input class="modal-input" id="decA" placeholder="Agents consulted (comma-separated)">
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="saveDecision()">Save</button>
    </div>
  `);
}
function saveDecision() {
  const q=document.getElementById('decQ').value.trim(), s=document.getElementById('decS').value.trim();
  if(!q||!s) return toast('Fill in all fields','error');
  const agents=document.getElementById('decA').value.split(',').map(a=>a.trim()).filter(Boolean);
  const d=getDecisions(); d.unshift({id:Date.now(),date:new Date().toISOString(),question:q,summary:s,agents});
  saveDecisions(d); closeModal(); toast('Decision logged'); logAct('üìã','system','Logged decision: '+q); renderActiveTab();
}

// ============================================
// MEETINGS
// ============================================
function renderMeetingsTab(el) {
  let meetings = getMeetings();
  const now = new Date();
  const today = [], upcoming = [], past = [];
  const syncState = GCal.getSyncState();

  // Calculate urgency scores for all meetings
  meetings = meetings.map(m => {
    const score = getUrgencyScore({...m, priority: 'high'});
    return {...m, _urgencyScore: score, _daysUntil: m._daysUntil};
  });

  meetings.forEach(m => {
    const dt = new Date(m.date+'T'+m.time);
    if(m.date===todayStr()) today.push(m);
    else if(dt < now) past.push(m);
    else upcoming.push(m);
  });

  // Sort by urgency within time groups
  today.sort((a,b) => a.time.localeCompare(b.time));
  upcoming.sort((a,b) => {
    // Sort by urgency score first, then by date/time
    if (b._urgencyScore !== a._urgencyScore) return b._urgencyScore - a._urgencyScore;
    return (a.date+a.time).localeCompare(b.date+b.time);
  });
  past.sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time));

  const renderCard = (m, isToday=false) => {
    const dt = new Date(m.date+'T'+m.time);
    const dateDisplay = isToday ? 'Today' : dt.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    const timeDisplay = dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    const diff = dt - now;
    const countdown = diff<0?'Started':diff<3600000?Math.ceil(diff/60000)+'m':Math.floor(diff/3600000)+'h '+Math.ceil((diff%3600000)/60000)+'m';
    const urgent = diff>0 && diff<3600000;
    const icons = {call:'üìû',zoom:'üíª','in-person':'ü§ù'};
    const isSynced = !!m.gcalId;

    return `<div class="card meeting-card ${isToday?'today':''}" data-meeting-id="${m.id}">
      <div class="meeting-card-header" onclick="toggleMtgExpand('${m.id}')">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem">
          <div style="flex:1"><div class="meeting-title">${esc(m.title)} ${isSynced ? '<span style="color:var(--success);font-size:.75rem" title="Synced with Google Calendar">‚úì</span>' : ''}</div>
          <div class="meeting-datetime"><span>${dateDisplay} at ${timeDisplay}</span><span class="meeting-countdown ${urgent?'urgent':''}">${countdown}</span></div></div>
          <div style="display:flex;gap:.25rem" onclick="event.stopPropagation()">
            <button class="btn-icon" onclick="syncMeetingToCalendar('${m.id}')" title="Add to Google Calendar">üìÖ</button>
            <button class="btn-icon" onclick="editMeeting('${m.id}')">‚úèÔ∏è</button>
            <button class="btn-icon" onclick="deleteMeeting('${m.id}')" style="color:var(--danger)">‚úï</button>
          </div>
        </div>
        <div class="meeting-meta"><span>${icons[m.type]||'üìÖ'} ${m.type}</span><span>üë• ${esc(m.attendees)}</span></div>
      </div>
      <div class="meeting-expanded" id="mtg-exp-${m.id}">
        ${m.gcalId ? `<div style="margin-bottom:1rem;padding:.5rem;background:rgba(107,144,128,.08);border:1px solid rgba(107,144,128,.2);border-radius:6px;display:flex;align-items:center;justify-content:space-between;"><span style="font-size:.8rem;color:var(--success)">‚úì Synced with Google Calendar</span><a href="https://calendar.google.com/calendar/event?eid=${btoa(m.gcalId).replace(/=/g, '')}" target="_blank" style="font-size:.75rem;color:var(--accent);text-decoration:none;">Open in GCal ‚Üí</a></div>` : ''}
        ${m.prepNotes?`<div class="meeting-section"><div class="meeting-section-title">üìù Prep</div><p style="color:var(--text-secondary);font-size:.9rem">${esc(m.prepNotes)}</p></div>`:''}
        <div class="meeting-section"><div class="meeting-section-title">üìã Agenda</div>
          ${m.agenda.map(a=>`<div class="agenda-item"><div class="priority-check ${a.done?'done':''}" onclick="toggleMtgAgenda('${m.id}',${a.id})"></div><span class="priority-text ${a.done?'done':''}">${esc(a.text)}</span></div>`).join('')}
          <button class="btn btn-ghost btn-sm" style="margin-top:.5rem" onclick="addMtgAgenda('${m.id}')">+ Agenda item</button>
        </div>
        <div class="meeting-section"><div class="meeting-section-title">üìù Notes</div>
          <textarea class="meeting-notes-area" placeholder="Meeting notes..." onblur="saveMtgNotes('${m.id}',this.value)">${esc(m.notes||'')}</textarea>
        </div>
        <div class="meeting-section"><div class="meeting-section-title">‚úÖ Action Items</div>
          ${(m.actionItems||[]).map((a,i)=>`<div style="display:flex;align-items:center;gap:.5rem;padding:.375rem .5rem;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:6px;margin-bottom:.375rem;font-size:.85rem"><span style="flex:1">${esc(a)}</span><button class="btn-icon" onclick="removeMtgAction('${m.id}',${i})" style="color:var(--danger);font-size:.75rem">‚úï</button></div>`).join('')}
          <div style="display:flex;gap:.5rem;margin-top:.5rem"><input class="modal-input" id="action-${m.id}" placeholder="Add action item..." style="margin:0;flex:1" onkeypress="if(event.key==='Enter')addMtgAction('${m.id}')"><button class="btn btn-sm btn-primary" onclick="addMtgAction('${m.id}')">Add</button></div>
        </div>
      </div>
    </div>`;
  };

  el.innerHTML = `
    <div class="welcome-bar">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem">
        <div>
          <h1 class="welcome-title">üìû Rituals</h1>
          <p class="welcome-subtitle">Sacred gatherings</p>
        </div>
        <div style="display:flex;gap:.5rem;">
          ${GCal.useMockData ? `
            <button class="btn btn-sm" style="background:rgba(90,163,200,.1);border:1px solid rgba(90,163,200,.3);color:var(--info)" onclick="configureGoogleCalendar()" title="Configure Google Calendar integration">
              ‚öôÔ∏è Configure GCal
            </button>
          ` : `
            <button class="btn btn-sm" style="background:rgba(255,255,255,.05);border:1px solid var(--border-subtle);color:var(--text-secondary)" onclick="toggleCalendarSync()" title="${syncState.syncEnabled ? 'Disable' : 'Enable'} Google Calendar sync">
              ${syncState.syncEnabled ? 'üîÑ Sync On' : '‚è∏Ô∏è Sync Off'}
            </button>
            <button class="btn btn-sm btn-primary" onclick="syncNow()" ${!syncState.syncEnabled ? 'disabled' : ''} title="Sync now with Google Calendar">
              ‚Üª Sync Now
            </button>
          `}
          <button class="btn btn-sm btn-primary" onclick="addMeeting()" aria-label="Add meeting">+ Add Meeting</button>
        </div>
      </div>
      ${syncState.lastSync ? `<p style="color:var(--text-muted);font-size:.75rem;margin-top:.25rem;">Last synced: ${timeAgo(syncState.lastSync)}</p>` : (GCal.useMockData ? '<p style="color:var(--text-muted);font-size:.75rem;margin-top:.25rem;">Using mock data - configure to enable real sync</p>' : '')}
    </div>
    ${today.length?`<div style="margin-bottom:2rem"><div class="card-header"><span class="card-title">üî• Today (${today.length})</span></div><div class="meetings-grid">${today.map(m=>renderCard(m,true)).join('')}</div></div>`:''}
    <div style="margin-bottom:1.5rem"><div class="card-header"><span class="card-title">üåô Upcoming (${upcoming.length})</span></div>
      ${upcoming.length?`<div class="meetings-grid">${upcoming.map(m=>renderCard(m)).join('')}</div>`:`<div class="card" style="text-align:center;padding:2rem;color:var(--text-muted)">No upcoming meetings</div>`}
    </div>
    ${past.length?`<div class="archive-toggle" onclick="document.getElementById('mtg-archive').classList.toggle('open');this.querySelector('span:first-child').textContent=document.getElementById('mtg-archive').classList.contains('open')?'‚ñº':'‚ñ∂'"><span>‚ñ∂</span><span>Archive (${past.length})</span></div><div class="archive-section" id="mtg-archive"><div class="meetings-grid">${past.map(m=>renderCard(m)).join('')}</div></div>`:''}
  `;
}

function toggleMtgExpand(id) { document.getElementById('mtg-exp-'+id)?.classList.toggle('open') }

function toggleCalendarSync() {
  const syncState = GCal.getSyncState();
  syncState.syncEnabled = !syncState.syncEnabled;
  GCal.saveSyncState(syncState);
  toast(syncState.syncEnabled ? 'Calendar sync enabled' : 'Calendar sync disabled');
  renderActiveTab();
}

function configureGoogleCalendar() {
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">Configure Google Calendar</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <p style="color:var(--text-muted);font-size:.85rem;margin-bottom:1rem;">Enter your Google API credentials to enable calendar sync. You can get these from the <a href="https://console.cloud.google.com/" target="_blank" style="color:var(--accent)">Google Cloud Console</a>.</p>
    <label class="modal-label">OAuth 2.0 Client ID</label>
    <input class="modal-input" id="gcalClientId" placeholder="your-client-id.apps.googleusercontent.com">
    <label class="modal-label">API Key (optional)</label>
    <input class="modal-input" id="gcalApiKey" placeholder="AIza...">
    <div style="background:rgba(107,144,128,.1);border:1px solid rgba(107,144,128,.2);border-radius:8px;padding:.75rem;margin-top:.75rem;">
      <p style="font-size:.8rem;color:var(--success);margin:0;">‚úì Secure storage: Tokens are encrypted with a device-specific key</p>
    </div>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="saveGCalConfig()">Save & Connect</button>
    </div>
  `);
}

async function saveGCalConfig() {
  const clientId = document.getElementById('gcalClientId').value.trim();
  const apiKey = document.getElementById('gcalApiKey').value.trim();
  
  if (!clientId) {
    toast('Client ID is required', 'error');
    return;
  }
  
  GCal.configure(clientId, apiKey);
  closeModal();
  toast('Configuration saved. Authenticating...');
  
  try {
    await GCal.authenticate();
    toast('Successfully connected to Google Calendar!');
    
    // Enable sync
    const syncState = GCal.getSyncState();
    syncState.syncEnabled = true;
    GCal.saveSyncState(syncState);
    
    // Initial sync
    await syncMeetingsWithCalendar();
    renderActiveTab();
  } catch (error) {
    toast('Authentication failed: ' + error.message, 'error');
  }
}

async function syncNow() {
  toast('Syncing with Google Calendar...');
  try {
    await syncMeetingsWithCalendar();
    toast('Sync complete!');
    renderActiveTab();
  } catch (error) {
    toast('Sync failed: ' + error.message, 'error');
  }
}

async function syncMeetingToCalendar(meetingId) {
  const meeting = getMeetings().find(m => m.id === meetingId);
  if (!meeting) return;

  if (meeting.gcalId) {
    // Already synced - offer to update
    const shouldUpdate = confirm('This meeting is already in Google Calendar. Update it?');
    if (!shouldUpdate) return;
  }

  try {
    const startTime = `${meeting.date}T${meeting.time}:00`;
    const endTimeObj = new Date(new Date(startTime).getTime() + 60 * 60000);

    const event = await addToCalendar({
      title: meeting.title,
      description: meeting.prepNotes,
      startTime: startTime,
      endTime: endTimeObj.toISOString(),
      location: meeting.type === 'zoom' ? 'Zoom' : meeting.type === 'call' ? 'Phone' : 'In-person',
      attendees: meeting.attendees?.split(',').map(e => e.trim()).filter(Boolean) || []
    });

    if (event) {
      // Save the Google Calendar ID to the meeting
      const meetings = getMeetings();
      const m = meetings.find(x => x.id === meetingId);
      if (m) {
        m.gcalId = event.id;
        saveMeetingsData(meetings);
      }
      renderActiveTab();
    }
  } catch (error) {
    console.error('[Meeting] Sync error:', error);
    toast('Failed to sync meeting', 'error');
  }
}
function toggleMtgAgenda(mid, aid) {
  const m = getMeetings(); const mt = m.find(x=>x.id===mid); const a = mt?.agenda.find(x=>x.id===aid);
  if(a) { a.done=!a.done; saveMeetingsData(m); renderActiveTab(); }
}
function addMtgAgenda(mid) {
  const text = prompt('Agenda item:'); if(!text) return;
  const m = getMeetings(); const mt = m.find(x=>x.id===mid);
  mt.agenda.push({id:Date.now(),text,done:false}); saveMeetingsData(m); renderActiveTab();
  setTimeout(()=>document.getElementById('mtg-exp-'+mid)?.classList.add('open'),50);
}
function saveMtgNotes(mid,val) { const m=getMeetings(); const mt=m.find(x=>x.id===mid); mt.notes=val; saveMeetingsData(m) }
function addMtgAction(mid) {
  const inp=document.getElementById('action-'+mid); const text=inp?.value.trim(); if(!text) return;
  const m=getMeetings(); const mt=m.find(x=>x.id===mid); mt.actionItems=mt.actionItems||[]; mt.actionItems.push(text); saveMeetingsData(m);
  renderActiveTab(); setTimeout(()=>document.getElementById('mtg-exp-'+mid)?.classList.add('open'),50);
}
function removeMtgAction(mid,idx) {
  const m=getMeetings(); const mt=m.find(x=>x.id===mid); mt.actionItems.splice(idx,1); saveMeetingsData(m);
  renderActiveTab(); setTimeout(()=>document.getElementById('mtg-exp-'+mid)?.classList.add('open'),50);
}
function deleteMeeting(id) { if(!confirm('Delete?')) return; saveMeetingsData(getMeetings().filter(x=>x.id!==id)); renderActiveTab(); toast('Meeting deleted'); logAct('üóëÔ∏è','meeting','Deleted meeting') }
function addMeeting(editId=null) {
  const m = editId ? getMeetings().find(x=>x.id===editId) : null;
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">${m?'Edit':'Add'} Meeting</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <input type="hidden" id="mtgEditId" value="${editId||''}">
    <input class="modal-input" id="mtgTitle" placeholder="Meeting title" value="${m?esc(m.title):''}">
    <div class="modal-row">
      <div><label class="modal-label">Date</label><input type="date" class="modal-input" id="mtgDate" value="${m?m.date:''}"></div>
      <div><label class="modal-label">Time</label><input type="time" class="modal-input" id="mtgTime" value="${m?m.time:''}"></div>
    </div>
    <label class="modal-label">Type</label>
    <select class="modal-input modal-select" id="mtgType"><option value="call" ${m?.type==='call'?'selected':''}>üìû Call</option><option value="zoom" ${m?.type==='zoom'?'selected':''}>üíª Zoom</option><option value="in-person" ${m?.type==='in-person'?'selected':''}>ü§ù In-Person</option></select>
    <input class="modal-input" id="mtgAttendees" placeholder="Attendees" value="${m?esc(m.attendees):''}">
    <textarea class="modal-input textarea" id="mtgPrep" placeholder="Prep notes">${m?esc(m.prepNotes||''):''}</textarea>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="saveMeeting()">Save</button>
    </div>
  `);
}
function editMeeting(id) { addMeeting(id) }
function saveMeeting() {
  const title=document.getElementById('mtgTitle').value.trim();
  const date=document.getElementById('mtgDate').value, time=document.getElementById('mtgTime').value;
  if(!title||!date||!time) return toast('Fill required fields','error');
  const type=document.getElementById('mtgType').value, attendees=document.getElementById('mtgAttendees').value.trim(), prep=document.getElementById('mtgPrep').value.trim();
  const editId=document.getElementById('mtgEditId').value;
  const meetings=getMeetings();
  if(editId) { const m=meetings.find(x=>x.id===editId); Object.assign(m,{title,date,time,type,attendees,prepNotes:prep}); }
  else { meetings.push({id:'m'+Date.now(),title,date,time,type,attendees,prepNotes:prep,agenda:[],notes:'',actionItems:[]}); logAct('üìû','meeting','Added meeting: '+title); }
  saveMeetingsData(meetings); closeModal(); renderActiveTab(); toast(editId?'Meeting updated':'Meeting added');
}

// ============================================
// INTEL
// ============================================
let intelFilters = { category:'all', importance:'all' };
const catLabels = {'ai-news':'ü§ñ AI News','industry':'üìà Industry','competitor':'üëÅ Competitor','opportunities':'üí° Opportunities'};
const impConfig = {hot:{icon:'üî•',label:'Hot'},notable:{icon:'‚ö°',label:'Notable'},reference:{icon:'üìå',label:'Reference'}};

function renderIntelTab(el) {
  const all = getIntel();
  let filtered = all;
  if(intelFilters.category!=='all') filtered=filtered.filter(i=>i.category===intelFilters.category);
  if(intelFilters.importance!=='all') filtered=filtered.filter(i=>i.importance===intelFilters.importance);
  filtered.sort((a,b)=>new Date(b.dateAdded)-new Date(a.dateAdded));

  const brief = [...all].sort((a,b)=>{const p={hot:3,notable:2,reference:1};return(p[b.importance]-p[a.importance])||(new Date(b.dateAdded)-new Date(a.dateAdded))}).slice(0,5);
  const catCount = c => c==='all'?all.length:all.filter(i=>i.category===c).length;

  el.innerHTML = `
    <div class="welcome-bar"><h1 class="welcome-title">üì° Signals</h1><p class="welcome-subtitle">What the universe is whispering</p></div>
    <div class="intel-container">
      <aside class="card intel-sidebar">
        <div class="card-title" style="margin-bottom:.75rem">üéØ Filters</div>
        ${['all','ai-news','industry','competitor','opportunities'].map(c=>`<button class="intel-filter-btn ${intelFilters.category===c?'active':''}" onclick="intelFilters.category='${c}';renderActiveTab()">${c==='all'?'üìÅ All':catLabels[c]}<span class="intel-filter-count">${catCount(c)}</span></button>`).join('')}
        <div style="margin:1rem 0 .5rem;border-top:1px solid var(--border-subtle);padding-top:.75rem"><span class="card-title">Importance</span></div>
        ${['all','hot','notable','reference'].map(i=>`<button class="intel-filter-btn ${intelFilters.importance===i?'active':''}" onclick="intelFilters.importance='${i}';renderActiveTab()">${i==='all'?'üéØ All':(impConfig[i].icon+' '+impConfig[i].label)}</button>`).join('')}
        <button class="btn btn-primary" style="width:100%;margin-top:1rem" onclick="addIntel()">+ Add Intel</button>
      </aside>
      <main style="min-width:0">
        <div style="margin-bottom:2rem"><div class="card-header"><span class="card-title">üì∞ Daily Brief</span></div>
          <div class="intel-grid">${brief.map(i=>renderIntelCard(i)).join('')}</div>
        </div>
        <div><div class="card-header"><span class="card-title">${filtered.length} items</span></div>
          ${filtered.length?`<div class="intel-grid">${filtered.map(i=>renderIntelCard(i)).join('')}</div>`:`<div class="card" style="text-align:center;padding:2rem;color:var(--text-muted)">No intel matches your filters</div>`}
        </div>
      </main>
    </div>
  `;
}

function renderIntelCard(i) {
  const imp=impConfig[i.importance];
  return `<div class="card intel-card ${i.importance}">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem">
      <span style="font-size:.7rem;text-transform:uppercase;letter-spacing:.04em;color:var(--text-muted);background:rgba(255,255,255,.05);padding:.15rem .4rem;border-radius:4px">${catLabels[i.category]||i.category}</span>
      <span class="intel-importance ${i.importance}">${imp.icon} ${imp.label}</span>
    </div>
    <h3 style="font-size:1rem;font-weight:600;margin-bottom:.375rem;line-height:1.4"><a href="${esc(i.source)}" target="_blank" style="color:var(--text-primary);text-decoration:none">${esc(i.title)}</a></h3>
    <p style="color:var(--text-secondary);font-size:.85rem;line-height:1.5;margin-bottom:.75rem">${esc(i.summary)}</p>
    <div style="display:flex;justify-content:space-between;align-items:center;font-size:.75rem;color:var(--text-muted)">
      <span>üìÖ ${timeAgo(i.dateAdded)}</span>
      <div style="display:flex;gap:.375rem"><button class="btn-icon" onclick="editIntel('${i.id}')" style="font-size:.75rem">‚úèÔ∏è</button><button class="btn-icon" onclick="deleteIntel('${i.id}')" style="font-size:.75rem;color:var(--danger)">‚úï</button></div>
    </div>
  </div>`;
}

function addIntel(editId=null) {
  const i = editId ? getIntel().find(x=>x.id===editId) : null;
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">${i?'Edit':'Add'} Intel</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <input type="hidden" id="intelEditId" value="${editId||''}">
    <input class="modal-input" id="intelTitle" placeholder="Title" value="${i?esc(i.title):''}">
    <div class="modal-row">
      <div><label class="modal-label">Category</label><select class="modal-input modal-select" id="intelCat">${Object.entries(catLabels).map(([k,v])=>`<option value="${k}" ${i?.category===k?'selected':''}>${v}</option>`).join('')}</select></div>
      <div><label class="modal-label">Importance</label><select class="modal-input modal-select" id="intelImp">${Object.entries(impConfig).map(([k,v])=>`<option value="${k}" ${i?.importance===k?'selected':''}>${v.icon} ${v.label}</option>`).join('')}</select></div>
    </div>
    <input class="modal-input" id="intelSrc" placeholder="Source URL" value="${i?esc(i.source):''}">
    <textarea class="modal-input textarea" id="intelSum" placeholder="Summary">${i?esc(i.summary):''}</textarea>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="saveIntelItem()">Save</button>
    </div>
  `);
}
function editIntel(id) { addIntel(id) }
function deleteIntel(id) { if(!confirm('Delete?')) return; saveIntelData(getIntel().filter(x=>x.id!==id)); renderActiveTab(); toast('Deleted'); logAct('üóëÔ∏è','intel','Deleted intel') }
function saveIntelItem() {
  const title=document.getElementById('intelTitle').value.trim(), src=document.getElementById('intelSrc').value.trim(), sum=document.getElementById('intelSum').value.trim();
  if(!title||!sum) return toast('Fill required fields','error');
  const cat=document.getElementById('intelCat').value, imp=document.getElementById('intelImp').value, editId=document.getElementById('intelEditId').value;
  const intel=getIntel();
  if(editId) { const i=intel.find(x=>x.id===editId); Object.assign(i,{title,category:cat,importance:imp,source:src,summary:sum}) }
  else { intel.push({id:'i'+Date.now(),title,category:cat,importance:imp,source:src,summary:sum,dateAdded:new Date().toISOString()}); logAct('üì°','intel','Added intel: '+title) }
  saveIntelData(intel); closeModal(); renderActiveTab(); toast(editId?'Updated':'Intel added');
}

// ============================================
// LLM TRACKER
// ============================================
const LLM_MODELS = [
  {id:'kimi-k2.5',name:'Kimi K2.5',provider:'Moonshot',ctx:256000,inCost:0.5,outCost:2,status:'online'},
  {id:'gemini-2.5-flash',name:'Gemini 2.5 Flash',provider:'Google',ctx:1000000,inCost:0.15,outCost:0.6,status:'online'},
  {id:'gemini-3-flash',name:'Gemini 3 Flash',provider:'Google',ctx:128000,inCost:0.075,outCost:0.3,status:'online',cap:10},
  {id:'trinity-large',name:'Trinity Large',provider:'OpenRouter',ctx:128000,inCost:1.5,outCost:3,status:'online'},
  {id:'claude-sonnet-4.6',name:'Claude Sonnet 4.6',provider:'Anthropic',ctx:200000,inCost:3,outCost:15,status:'online',cap:20},
  {id:'step-3.5-flash',name:'Step 3.5 Flash',provider:'Step',ctx:32000,inCost:0.5,outCost:2,status:'online'},
  {id:'minimax-m2.5',name:'MiniMax M2.5',provider:'MiniMax',ctx:8000,inCost:0.3,outCost:1.2,status:'online'}
];
const LLM_BUDGET = 60;

function getLLMData() {
  let d = S.get('llm_data',null);
  if(!d) {
    d = { spend:2.35, logs:[], daily:{}, model:{} };
    // Sample data
    for(let i=0;i<5;i++){
      const m=LLM_MODELS[i%LLM_MODELS.length];
      const ti=500+Math.floor(Math.random()*1000), to=200+Math.floor(Math.random()*500);
      const cost=(ti*m.inCost+to*m.outCost)/1000000;
      const dt=new Date(Date.now()-i*7200000);
      d.logs.push({ts:dt.toISOString(),model:m.name,ti,to,cost});
      const day=dt.toISOString().split('T')[0];
      d.daily[day]=(d.daily[day]||0)+ti+to;
      if(!d.model[m.id])d.model[m.id]={tokens:0,cost:0};
      d.model[m.id].tokens+=ti+to; d.model[m.id].cost+=cost;
    }
    S.set('llm_data',d);
  }
  return d;
}
function saveLLMData(d){S.set('llm_data',d)}

function renderLLMTab(el) {
  const d = getLLMData();
  const remaining = Math.max(0,LLM_BUDGET-d.spend);
  const pctLeft = (remaining/LLM_BUDGET*100);
  const pctSpent = (d.spend/LLM_BUDGET*100);
  const dayNum = new Date().getDate();
  const avgDaily = dayNum>1 ? d.spend/(dayNum-1) : d.spend;
  const estDays = avgDaily>0 ? Math.floor(remaining/avgDaily) : 30;

  // Chart data
  const days = [];
  for(let i=6;i>=0;i--){const dt=new Date();dt.setDate(dt.getDate()-i);const ds=dt.toISOString().split('T')[0];days.push({day:dt.toLocaleDateString('en-US',{weekday:'short'}),tokens:d.daily[ds]||0})}
  const maxT=Math.max(...days.map(x=>x.tokens),500);
  const weekTotal = days.reduce((s,x)=>s+x.tokens,0);

  el.innerHTML = `
    <div class="welcome-bar"><h1 class="welcome-title">ü§ñ LLM Tracker</h1><p class="welcome-subtitle">Monitor your AI constellation</p></div>
    <div style="background:rgba(139,92,246,.1);border:1px solid var(--accent);border-radius:12px;padding:.875rem 1.25rem;margin-bottom:1.5rem;display:flex;align-items:center;justify-content:space-between">
      <span style="font-size:.9rem">üí∞ Monthly Budget</span><span style="font-weight:600;color:var(--accent)">$${d.spend.toFixed(2)} / $${LLM_BUDGET}</span>
    </div>
    <div class="llm-wallet-grid">
      <div class="card" style="position:relative;overflow:hidden"><div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),#ec4899)"></div>
        <div class="metric-label">Credits Left</div><div class="metric-value">$${remaining.toFixed(2)}</div>
        <div class="llm-progress-bg"><div class="llm-progress-fill ${pctLeft<20?'danger':pctLeft<40?'warning':'normal'}" style="width:${pctLeft}%"></div></div>
        <div style="font-size:.8rem;color:var(--text-muted);margin-top:.375rem">${pctLeft.toFixed(0)}% remaining</div>
      </div>
      <div class="card" style="position:relative;overflow:hidden"><div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--warning),#fbbf24)"></div>
        <div class="metric-label">Spent This Month</div><div class="metric-value">$${d.spend.toFixed(2)}</div>
        <div class="llm-progress-bg"><div class="llm-progress-fill ${pctSpent>80?'danger':pctSpent>60?'warning':'normal'}" style="width:${pctSpent}%"></div></div>
        <div style="font-size:.8rem;color:var(--text-muted);margin-top:.375rem">${pctSpent.toFixed(0)}% of budget</div>
      </div>
      <div class="card" style="position:relative;overflow:hidden"><div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--success),#34d399)"></div>
        <div class="metric-label">Est. Days Left</div><div class="metric-value">${estDays}</div>
        <div style="font-size:.85rem;color:var(--text-secondary);margin-top:.5rem">$${avgDaily.toFixed(2)}/day avg</div>
      </div>
    </div>
    <div class="card-header"><span class="card-title">üåê Connected Models</span></div>
    <div class="llm-models-grid">${LLM_MODELS.map(m=>{
      const u=d.model[m.id]||{tokens:0,cost:0};
      return`<div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem">
          <span style="font-weight:600">${m.name}</span>
          <span style="width:8px;height:8px;border-radius:50%;background:var(--success);box-shadow:0 0 8px var(--success)"></span>
        </div>
        <div style="font-size:.8rem;color:var(--text-muted);margin-bottom:.5rem">${m.provider} ¬∑ ${(m.ctx/1000)}k ctx${m.cap?' ¬∑ $'+m.cap+'/mo cap':''}</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;font-size:.8rem">
          <div style="background:rgba(255,255,255,.03);padding:.5rem;border-radius:6px"><div style="color:var(--text-muted);font-size:.7rem">In / 1M</div><div style="font-weight:600;color:var(--text-secondary)">$${m.inCost.toFixed(2)}</div></div>
          <div style="background:rgba(255,255,255,.03);padding:.5rem;border-radius:6px"><div style="color:var(--text-muted);font-size:.7rem">Out / 1M</div><div style="font-weight:600;color:var(--text-secondary)">$${m.outCost.toFixed(2)}</div></div>
        </div>
        <div style="margin-top:.75rem;padding-top:.5rem;border-top:1px solid var(--border-subtle);font-size:.8rem;color:var(--text-secondary)">üíµ $${u.cost.toFixed(4)} ¬∑ ${(u.tokens/1000).toFixed(1)}k tokens</div>
      </div>`;
    }).join('')}</div>
    <div class="card" style="margin-bottom:1.5rem">
      <div class="card-header"><span class="card-title">üìä Token Usage (7 Days)</span><span style="font-size:.8rem;color:var(--text-muted)">${(weekTotal/1000).toFixed(1)}k total</span></div>
      <div class="llm-chart-container">${days.map(x=>`<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:.375rem"><div style="font-size:.75rem;font-weight:600;color:var(--text-secondary)">${(x.tokens/1000).toFixed(0)}k</div><div class="llm-chart-bar" style="height:${Math.max((x.tokens/maxT)*100,4)}%"></div><div style="font-size:.7rem;color:var(--text-muted)">${x.day}</div></div>`).join('')}</div>
    </div>
    <div class="card">
      <div class="card-header"><span class="card-title">üìù Recent Logs</span></div>
      ${d.logs.length?`<div style="overflow-x:auto"><table class="llm-logs-table"><thead><tr><th>Time</th><th>Model</th><th>In</th><th>Out</th><th>Cost</th></tr></thead><tbody>${d.logs.slice(0,20).map(l=>`<tr><td>${new Date(l.ts).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}</td><td>${esc(l.model)}</td><td>${l.ti.toLocaleString()}</td><td>${l.to.toLocaleString()}</td><td>$${l.cost.toFixed(4)}</td></tr>`).join('')}</tbody></table></div>`:`<div style="text-align:center;padding:2rem;color:var(--text-muted)">No usage logs yet</div>`}
    </div>
    <div style="display:flex;gap:.75rem;margin-top:1.5rem;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="resetLLMUsage()">üóëÔ∏è Reset Monthly</button>
      <button class="btn" style="background:rgba(255,255,255,.05);border:1px solid var(--border-subtle);color:var(--text-secondary)" onclick="exportLLMData()">üì§ Export</button>
    </div>
  `;
}

function resetLLMUsage(){if(!confirm('Reset all monthly usage?'))return;S.set('llm_data',{spend:0,logs:[],daily:{},model:{}});renderActiveTab();toast('Usage reset');logAct('üóëÔ∏è','system','Reset LLM usage')}
function exportLLMData(){const d=getLLMData();const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='llm-usage-'+todayStr()+'.json';a.click();toast('Exported')}

// ============================================
// BRAIN TAB - VIEW-ONLY DASHBOARD
// ============================================
let brainConnected = false;
let brainLastPing = null;

function renderBrainTab(el) {
  const apiUrl = S.get('brain_url','');
  const apiKey = S.get('brain_key','');
  
  // Get stats from localStorage
  const sessions = S.get('brain_sessions', 0);
  const commands = S.get('brain_commands', 0);
  const lastActivity = S.get('brain_last_activity', null);
  const brainActivityLog = S.get('brain_activity_log', []);
  
  // Status indicator
  const statusColor = brainConnected ? 'var(--success)' : 'var(--text-muted)';
  const statusText = brainConnected ? 'Online' : 'Offline';
  const pingText = brainLastPing ? timeAgo(brainLastPing) : 'Never';
  
  el.innerHTML = `
    <div class="welcome-bar"><h1 class="welcome-title">üß† Brain</h1><p class="welcome-subtitle">Agent status dashboard ‚Äî view only</p></div>
    <div class="brain-container">
      <div style="display:flex;flex-direction:column;gap:1.25rem">
        <!-- Connection Status Card -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem">
            <div><h3 style="font-size:.95rem;font-weight:600">üîó Agent Status</h3><p style="font-size:.8rem;color:var(--text-muted)">OpenClaw Gateway Connection</p></div>
            <div style="display:flex;align-items:center;gap:.5rem">
              <div class="brain-status-indicator ${brainConnected?'online':'offline'}"></div>
              <span style="font-size:.85rem;color:${statusColor};font-weight:500">${statusText}</span>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:.75rem">
            <div style="background:rgba(255,255,255,.03);padding:.75rem;border-radius:10px">
              <div style="font-size:.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.04em">Last Ping</div>
              <div style="font-size:1.1rem;font-weight:600;color:var(--text-secondary)">${pingText}</div>
            </div>
            <div style="background:rgba(255,255,255,.03);padding:.75rem;border-radius:10px">
              <div style="font-size:.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.04em">Session Count</div>
              <div style="font-size:1.1rem;font-weight:600;color:var(--text-secondary)">${sessions}</div>
            </div>
          </div>
          <div style="display:flex;gap:.5rem">
            <button class="btn btn-primary" style="flex:1" onclick="testBrainConnection()">üîÑ Test Connection</button>
            <button class="btn" style="flex:1;background:rgba(255,255,255,.08);color:var(--text-secondary)" onclick="saveBrainConfig()">üíæ Save Config</button>
          </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="card">
          <div class="card-title" style="margin-bottom:.75rem">üìä Quick Stats</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem">
            <div style="text-align:center;padding:.75rem;background:rgba(255,255,255,.03);border-radius:10px">
              <div style="font-size:1.5rem;font-weight:700;color:var(--accent)">${sessions}</div>
              <div style="font-size:.75rem;color:var(--text-muted)">Sessions</div>
            </div>
            <div style="text-align:center;padding:.75rem;background:rgba(255,255,255,.03);border-radius:10px">
              <div style="font-size:1.5rem;font-weight:700;color:var(--info)">${commands}</div>
              <div style="font-size:.75rem;color:var(--text-muted)">Commands</div>
            </div>
            <div style="text-align:center;padding:.75rem;background:rgba(255,255,255,.03);border-radius:10px">
              <div style="font-size:1.5rem;font-weight:700;color:var(--success)">~${Math.floor(sessions * 12)}</div>
              <div style="font-size:.75rem;color:var(--text-muted)">Est. Memory (MB)</div>
            </div>
          </div>
          ${lastActivity ? `<div style="margin-top:.75rem;padding:.5rem;background:rgba(139,92,246,.08);border-radius:8px;font-size:.8rem;color:var(--text-secondary)">üìÖ Last activity: ${new Date(lastActivity).toLocaleString()}</div>` : ''}
        </div>
        
        <!-- Activity Log (Read-Only) -->
        <div class="card" style="max-height:300px;overflow-y:auto">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
            <div class="card-title">üì° Recent Activity</div>
            <span style="font-size:.75rem;color:var(--text-muted)">${brainActivityLog.length} events</span>
          </div>
          <div id="brainActivityLog">
            ${brainActivityLog.length > 0 ? brainActivityLog.slice(0, 20).map(a => `
              <div class="brain-activity-item">
                <span style="color:var(--text-muted);font-size:.75rem;min-width:50px">${new Date(a.time).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}</span>
                <span>${a.icon}</span>
                <span style="color:var(--text-secondary);flex:1">${esc(a.msg)}</span>
              </div>
            `).join('') : '<div style="padding:1rem;color:var(--text-muted);text-align:center">No activity recorded yet</div>'}
          </div>
        </div>
        
        <!-- API Configuration -->
        <div class="card">
          <div class="card-title" style="margin-bottom:.75rem">‚öôÔ∏è API Configuration</div>
          <div style="margin-bottom:.5rem">
            <label class="modal-label">API URL</label>
            <input class="modal-input" id="brainUrl" placeholder="https://api.yourdomain.com" value="${esc(apiUrl)}" style="margin-bottom:.375rem">
          </div>
          <div>
            <label class="modal-label">API Key</label>
            <input type="password" class="modal-input" id="brainKey" placeholder="sk-..." value="${esc(apiKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '')}">
          </div>
        </div>
      </div>
      
      <div style="display:flex;flex-direction:column;gap:1.25rem">
        <!-- File Browser (Static) -->
        <div class="card" style="max-height:400px;overflow-y:auto">
          <div class="card-title" style="margin-bottom:.5rem">üìÅ File Browser</div>
          <ul style="list-style:none;font-size:.85rem;font-family:'Inter',monospace">
            <li class="brain-file-item" style="font-weight:600">üìÅ workspace/</li>
            <li class="brain-file-item" style="margin-left:1rem">üìù memory/2025-02-20.md</li>
            <li class="brain-file-item" style="margin-left:1rem">üìù memory/2025-02-19.md</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è AGENTS.md</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è USER.md</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è TOOLS.md</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è MEMORY.md</li>
            <li class="brain-file-item" style="font-weight:600">üìÅ .openclaw/</li>
            <li class="brain-file-item" style="margin-left:1rem">üóÑÔ∏è memory.db</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è gateway.yaml</li>
            <li class="brain-file-item" style="margin-left:1rem">üîê secrets.yaml</li>
            <li class="brain-file-item" style="font-weight:600">üìÅ skills/</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è gog/SKILL.md</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è web/SKILL.md</li>
            <li class="brain-file-item" style="margin-left:1rem">‚öôÔ∏è search/SKILL.md</li>
            <li class="brain-file-item">üìù README.md</li>
            <li class="brain-file-item">‚öôÔ∏è index.html</li>
          </ul>
        </div>
        
        <!-- Quick Actions (with confirmation) -->
        <div class="card">
          <h3 style="font-size:.85rem;font-weight:600;margin-bottom:.5rem">‚ö° Quick Actions</h3>
          <div style="display:flex;flex-direction:column;gap:.375rem">
            <button class="btn btn-ghost btn-sm" onclick="brainQuickAction('üìä View Status')">üìä View Status</button>
            <button class="btn btn-ghost btn-sm" onclick="brainQuickAction('üí¨ List Sessions')">üí¨ List Sessions</button>
            <button class="btn btn-ghost btn-sm" onclick="brainQuickAction('üõ†Ô∏è Reload Skills')">üõ†Ô∏è Reload Skills</button>
            <button class="btn btn-ghost btn-sm" onclick="brainQuickAction('üíæ Create Backup')">üíæ Create Backup</button>
            <button class="btn btn-ghost btn-sm" onclick="brainQuickAction('üîÑ Check Updates')">üîÑ Check Updates</button>
          </div>
        </div>
        
        <!-- Help Info -->
        <div class="card" style="background:rgba(139,92,246,.08);border-color:rgba(139,92,246,.2)">
          <h3 style="font-size:.85rem;font-weight:600;margin-bottom:.5rem;color:var(--accent)">‚ÑπÔ∏è Dashboard Mode</h3>
          <p style="font-size:.8rem;color:var(--text-secondary);line-height:1.5">This is a read-only view of your agent status. To send commands, use your OpenClaw client directly or configure the API endpoint above.</p>
        </div>
      </div>
    </div>
  `;
}

function saveBrainConfig(){
  const urlInput = document.getElementById('brainUrl')?.value || '';
  const keyInput = document.getElementById('brainKey')?.value || '';
  if(urlInput) S.set('brain_url', urlInput);
  if(keyInput && !keyInput.includes('‚Ä¢')) S.set('brain_key', keyInput);
  toast('Configuration saved');
  logAct('‚öôÔ∏è','system','Brain API configuration updated');
}

async function testBrainConnection(){
  const url = document.getElementById('brainUrl')?.value || S.get('brain_url','');
  if(!url){
    toast('Enter API URL first','error');
    return;
  }
  
  // Simulate connection test (no hardcoded localhost)
  toast('Testing connection...');
  
  try {
    // Only attempt fetch if URL is configured and not localhost
    if(url.includes('localhost') || url.includes('127.0.0.1')){
      throw new Error('Localhost connections disabled in production');
    }
    
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 5000);
    
    const r = await fetch(url + '/status', { 
      method: 'GET',
      signal: controller.signal
    });
    clearTimeout(timeout);
    
    if(r.ok){
      brainConnected = true;
      brainLastPing = new Date().toISOString();
      S.set('brain_last_ping', brainLastPing);
      toast('Connected successfully!');
      addBrainLog('‚úÖ','Connection test successful');
    } else {
      throw new Error('Status ' + r.status);
    }
  } catch(e){
    brainConnected = false;
    toast('Connection failed: ' + e.message,'error');
    addBrainLog('‚ùå','Connection failed: ' + e.message);
  }
  renderActiveTab();
}

function addBrainLog(icon, text){
  const log = S.get('brain_activity_log', []);
  log.unshift({
    icon: icon,
    msg: text,
    time: new Date().toISOString()
  });
  if(log.length > 50) log.pop();
  S.set('brain_activity_log', log);
  renderActiveTab();
}

function brainQuickAction(action){
  // Show confirmation modal instead of executing
  openModal(`
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Confirm Action</h3>
      <button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button>
    </div>
    <p style="color:var(--text-secondary);margin-bottom:1rem">You are about to request: <strong>${esc(action)}</strong></p>
    <p style="color:var(--text-muted);font-size:.85rem;margin-bottom:1rem">This action requires confirmation and will be sent to your OpenClaw agent.</p>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="confirmBrainAction('${esc(action)}')">Confirm</button>
    </div>
  `);
}

function confirmBrainAction(action){
  closeModal();
  addBrainLog('‚ö°', action + ' requested');
  setTimeout(() => {
    addBrainLog('‚úÖ', action + ' acknowledged');
    toast(action + ' acknowledged');
  }, 800);
  logAct('üß†','system','Brain action: ' + action);
}

// ============================================
// TIMELINE
// ============================================
function renderTimelineTab(el) {
  const phases = getTimeline();
  el.innerHTML = `
    <div class="welcome-bar"><h1 class="welcome-title">üåô The Journey</h1><p class="welcome-subtitle">Where you've been, where you're going</p></div>
    <div class="timeline">${phases.map(p => `
      <div class="timeline-phase ${p.status}">
        <div class="timeline-phase-title">‚ú¶ ${esc(p.title)} ${p.status==='current'?'<span style="font-size:.75rem;background:rgba(139,92,246,.2);color:var(--accent);padding:.15rem .5rem;border-radius:6px">NOW</span>':''}</div>
        <div class="timeline-phase-date">${esc(p.date)}</div>
        <div class="timeline-phase-desc">${esc(p.desc)}</div>
        <ul class="timeline-milestones">${p.milestones.map(m => `
          <li class="timeline-milestone">
            <div class="milestone-check ${m.done?'done':''}" onclick="toggleMilestone(${p.id},${m.id})"></div>
            <span style="${m.done?'text-decoration:line-through;color:var(--text-muted)':''}">${esc(m.text)}</span>
          </li>
        `).join('')}</ul>
        <button class="btn btn-ghost btn-sm" style="margin-top:.5rem" onclick="addMilestone(${p.id})">+ Add milestone</button>
      </div>
    `).join('')}</div>
    <button class="btn btn-primary" style="margin-top:1.5rem" onclick="addTimelinePhase()" aria-label="Add phase">+ Add Phase</button>
  `;
}

function toggleMilestone(pid, mid) {
  const t=getTimeline(); const p=t.find(x=>x.id===pid); const m=p?.milestones.find(x=>x.id===mid);
  if(m){m.done=!m.done;saveTimeline(t);logAct(m.done?'‚úÖ':'‚¨ú','task',`${m.done?'Completed':'Unchecked'} milestone: ${m.text}`);renderActiveTab()}
}
function addMilestone(pid) {
  const text=prompt('Milestone:');if(!text)return;
  const t=getTimeline();const p=t.find(x=>x.id===pid);
  p.milestones.push({id:Date.now(),text,done:false});saveTimeline(t);renderActiveTab();toast('Milestone added');
}
function addTimelinePhase() {
  openModal(`
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">Add Phase</h3><button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button></div>
    <input class="modal-input" id="phaseTitle" placeholder="Phase title">
    <input class="modal-input" id="phaseDate" placeholder="Date range (e.g. 2026+)">
    <textarea class="modal-input textarea" id="phaseDesc" placeholder="Description"></textarea>
    <label class="modal-label">Status</label>
    <select class="modal-input modal-select" id="phaseStatus"><option value="future">Future</option><option value="current">Current</option><option value="completed">Completed</option></select>
    <div class="modal-actions"><button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button><button class="modal-btn modal-btn-primary" onclick="savePhase()">Add</button></div>
  `);
}
function savePhase(){
  const title=document.getElementById('phaseTitle').value.trim();if(!title)return toast('Enter a title','error');
  const t=getTimeline();t.push({id:Date.now(),title,date:document.getElementById('phaseDate').value,desc:document.getElementById('phaseDesc').value,status:document.getElementById('phaseStatus').value,milestones:[]});
  saveTimeline(t);closeModal();renderActiveTab();toast('Phase added');logAct('üåô','system','Added journey phase: '+title);
}

// ============================================
// NOTES
// ============================================
let notesSaveTimer = null;
function renderNotesTab(el) {
  const notes = S.get('notes','');
  const lastSaved = S.get('notes_saved', null);
  const words = notes.trim() ? notes.trim().split(/\s+/).length : 0;

  el.innerHTML = `
    <div class="welcome-bar"><h1 class="welcome-title">üìù Field Notes</h1><p class="welcome-subtitle">Unstructured thoughts, observations, fragments</p></div>
    <div class="card notes-editor">
      <textarea class="notes-textarea" id="notesArea" placeholder="What's on your mind?">${esc(notes)}</textarea>
      <div class="notes-status">
        <span id="notesWordCount">${words} words ¬∑ ${notes.length} chars</span>
        <span id="notesSaveStatus">${lastSaved ? 'Saved '+timeAgo(lastSaved) : 'Not yet saved'}</span>
      </div>
    </div>
  `;

  const ta = document.getElementById('notesArea');
  ta.addEventListener('input', () => {
    const val = ta.value;
    S.set('notes', val);
    const w = val.trim() ? val.trim().split(/\s+/).length : 0;
    document.getElementById('notesWordCount').textContent = `${w} words ¬∑ ${val.length} chars`;
    document.getElementById('notesSaveStatus').textContent = 'Saving...';
    clearTimeout(notesSaveTimer);
    notesSaveTimer = setTimeout(() => {
      S.set('notes_saved', new Date().toISOString());
      document.getElementById('notesSaveStatus').textContent = 'Saved just now';
    }, 500);
  });
}

// ============================================
// INIT
// ============================================
async function boot() {
  initNav();
  initSearch();
  initCommandPalette();
  
  // Generate Morning Report if it's after 5 AM
  const hour = new Date().getHours();
  if (hour >= 5) {
    console.log('[Boot] Generating Morning Report...');
    try {
      await generateMorningReport();
      console.log('[Boot] Morning Report generated');
    } catch (error) {
      console.error('[Boot] Morning Report failed:', error);
    }
  }
  
  renderActiveTab();
  logAct('‚ú¶','system','Pleiades OS awakened');
  
  // Show storage usage in MB
  console.log(`Storage used: ${S.getSizeMB()} MB`);
  
  // Check if calendar sync is enabled and auto-sync
  const syncState = GCal.getSyncState();
  if (syncState.syncEnabled && syncState.autoSync) {
    const lastSync = syncState.lastSync ? new Date(syncState.lastSync) : null;
    const shouldSync = !lastSync || (Date.now() - lastSync.getTime() > 30 * 60 * 1000); // 30 min
    if (shouldSync) {
      console.log('[Boot] Auto-syncing with Google Calendar...');
      syncMeetingsWithCalendar().catch(e => console.error('[Boot] Auto-sync failed:', e));
    }
  }

  // Server status - configurable, no hardcoded localhost
  const serverUrl = S.get('server_url', '');
  if(serverUrl && !serverUrl.includes('localhost') && !serverUrl.includes('127.0.0.1')){
    fetch(serverUrl + '/status').then(r=>r.json()).then(d=>{
      if(d.health==='online'){
        const si=document.getElementById('serverStatus');
        si.classList.remove('offline');si.classList.add('online');
        document.getElementById('serverStatusText').textContent='Connected';
      }
    }).catch(()=>{});
  }

  // Hide loader
  setTimeout(()=>{const l=document.getElementById('loader');if(l){l.style.opacity='0';setTimeout(()=>l.remove(),500)}},600);
}

boot();

// PWA: Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('[PWA] ServiceWorker registered with scope:', registration.scope);
        
        // Handle updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New content available, show update notification
              console.log('[PWA] New content available, refreshing...');
              // Optional: Show a toast notification to the user
              if (typeof toast === 'function') {
                toast('Update available! Refresh to see changes.', 'info');
              }
            }
          });
        });
      })
      .catch(error => {
        console.error('[PWA] ServiceWorker registration failed:', error);
      });
    
    // Listen for messages from service worker
    navigator.serviceWorker.addEventListener('message', event => {
      if (event.data?.type === 'SYNC_COMPLETED') {
        console.log('[PWA] Background sync completed');
      }
    });
  });
}

// PWA: Handle beforeinstallprompt for install button
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  // Prevent the mini-infobar from appearing on mobile
  e.preventDefault();
  // Store the event for later use
  deferredPrompt = e;
  console.log('[PWA] Install prompt available');
});

// PWA: Handle app installed
window.addEventListener('appinstalled', () => {
  console.log('[PWA] Pleiades OS was installed');
  deferredPrompt = null;
  if (typeof toast === 'function') {
    toast('Pleiades OS installed! ‚ú®', 'success');
  }
});

// ============================================
// BRAINSYNC - Live Memory File Sync
// ============================================
class BrainSync {
  constructor() {
    this.syncQueue = S.get('brainSync_queue', []);
    this.fileCache = S.get('brainSync_cache', {});
    this.syncInterval = null;
    this.watchers = new Map();
    this.syncStatus = S.get('brainSync_status', {}); // synced/pending/conflict
    this.API_BASE = S.get('brain_url', '');
    this.lastSyncTime = S.get('brainSync_lastSync', null);
    
    // Sync targets - the memory files we care about
    this.syncTargets = [
      'memory/YYYY-MM-DD.md',
      'USER.md',
      'AGENTS.md',
      'MEMORY.md'
    ];
    
    // Start auto-sync
    this.startAutoSync();
  }
  
  // Start auto-sync interval (30 seconds)
  startAutoSync() {
    if (this.syncInterval) clearInterval(this.syncInterval);
    this.syncInterval = setInterval(() => this.processQueue(), 30000);
  }
  
  // Stop auto-sync
  stopAutoSync() {
    if (this.syncInterval) {
      clearInterval(this.syncInterval);
      this.syncInterval = null;
    }
  }
  
  // Generate today's memory filename
  getTodayMemoryFile() {
    const today = new Date().toISOString().split('T')[0];
    return `memory/${today}.md`;
  }
  
  // Get current sync targets with resolved date
  getResolvedTargets() {
    const targets = [...this.syncTargets];
    const dateIdx = targets.indexOf('memory/YYYY-MM-DD.md');
    if (dateIdx !== -1) {
      targets[dateIdx] = this.getTodayMemoryFile();
    }
    return targets;
  }
  
  // Queue a file for sync
  syncFile(path, content) {
    const existingIndex = this.syncQueue.findIndex(item => item.path === path);
    const syncItem = {
      path,
      content,
      timestamp: new Date().toISOString(),
      status: 'pending'
    };
    
    if (existingIndex !== -1) {
      this.syncQueue[existingIndex] = syncItem;
    } else {
      this.syncQueue.push(syncItem);
    }
    
    this.syncStatus[path] = 'pending';
    this.saveQueue();
    this.saveStatus();
    
    logAct('üîÑ', 'system', `Queued ${path} for sync`);
    return syncItem;
  }
  
  // Get file from cache or fetch from server
  async getFile(path) {
    // Check cache first
    if (this.fileCache[path]) {
      return this.fileCache[path];
    }
    
    // Try to fetch from API
    try {
      const content = await this.fetchFile(path);
      this.fileCache[path] = { content, timestamp: new Date().toISOString() };
      this.saveCache();
      return this.fileCache[path];
    } catch (e) {
      console.error(`Failed to fetch ${path}:`, e);
      return null;
    }
  }
  
  // List all tracked files with their sync status
  listFiles() {
    const targets = this.getResolvedTargets();
    return targets.map(path => ({
      path,
      status: this.syncStatus[path] || 'unknown',
      cached: !!this.fileCache[path],
      pending: this.syncQueue.some(q => q.path === path)
    }));
  }
  
  // Watch a file for changes
  watchFile(path, callback) {
    if (!this.watchers.has(path)) {
      this.watchers.set(path, []);
    }
    this.watchers.get(path).push(callback);
    
    // Return unwatch function
    return () => {
      const watchers = this.watchers.get(path);
      if (watchers) {
        const idx = watchers.indexOf(callback);
        if (idx !== -1) watchers.splice(idx, 1);
      }
    };
  }
  
  // Notify watchers of file change
  notifyWatchers(path, content) {
    const watchers = this.watchers.get(path);
    if (watchers) {
      watchers.forEach(cb => {
        try { cb(path, content); } catch (e) { console.error('Watcher error:', e); }
      });
    }
  }
  
  // Process sync queue
  async processQueue() {
    if (this.syncQueue.length === 0) return;
    if (!this.API_BASE) {
      console.log('BrainSync: No API configured, using local-only mode');
      return;
    }
    
    const pending = this.syncQueue.filter(item => item.status === 'pending');
    
    for (const item of pending) {
      try {
        await this.pushToServer(item.path, item.content);
        item.status = 'synced';
        this.syncStatus[item.path] = 'synced';
        this.lastSyncTime = new Date().toISOString();
        S.set('brainSync_lastSync', this.lastSyncTime);
        this.notifyWatchers(item.path, item.content);
        logAct('‚úÖ', 'system', `Synced ${item.path}`);
      } catch (e) {
        item.status = 'error';
        this.syncStatus[item.path] = 'error';
        console.error(`Sync failed for ${item.path}:`, e);
      }
    }
    
    // Remove synced items from queue after a delay
    this.syncQueue = this.syncQueue.filter(item => item.status !== 'synced');
    this.saveQueue();
    this.saveStatus();
    
    // Refresh UI if on brain tab
    if (activeTab === 'brain') {
      renderActiveTab();
    }
  }
  
  // Force immediate sync
  async forceSync() {
    await this.processQueue();
    toast('Sync complete');
  }
  
  // Fetch file from server (mock or real)
  async fetchFile(path) {
    if (!this.API_BASE || this.API_BASE.includes('localhost')) {
      // Mock mode - return cached or generate placeholder
      return this.mockFetchFile(path);
    }
    
    const response = await fetch(`${this.API_BASE}/files/${encodeURIComponent(path)}`);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    return await response.text();
  }
  
  // Push file to server (mock or real)
  async pushToServer(path, content) {
    if (!this.API_BASE || this.API_BASE.includes('localhost')) {
      // Mock mode - just update cache
      this.fileCache[path] = { content, timestamp: new Date().toISOString() };
      this.saveCache();
      return { success: true, mock: true };
    }
    
    const response = await fetch(`${this.API_BASE}/files/${encodeURIComponent(path)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'text/markdown' },
      body: content
    });
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    return await response.json();
  }
  
  // Mock fetch for local development
  mockFetchFile(path) {
    if (this.fileCache[path]) {
      return this.fileCache[path].content;
    }
    // Generate a placeholder based on file type
    const today = new Date().toISOString().split('T')[0];
    if (path.includes('memory/') && path.includes(today)) {
      return `# ${today} - Daily Memory\n\n*Auto-generated placeholder*\n\n## Sessions\n\n## Decisions\n\n## Notes\n`;
    }
    if (path === 'USER.md') return `# USER.md\n\n*User profile placeholder*\n`;
    if (path === 'AGENTS.md') return `# AGENTS.md\n\n*Agent definitions placeholder*\n`;
    if (path === 'MEMORY.md') return `# MEMORY.md\n\n*System memory placeholder*\n`;
    return `# ${path}\n\n*Placeholder content*\n`;
  }
  
  // Conflict resolution
  resolveConflict(path, choice) {
    // choice: 'local' or 'remote'
    const conflictItem = this.syncQueue.find(item => item.path === path && item.status === 'conflict');
    if (!conflictItem) return;
    
    if (choice === 'local') {
      conflictItem.status = 'pending';
      this.syncStatus[path] = 'pending';
    } else {
      // Remove from queue, will fetch remote on next getFile
      this.syncQueue = this.syncQueue.filter(item => item.path !== path);
      delete this.fileCache[path];
      this.syncStatus[path] = 'synced';
    }
    
    this.saveQueue();
    this.saveStatus();
    renderActiveTab();
    logAct('‚öñÔ∏è', 'system', `Conflict resolved for ${path}: ${choice}`);
  }
  
  // Check for conflicts (simulated)
  async checkConflicts() {
    // In a real implementation, this would compare local/remote timestamps
    // For now, we'll simulate occasional conflicts for testing
    return [];
  }
  
  // Persistence helpers
  saveQueue() { S.set('brainSync_queue', this.syncQueue); }
  saveCache() { S.set('brainSync_cache', this.fileCache); }
  saveStatus() { S.set('brainSync_status', this.syncStatus); }
  
  // Get stats for display
  getStats() {
    return {
      queueSize: this.syncQueue.length,
      pending: this.syncQueue.filter(i => i.status === 'pending').length,
      conflicts: this.syncQueue.filter(i => i.status === 'conflict').length,
      cached: Object.keys(this.fileCache).length,
      lastSync: this.lastSyncTime
    };
  }
}

// Global BrainSync instance
const brainSync = new BrainSync();

// ============================================
// SORAYA BRIDGE - Sub-Agent Management
// ============================================
class SorayaBridge {
  constructor() {
    this.agents = S.get('soraya_agents', []);
    this.jobs = S.get('soraya_jobs', []);
    this.API_BASE = S.get('brain_url', '');
    this.agentTypes = {
      scribe: { name: 'The Scribe', icon: '‚úçÔ∏è', role: 'Voice & Story', description: 'Crafts narratives, cover letters, grant writing' },
      mechanic: { name: 'The Mechanic', icon: 'üîß', role: 'Systems & Grants', description: 'Builds grant structures, budgets, logic models' },
      analyst: { name: 'The Cartographer', icon: 'üó∫Ô∏è', role: 'Patterns & Maps', description: 'Finds patterns in data, survey analysis' },
      researcher: { name: 'The Archivist', icon: 'üìö', role: 'Research & Intel', description: 'Deep research, synthesis, fact-finding' }
    };
    this.jobCounter = S.get('soraya_jobCounter', 1);
  }
  
  // Spawn a new sub-agent task
  async spawnAgent(task, agentType, context = {}) {
    if (!this.agentTypes[agentType]) {
      throw new Error(`Unknown agent type: ${agentType}`);
    }
    
    const typeInfo = this.agentTypes[agentType];
    const jobId = `job_${Date.now()}_${this.jobCounter++}`;
    S.set('soraya_jobCounter', this.jobCounter);
    
    const job = {
      id: jobId,
      task: task.slice(0, 200), // Truncate for storage
      agentType,
      agentName: typeInfo.name,
      agentIcon: typeInfo.icon,
      status: 'running', // running/completed/failed
      created: new Date().toISOString(),
      completed: null,
      result: null,
      context,
      logs: [{ time: new Date().toISOString(), msg: `Spawned ${typeInfo.name}` }]
    };
    
    this.jobs.unshift(job);
    this.saveJobs();
    
    logAct(typeInfo.icon, 'system', `${typeInfo.name} spawned: ${task.slice(0, 50)}...`);
    
    // Try to send to API if configured
    if (this.API_BASE && !this.API_BASE.includes('localhost')) {
      try {
        const response = await fetch(`${this.API_BASE}/agents/spawn`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jobId, task, agentType, context })
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
      } catch (e) {
        console.log('SorayaBridge: API spawn failed, using local mode');
        job.logs.push({ time: new Date().toISOString(), msg: 'Running in local mode' });
      }
    } else {
      job.logs.push({ time: new Date().toISOString(), msg: 'Running in local mode' });
    }
    
    // Simulate job progress
    this.simulateJobProgress(job);
    
    // Update brain activity log
    addBrainLog('ü§ñ', `${typeInfo.name} started: ${task.slice(0, 40)}...`);
    
    return job;
  }
  
  // Simulate job progress (for demo/development)
  simulateJobProgress(job) {
    const steps = [
      { delay: 2000, msg: 'Analyzing task requirements...' },
      { delay: 5000, msg: 'Gathering context...' },
      { delay: 8000, msg: 'Processing...' },
      { delay: 12000, msg: 'Finalizing output...' }
    ];
    
    steps.forEach(step => {
      setTimeout(() => {
        const j = this.jobs.find(x => x.id === job.id);
        if (j && j.status === 'running') {
          j.logs.push({ time: new Date().toISOString(), msg: step.msg });
          this.saveJobs();
          if (activeTab === 'brain') renderActiveTab();
        }
      }, step.delay);
    });
    
    // Complete the job after 15 seconds
    setTimeout(() => {
      const j = this.jobs.find(x => x.id === job.id);
      if (j && j.status === 'running') {
        j.status = 'completed';
        j.completed = new Date().toISOString();
        j.result = `Task completed by ${j.agentName}. Output saved to memory.`;
        j.logs.push({ time: new Date().toISOString(), msg: 'Task completed successfully' });
        this.saveJobs();
        addBrainLog('‚úÖ', `${j.agentName} completed job`);
        if (activeTab === 'brain') renderActiveTab();
        
        // Sync to memory file
        brainSync.syncFile(brainSync.getTodayMemoryFile(), 
          `## Agent Activity\n\n**${j.agentName}** (${j.agentType})\n- Task: ${j.task}\n- Status: Completed\n- Time: ${new Date().toISOString()}\n\n`);
      }
    }, 15000);
  }
  
  // List all active agents/jobs
  listActiveAgents() {
    return this.jobs.filter(j => j.status === 'running');
  }
  
  // Get all jobs (active and completed)
  listAllJobs() {
    return this.jobs;
  }
  
  // Get specific job status
  getAgentStatus(jobId) {
    return this.jobs.find(j => j.id === jobId);
  }
  
  // Kill/cancel a running job
  async killAgent(jobId) {
    const job = this.jobs.find(j => j.id === jobId);
    if (!job) return false;
    if (job.status !== 'running') return false;
    
    job.status = 'failed';
    job.completed = new Date().toISOString();
    job.result = 'Cancelled by user';
    job.logs.push({ time: new Date().toISOString(), msg: 'Job cancelled by user' });
    this.saveJobs();
    
    // Try to notify API
    if (this.API_BASE && !this.API_BASE.includes('localhost')) {
      try {
        await fetch(`${this.API_BASE}/agents/kill/${jobId}`, { method: 'POST' });
      } catch (e) {
        console.log('Kill notification failed (local mode)');
      }
    }
    
    logAct('üõë', 'system', `Killed job ${jobId}`);
    addBrainLog('üõë', `${job.agentName} job cancelled`);
    return true;
  }
  
  // Get available agent types
  getAgentTypes() {
    return Object.entries(this.agentTypes).map(([key, info]) => ({ key, ...info }));
  }
  
  // Handle decision approval - spawn appropriate agent
  async handleDecisionApproval(decision) {
    let agentType = 'analyst'; // default
    
    // Determine agent type based on decision content
    const question = decision.question.toLowerCase();
    if (question.includes('write') || question.includes('draft') || question.includes('letter') || question.includes('grant') || question.includes('narrative')) {
      agentType = 'scribe';
    } else if (question.includes('budget') || question.includes('structure') || question.includes('system') || question.includes('grant')) {
      agentType = 'mechanic';
    } else if (question.includes('research') || question.includes('find') || question.includes('look up') || question.includes('analyze data')) {
      agentType = 'researcher';
    } else if (question.includes('analyze') || question.includes('pattern') || question.includes('survey') || question.includes('data')) {
      agentType = 'analyst';
    }
    
    const task = `Execute decision: ${decision.question}. Summary: ${decision.summary}`;
    return await this.spawnAgent(task, agentType, { decisionId: decision.id });
  }
  
  // Persistence
  saveJobs() { S.set('soraya_jobs', this.jobs.slice(0, 50)); } // Keep last 50 jobs
  
  // Cleanup old completed jobs
  cleanupOldJobs(days = 7) {
    const cutoff = new Date(Date.now() - days * 86400000).toISOString();
    this.jobs = this.jobs.filter(j => j.status === 'running' || j.created > cutoff);
    this.saveJobs();
  }
  
  // Get stats
  getStats() {
    return {
      running: this.jobs.filter(j => j.status === 'running').length,
      completed: this.jobs.filter(j => j.status === 'completed').length,
      failed: this.jobs.filter(j => j.status === 'failed').length,
      total: this.jobs.length
    };
  }
}

// Global SorayaBridge instance
const sorayaBridge = new SorayaBridge();

// ============================================
// UPDATED BRAIN TAB - Functional Sync Dashboard
// ============================================
function renderBrainTab(el) {
  const apiUrl = S.get('brain_url', '');
  const apiKey = S.get('brain_key', '');
  
  // Get BrainSync stats
  const syncStats = brainSync.getStats();
  const files = brainSync.listFiles();
  const syncTargets = brainSync.getResolvedTargets();
  
  // Get SorayaBridge stats
  const agentStats = sorayaBridge.getStats();
  const activeJobs = sorayaBridge.listActiveAgents();
  const recentJobs = sorayaBridge.listAllJobs().slice(0, 10);
  
  // Get decisions for approval
  const decisions = getDecisions().slice(0, 5);
  
  // Status indicator
  const statusColor = brainConnected ? 'var(--success)' : 'var(--text-muted)';
  const statusText = brainConnected ? 'Online' : 'Offline';
  const pingText = brainLastPing ? timeAgo(brainLastPing) : 'Never';
  
  el.innerHTML = `
    <div class="welcome-bar">
      <h1 class="welcome-title">üß† Brain</h1>
      <p class="welcome-subtitle">Live memory sync ¬∑ Agent orchestration ¬∑ Decision flow</p>
    </div>
    
    <div class="brain-container">
      <div style="display:flex;flex-direction:column;gap:1.25rem">
        <!-- Sync Status Card -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem">
            <div>
              <h3 style="font-size:.95rem;font-weight:600">üîÑ Brain Sync</h3>
              <p style="font-size:.8rem;color:var(--text-muted)">Memory file synchronization</p>
            </div>
            <div style="display:flex;align-items:center;gap:.5rem">
              <div class="brain-status-indicator ${syncStats.pending > 0 ? 'connecting' : (brainConnected ? 'online' : 'offline')}"></div>
              <span style="font-size:.85rem;color:${statusColor};font-weight:500">
                ${syncStats.pending > 0 ? `${syncStats.pending} pending` : statusText}
              </span>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem;margin-bottom:.75rem">
            <div style="background:rgba(255,255,255,.03);padding:.75rem;border-radius:10px;text-align:center">
              <div style="font-size:1.25rem;font-weight:700;color:var(--accent)">${syncStats.queueSize}</div>
              <div style="font-size:.7rem;color:var(--text-muted)">Queue</div>
            </div>
            <div style="background:rgba(255,255,255,.03);padding:.75rem;border-radius:10px;text-align:center">
              <div style="font-size:1.25rem;font-weight:700;color:var(--warning)">${syncStats.pending}</div>
              <div style="font-size:.7rem;color:var(--text-muted)">Pending</div>
            </div>
            <div style="background:rgba(255,255,255,.03);padding:.75rem;border-radius:10px;text-align:center">
              <div style="font-size:1.25rem;font-weight:700;color:var(--success)">${syncStats.cached}</div>
              <div style="font-size:.7rem;color:var(--text-muted)">Cached</div>
            </div>
            <div style="background:rgba(255,255,255,.03);padding:.75rem;border-radius:10px;text-align:center">
              <div style="font-size:1.25rem;font-weight:700;color:var(--info)">${syncStats.conflicts}</div>
              <div style="font-size:.7rem;color:var(--text-muted)">Conflicts</div>
            </div>
          </div>
          
          <div style="display:flex;gap:.5rem;margin-bottom:.75rem">
            <button class="btn btn-primary" style="flex:1" onclick="brainSync.forceSync()">üîÑ Force Sync</button>
            <button class="btn" style="flex:1;background:rgba(255,255,255,.08);color:var(--text-secondary)" onclick="brainSync.processQueue()">‚ö° Process Queue</button>
          </div>
          
          <div style="font-size:.75rem;color:var(--text-muted);text-align:center">
            Last sync: ${syncStats.lastSync ? timeAgo(syncStats.lastSync) : 'Never'} ¬∑ Auto-sync every 30s
          </div>
        </div>
        
        <!-- File Browser with Sync States -->
        <div class="card" style="max-height:300px;overflow-y:auto">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
            <div class="card-title">üìÅ Sync Targets</div>
            <button class="btn btn-sm btn-primary" onclick="addSyncTarget()">+ Add</button>
          </div>
          <div id="brainFileList">
            ${files.map(f => `
              <div class="brain-file-item" style="display:flex;justify-content:space-between;align-items:center;padding:.5rem;background:rgba(255,255,255,.03);border-radius:6px;margin-bottom:.25rem">
                <span style="display:flex;align-items:center;gap:.5rem">
                  <span>${f.path.endsWith('.md') ? 'üìù' : 'üìÑ'}</span>
                  <span style="font-family:'Inter',monospace;font-size:.8rem">${f.path}</span>
                </span>
                <span style="display:flex;align-items:center;gap:.5rem">
                  <span style="font-size:.7rem;padding:.15rem .4rem;border-radius:4px;background:${getSyncStatusColor(f.status)};color:#fff">${f.status}</span>
                  ${f.pending ? '<span style="font-size:.7rem;color:var(--warning)">‚è≥</span>' : ''}
                  <button class="btn-icon" onclick="viewFile('${f.path}')" title="View">üëÅÔ∏è</button>
                  <button class="btn-icon" onclick="syncSingleFile('${f.path}')" title="Sync now">üîÑ</button>
                </span>
              </div>
            `).join('')}
          </div>
        </div>
        
        <!-- Soraya Bridge - Active Agents -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem">
            <div>
              <h3 style="font-size:.95rem;font-weight:600">ü§ñ Soraya Bridge</h3>
              <p style="font-size:.8rem;color:var(--text-muted)">Sub-agent orchestration</p>
            </div>
            <div style="display:flex;align-items:center;gap:.75rem">
              <span style="font-size:.85rem;color:var(--success);font-weight:500">${agentStats.running} running</span>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem;margin-bottom:.75rem">
            <div style="background:rgba(107,144,128,.1);padding:.75rem;border-radius:10px;text-align:center;border:1px solid rgba(107,144,128,.2)">
              <div style="font-size:1.25rem;font-weight:700;color:var(--success)">${agentStats.running}</div>
              <div style="font-size:.7rem;color:var(--text-muted)">Active</div>
            </div>
            <div style="background:rgba(16,185,129,.08);padding:.75rem;border-radius:10px;text-align:center;border:1px solid rgba(16,185,129,.2)">
              <div style="font-size:1.25rem;font-weight:700;color:var(--success)">${agentStats.completed}</div>
              <div style="font-size:.7rem;color:var(--text-muted)">Done</div>
            </div>
            <div style="background:rgba(201,123,123,.1);padding:.75rem;border-radius:10px;text-align:center;border:1px solid rgba(201,123,123,.2)">
              <div style="font-size:1.25rem;font-weight:700;color:var(--danger)">${agentStats.failed}</div>
              <div style="font-size:.7rem;color:var(--text-muted)">Failed</div>
            </div>
            <div style="background:rgba(255,255,255,.03);padding:.75rem;border-radius:10px;text-align:center">
              <div style="font-size:1.25rem;font-weight:700;color:var(--text-secondary)">${agentStats.total}</div>
              <div style="font-size:.7rem;color:var(--text-muted)">Total</div>
            </div>
          </div>
          
          <div style="margin-bottom:.75rem">
            <div class="card-title" style="margin-bottom:.5rem;font-size:.8rem">Active Jobs</div>
            ${activeJobs.length > 0 ? activeJobs.map(job => `
              <div style="display:flex;align-items:center;justify-content:space-between;padding:.5rem;background:rgba(139,92,246,.08);border-radius:8px;margin-bottom:.25rem;border:1px solid rgba(139,92,246,.2)">
                <span style="display:flex;align-items:center;gap:.5rem">
                  <span>${job.agentIcon}</span>
                  <span style="font-size:.85rem;font-weight:500">${job.agentName}</span>
                  <span style="font-size:.75rem;color:var(--text-muted)">${job.task.slice(0, 30)}...</span>
                </span>
                <div style="display:flex;align-items:center;gap:.5rem">
                  <span style="font-size:.7rem;padding:.15rem .4rem;border-radius:4px;background:var(--warning);color:#fff">${job.status}</span>
                  <button class="btn-icon" onclick="killAgentJob('${job.id}')" title="Cancel">‚úï</button>
                </div>
              </div>
            `).join('') : '<div style="color:var(--text-muted);font-size:.85rem;text-align:center;padding:1rem">No active jobs</div>'}
          </div>
          
          <div style="display:flex;gap:.5rem">
            <select id="quickAgentType" class="modal-input modal-select" style="flex:1;margin:0;font-size:.85rem">
              ${sorayaBridge.getAgentTypes().map(t => `<option value="${t.key}">${t.icon} ${t.name} ‚Äî ${t.role}</option>`).join('')}
            </select>
            <button class="btn btn-primary" onclick="quickSpawnAgent()">Spawn</button>
          </div>
        </div>
        
        <!-- API Configuration -->
        <div class="card">
          <div class="card-title" style="margin-bottom:.75rem">‚öôÔ∏è OpenClaw API Configuration</div>
          <div style="margin-bottom:.5rem">
            <label class="modal-label">API URL</label>
            <input class="modal-input" id="brainUrl" placeholder="https://api.yourdomain.com" value="${esc(apiUrl)}" style="margin-bottom:.375rem">
          </div>
          <div style="margin-bottom:.75rem">
            <label class="modal-label">API Key</label>
            <input type="password" class="modal-input" id="brainKey" placeholder="sk-..." value="${esc(apiKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '')}">
          </div>
          <div style="display:flex;gap:.5rem">
            <button class="btn btn-primary" style="flex:1" onclick="saveBrainConfig()">üíæ Save Config</button>
            <button class="btn" style="flex:1;background:rgba(255,255,255,.08);color:var(--text-secondary)" onclick="testBrainConnection()">üîÑ Test</button>
          </div>
        </div>
      </div>
      
      <div style="display:flex;flex-direction:column;gap:1.25rem">
        <!-- Decisions Awaiting Approval -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem">
            <div class="card-title">üìã Decisions Awaiting Agent</div>
            <span style="font-size:.75rem;color:var(--text-muted)">${decisions.length} pending</span>
          </div>
          <div id="brainDecisionList">
            ${decisions.length > 0 ? decisions.map(d => `
              <div class="decision-card" style="background:rgba(139,92,246,.05);border:1px solid rgba(139,92,246,.2);border-radius:8px;padding:.75rem;margin-bottom:.5rem">
                <div class="decision-date">${new Date(d.date).toLocaleDateString()}</div>
                <div class="decision-question">${esc(d.question)}</div>
                <div class="decision-summary" style="font-size:.8rem;color:var(--text-muted);margin-bottom:.5rem">${esc(d.summary)}</div>
                <div style="display:flex;gap:.5rem">
                  <button class="btn btn-sm btn-primary" onclick="approveDecision(${d.id})" style="flex:1">‚úì Approve & Spawn</button>
                  <button class="btn btn-sm" onclick="viewDecision(${d.id})" style="background:rgba(255,255,255,.08);color:var(--text-secondary)">View</button>
                </div>
              </div>
            `).join('') : '<div style="color:var(--text-muted);font-size:.85rem;text-align:center;padding:1rem">No pending decisions</div>'}
          </div>
        </div>
        
        <!-- Recent Jobs -->
        <div class="card" style="max-height:400px;overflow-y:auto">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
            <div class="card-title">üìú Recent Jobs</div>
            <button class="btn btn-sm" onclick="clearCompletedJobs()" style="background:rgba(255,255,255,.08);color:var(--text-secondary)">Clear</button>
          </div>
          <div>
            ${recentJobs.length > 0 ? recentJobs.map(job => `
              <div class="brain-activity-item" style="padding:.5rem;background:rgba(255,255,255,.03);border-radius:6px;margin-bottom:.25rem">
                <span style="font-size:.75rem;color:var(--text-muted)">${new Date(job.created).toLocaleTimeString()}</span>
                <span>${job.agentIcon}</span>
                <span style="color:var(--text-secondary);flex:1;font-size:.85rem">${job.agentName}: ${job.task.slice(0, 30)}...</span>
                <span style="font-size:.7rem;padding:.1rem .3rem;border-radius:4px;background:${job.status === 'completed' ? 'var(--success)' : job.status === 'failed' ? 'var(--danger)' : 'var(--warning)'};color:#fff">${job.status}</span>
              </div>
            `).join('') : '<div style="color:var(--text-muted);font-size:.85rem;text-align:center;padding:1rem">No job history</div>'}
          </div>
        </div>
        
        <!-- Quick Sync Actions -->
        <div class="card">
          <div class="card-title" style="margin-bottom:.75rem">‚ö° Quick Sync Actions</div>
          <div style="display:flex;flex-direction:column;gap:.375rem">
            <button class="btn btn-ghost btn-sm" onclick="syncAllFiles()">üîÑ Sync All Files</button>
            <button class="btn btn-ghost btn-sm" onclick="viewMemoryFile()">üìù View Today's Memory</button>
            <button class="btn btn-ghost btn-sm" onclick="editUserMd()">üë§ Edit USER.md</button>
            <button class="btn btn-ghost btn-sm" onclick="editAgentsMd()">ü§ñ Edit AGENTS.md</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Brain Sync Helper Functions
function getSyncStatusColor(status) {
  const colors = {
    synced: 'var(--success)',
    pending: 'var(--warning)',
    conflict: 'var(--danger)',
    error: 'var(--danger)',
    unknown: 'var(--text-muted)',
    cached: 'var(--info)'
  };
  return colors[status] || colors.unknown;
}

function viewFile(path) {
  brainSync.getFile(path).then(file => {
    if (file) {
      openModal(`
        <div class="modal-header">
          <h3 class="modal-title" id="modalTitle">${esc(path)}</h3>
          <button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button>
        </div>
        <div style="max-height:400px;overflow-y:auto;background:rgba(0,0,0,.2);padding:1rem;border-radius:8px;font-family:'Inter',monospace;font-size:.85rem;white-space:pre-wrap">${esc(file.content || file)}</div>
        <div class="modal-actions">
          <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Close</button>
          <button class="modal-btn modal-btn-primary" onclick="editFile('${esc(path)}')">Edit</button>
        </div>
      `);
    } else {
      toast('File not found', 'error');
    }
  });
}

function syncSingleFile(path) {
  brainSync.getFile(path).then(file => {
    if (file) {
      const content = typeof file === 'object' ? file.content : file;
      brainSync.syncFile(path, content);
      toast(`Queued ${path} for sync`);
      renderActiveTab();
    }
  });
}

function addSyncTarget() {
  openModal(`
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Add Sync Target</h3>
      <button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button>
    </div>
    <input class="modal-input" id="newTargetPath" placeholder="e.g., memory/custom.md" autofocus>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="saveNewTarget()">Add</button>
    </div>
  `);
}

function saveNewTarget() {
  const path = document.getElementById('newTargetPath').value.trim();
  if (!path) return toast('Enter a path', 'error');
  
  if (!brainSync.syncTargets.includes(path)) {
    brainSync.syncTargets.push(path);
    brainSync.syncStatus[path] = 'unknown';
    brainSync.saveStatus();
  }
  closeModal();
  renderActiveTab();
  toast(`Added ${path} to sync targets`);
}

function syncAllFiles() {
  const targets = brainSync.getResolvedTargets();
  targets.forEach(path => {
    brainSync.syncFile(path, `# ${path}\n\nSynced at ${new Date().toISOString()}\n`);
  });
  toast(`Queued ${targets.length} files for sync`);
  renderActiveTab();
}

function viewMemoryFile() {
  viewFile(brainSync.getTodayMemoryFile());
}

function editUserMd() {
  const path = 'USER.md';
  brainSync.getFile(path).then(file => {
    const content = typeof file === 'object' ? file.content : file;
    openEditModal(path, content);
  });
}

function editAgentsMd() {
  const path = 'AGENTS.md';
  brainSync.getFile(path).then(file => {
    const content = typeof file === 'object' ? file.content : file;
    openEditModal(path, content);
  });
}

function openEditModal(path, content) {
  openModal(`
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Edit ${esc(path)}</h3>
      <button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button>
    </div>
    <textarea class="modal-input textarea" id="editFileContent" style="min-height:300px;font-family:'Inter',monospace">${esc(content)}</textarea>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="saveEditedFile('${esc(path)}')">Save & Sync</button>
    </div>
  `);
}

function saveEditedFile(path) {
  const content = document.getElementById('editFileContent').value;
  brainSync.syncFile(path, content);
  closeModal();
  toast('File saved and queued for sync');
  renderActiveTab();
}

// Soraya Bridge Helper Functions
function quickSpawnAgent() {
  const type = document.getElementById('quickAgentType').value;
  openModal(`
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Spawn ${esc(sorayaBridge.agentTypes[type].name)}</h3>
      <button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button>
    </div>
    <textarea class="modal-input textarea" id="spawnTaskInput" placeholder="Describe the task..." autofocus></textarea>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="doSpawnAgent('${type}')">Spawn</button>
    </div>
  `);
}

function doSpawnAgent(type) {
  const task = document.getElementById('spawnTaskInput').value.trim();
  if (!task) return toast('Enter a task description', 'error');
  
  sorayaBridge.spawnAgent(task, type);
  closeModal();
  toast(`Spawned ${sorayaBridge.agentTypes[type].name}`);
  renderActiveTab();
}

function killAgentJob(jobId) {
  if (!confirm('Cancel this job?')) return;
  sorayaBridge.killAgent(jobId);
  toast('Job cancelled');
  renderActiveTab();
}

function clearCompletedJobs() {
  sorayaBridge.cleanupOldJobs(0);
  toast('Cleared completed jobs');
  renderActiveTab();
}

// Decision Approval Integration
function approveDecision(decisionId) {
  const decisions = getDecisions();
  const decision = decisions.find(d => d.id === decisionId);
  if (!decision) return;
  
  // Spawn appropriate agent for this decision
  sorayaBridge.handleDecisionApproval(decision).then(job => {
    toast(`Spawned ${job.agentName} for decision`);
    renderActiveTab();
  });
  
  // Add to brain log
  addBrainLog('‚úÖ', `Decision approved: ${decision.question.slice(0, 40)}...`);
}

function viewDecision(decisionId) {
  const decisions = getDecisions();
  const decision = decisions.find(d => d.id === decisionId);
  if (!decision) return;
  
  openModal(`
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Decision</h3>
      <button class="modal-close" onclick="closeModal()" aria-label="Close modal">√ó</button>
    </div>
    <div style="margin-bottom:1rem">
      <div style="font-size:.75rem;color:var(--text-muted);margin-bottom:.25rem">Question</div>
      <div style="font-weight:600;margin-bottom:.75rem">${esc(decision.question)}</div>
      
      <div style="font-size:.75rem;color:var(--text-muted);margin-bottom:.25rem">Summary</div>
      <div style="color:var(--text-secondary);margin-bottom:.75rem">${esc(decision.summary)}</div>
      
      <div style="font-size:.75rem;color:var(--text-muted);margin-bottom:.25rem">Agents Consulted</div>
      <div style="display:flex;gap:.25rem;flex-wrap:wrap">
        ${decision.agents.map(a => `<span style="background:rgba(139,92,246,.1);color:var(--accent);padding:.15rem .5rem;border-radius:9999px;font-size:.75rem">${esc(a)}</span>`).join('')}
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Close</button>
      <button class="modal-btn modal-btn-primary" onclick="closeModal();setTimeout(()=>approveDecision(${decisionId}),100)">Approve & Spawn</button>
    </div>
  `);
}

// Updated Command Center to include Approve buttons on decisions
function renderCommand(el) {
  const agents = getAgents();
  const decisions = getDecisions();
  
  el.innerHTML = `
    <div class="welcome-bar">
      <h1 class="welcome-title">üåü Command Center</h1>
      <p class="welcome-subtitle">Agent constellation ¬∑ Decision orchestration</p>
    </div>
    
    <div class="agents-grid" role="region" aria-label="Agents">
      ${agents.map(a => `
        <div class="card agent-card ${a.status}" onclick="openAgentPanel('${a.id}')" role="article" tabindex="0" aria-label="${esc(a.name)}">
          <div class="agent-header">
            <div class="agent-avatar">${a.avatar}</div>
            <div>
              <div class="agent-name">${esc(a.name)}</div>
              <div class="agent-role">${esc(a.role)}</div>
              <div class="agent-status ${a.status}">
                <div class="agent-status-dot"></div>
                <span>${a.status}</span>
              </div>
            </div>
          </div>
          <div style="font-size:.85rem;color:var(--text-secondary);line-height:1.5;margin-bottom:.75rem">${esc(a.description)}</div>
          <div class="agent-meta">
            <span class="agent-model">${esc(a.model)}</span>
            <span>Active ${timeAgo(a.lastActive)}</span>
          </div>
        </div>
      `).join('')}
    </div>
    
    <div class="card" style="margin-bottom:1.5rem">
      <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
        <span class="card-title">üìã Recent Decisions <span style="font-size:.75rem;color:var(--text-muted);font-weight:400">(${decisions.length} total)</span></span>
        <button class="btn btn-sm btn-primary" onclick="addDecision()">+ Log Decision</button>
      </div>
      <div id="decisionList">
        ${decisions.slice(0, 5).map(d => `
          <div class="decision-card" style="background:rgba(139,92,246,.05);border:1px solid rgba(139,92,246,.2);border-radius:8px;padding:.75rem;margin-bottom:.5rem">
            <div class="decision-date">${new Date(d.date).toLocaleDateString()}</div>
            <div class="decision-question">${esc(d.question)}</div>
            <div class="decision-summary" style="font-size:.8rem;color:var(--text-muted);margin-bottom:.5rem">${esc(d.summary)}</div>
            <div class="decision-agents">
              ${d.agents.map(a => `<span class="decision-agent-tag">${esc(a)}</span>`).join('')}
            </div>
            <div style="display:flex;gap:.5rem;margin-top:.75rem">
              <button class="btn btn-sm btn-primary" onclick="approveDecision(${d.id})" style="flex:1">‚úì Approve & Spawn</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

// PWA: Lazy loading for tab content - only render active tab initially
// This is handled by the existing renderActiveTab function
// Additional optimization: IntersectionObserver for heavy elements
if ('IntersectionObserver' in window) {
  const lazyElements = document.querySelectorAll('[data-lazy]');
  const lazyObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('lazy-loaded');
        lazyObserver.unobserve(entry.target);
      }
    });
  }, { rootMargin: '50px' });
  
  lazyElements.forEach(el => lazyObserver.observe(el));
}
</script>
<script>
// Initialize Functional Upgrades
if (typeof CommandPalette !== 'undefined' && CommandPalette.init) CommandPalette.init();
if (typeof BrainSync !== 'undefined' && BrainSync.init) BrainSync.init();
if (typeof sorayaBridge !== 'undefined' && sorayaBridge.init) sorayaBridge.init();
if (typeof GCal !== 'undefined' && GCal.init) GCal.init();
console.log('[Pleiades OS] Functional upgrades initialized');
</script>
</body>
</html>
